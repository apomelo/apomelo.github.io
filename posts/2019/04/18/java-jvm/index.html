<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"apomelo.cc","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.12.3","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"A3LWYBODE0","apiKey":"c40595ca0a82310430032a8bc32214a2","indexName":"apomelo","hits":{"per_page":10}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="JVM 简介JVM(Java虚拟机, Java virtual machine), Java虚拟机，一种能够运行Java bytecode的虚拟机，以堆栈结构机器来进行实做。最早由Sun微系统所研发并实现第一个实现版本，是Java平台的一部分，能够运行以Java语言写作的软件程序。 Java虚拟机有自己完善的硬体架构，如处理器、堆栈、寄存器等，还具有相应的指令系统。 Java 虚拟机是整个 Jav">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM">
<meta property="og:url" content="https://apomelo.cc/posts/2019/04/18/java-jvm/index.html">
<meta property="og:site_name" content="Apomelo - 追逐">
<meta property="og:description" content="JVM 简介JVM(Java虚拟机, Java virtual machine), Java虚拟机，一种能够运行Java bytecode的虚拟机，以堆栈结构机器来进行实做。最早由Sun微系统所研发并实现第一个实现版本，是Java平台的一部分，能够运行以Java语言写作的软件程序。 Java虚拟机有自己完善的硬体架构，如处理器、堆栈、寄存器等，还具有相应的指令系统。 Java 虚拟机是整个 Jav">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://apomelo.cc/imgs/java-jvm/jvm%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB.png">
<meta property="og:image" content="https://apomelo.cc/imgs/java-jvm/jvm%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://apomelo.cc/imgs/java-jvm/jvm%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9A%E4%BD%8D.png">
<meta property="og:image" content="https://apomelo.cc/imgs/java-jvm/jvm-class%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://apomelo.cc/imgs/java-jvm/java%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA.png">
<meta property="og:image" content="https://apomelo.cc/imgs/java-jvm/%E6%A0%87%E8%AE%B0%E5%A4%8D%E5%88%B6%E5%9B%9E%E6%94%B6%E5%89%8D%E5%90%8E%E7%8A%B6%E6%80%81.png">
<meta property="og:image" content="https://apomelo.cc/imgs/java-jvm/%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86%E5%9B%9E%E6%94%B6%E5%89%8D%E5%90%8E%E7%8A%B6%E6%80%81.png">
<meta property="og:image" content="https://apomelo.cc/imgs/java-jvm/%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%E5%9B%9E%E6%94%B6%E5%89%8D%E5%90%8E%E7%8A%B6%E6%80%81.png">
<meta property="og:image" content="https://apomelo.cc/imgs/java-jvm/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E5%88%86%E7%B1%BB%E5%9B%BE.png">
<meta property="article:published_time" content="2019-04-17T16:00:00.000Z">
<meta property="article:modified_time" content="2022-07-22T16:00:00.000Z">
<meta property="article:author" content="Apomelo">
<meta property="article:tag" content="jvm">
<meta property="article:tag" content="gc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://apomelo.cc/imgs/java-jvm/jvm%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB.png">


<link rel="canonical" href="https://apomelo.cc/posts/2019/04/18/java-jvm/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://apomelo.cc/posts/2019/04/18/java-jvm/","path":"posts/2019/04/18/java-jvm/","title":"JVM"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>JVM | Apomelo - 追逐</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2KQDESYMZF"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-2KQDESYMZF","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?6c01cfc90b27c8f2cf8c97e38b2f117c"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Apomelo - 追逐</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JVM-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">JVM 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%86%E5%8F%B2%E5%92%8C%E7%89%B9%E6%80%A7"><span class="nav-number">1.1.</span> <span class="nav-text">历史和特性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JVM-%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB%E6%80%BB%E8%A7%88"><span class="nav-number">2.</span> <span class="nav-text">JVM 知识体系总览</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM-%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB"><span class="nav-number">2.1.</span> <span class="nav-text">JVM 知识体系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM-%E7%BB%93%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">JVM 结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9A%E4%BD%8D"><span class="nav-number">2.3.</span> <span class="nav-text">JVM 问题分析与定位</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E8%AF%A6%E8%A7%A3"><span class="nav-number">3.</span> <span class="nav-text">字节码详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%AF%91"><span class="nav-number">3.1.</span> <span class="nav-text">字节码编译</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text">字节码文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.1.</span> <span class="nav-text">反编译字节码文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90"><span class="nav-number">3.2.2.</span> <span class="nav-text">例子</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#java%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">java源文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%94%9F%E6%88%90class%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">生成class文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91class%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">反编译class文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Class%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">3.2.3.</span> <span class="nav-text">Class文件结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF"><span class="nav-number">3.2.4.</span> <span class="nav-text">文件信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="nav-number">3.2.5.</span> <span class="nav-text">常量池</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%AF%B9%E5%BA%94"><span class="nav-number">3.2.5.1.</span> <span class="nav-text">字节码的类型对应</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E8%A1%A8%E9%9B%86%E5%90%88"><span class="nav-number">3.2.6.</span> <span class="nav-text">方法表集合</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%90%8D"><span class="nav-number">3.2.7.</span> <span class="nav-text">类名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90try-catch-finally"><span class="nav-number">3.2.8.</span> <span class="nav-text">分析try-catch-finally</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA%E6%8A%80%E6%9C%AF"><span class="nav-number">3.3.</span> <span class="nav-text">字节码增强技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ASM"><span class="nav-number">3.3.1.</span> <span class="nav-text">ASM</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ASM-API"><span class="nav-number">3.3.1.1.</span> <span class="nav-text">ASM API</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83API"><span class="nav-number">3.3.1.1.1.</span> <span class="nav-text">核心API</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A0%91%E5%BD%A2API"><span class="nav-number">3.3.1.1.2.</span> <span class="nav-text">树形API</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E5%88%A9%E7%94%A8ASM%E5%AE%9E%E7%8E%B0AOP"><span class="nav-number">3.3.1.2.</span> <span class="nav-text">直接利用ASM实现AOP</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Generator%E7%B1%BB"><span class="nav-number">3.3.1.2.1.</span> <span class="nav-text">Generator类</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#MyClassVisitor%E7%B1%BB"><span class="nav-number">3.3.1.2.2.</span> <span class="nav-text">MyClassVisitor类</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ASM%E5%B7%A5%E5%85%B7"><span class="nav-number">3.3.1.3.</span> <span class="nav-text">ASM工具</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Javassist"><span class="nav-number">3.3.2.</span> <span class="nav-text">Javassist</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E7%B1%BB%E7%9A%84%E9%87%8D%E8%BD%BD"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">运行时类的重载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Instrument"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">Instrument</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JVMTI-amp-Agent-amp-Attach-API"><span class="nav-number">3.3.2.3.</span> <span class="nav-text">JVMTI &amp; Agent &amp; Attach API</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#JVMTI"><span class="nav-number">3.3.2.3.1.</span> <span class="nav-text">JVMTI</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Agent"><span class="nav-number">3.3.2.3.2.</span> <span class="nav-text">Agent</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Attach-API"><span class="nav-number">3.3.2.3.3.</span> <span class="nav-text">Attach API</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%B3%A8%E5%85%A5JVM%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.3.2.3.4.</span> <span class="nav-text">注入JVM示例</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">3.3.2.3.5.</span> <span class="nav-text">使用场景</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC-%E8%AF%A6%E8%A7%A3"><span class="nav-number">4.</span> <span class="nav-text">GC 详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GC%E7%AE%80%E4%BB%8B"><span class="nav-number">4.1.</span> <span class="nav-text">GC简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E5%AD%98%E6%B4%BB%E7%9A%84%E7%AE%97%E6%B3%95"><span class="nav-number">4.2.</span> <span class="nav-text">判断对象是否存活的算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.3.</span> <span class="nav-text">引用类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95"><span class="nav-number">4.4.</span> <span class="nav-text">回收算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%87%E8%AE%B0%E2%80%94%E5%A4%8D%E5%88%B6%E7%AE%97%E6%B3%95"><span class="nav-number">4.4.1.</span> <span class="nav-text">标记—复制算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%87%E8%AE%B0%E2%80%94%E6%95%B4%E7%90%86%E7%AE%97%E6%B3%95"><span class="nav-number">4.4.2.</span> <span class="nav-text">标记—整理算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%87%E8%AE%B0%E2%80%94%E6%B8%85%E9%99%A4%E7%AE%97%E6%B3%95"><span class="nav-number">4.4.3.</span> <span class="nav-text">标记—清除算法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8"><span class="nav-number">4.5.</span> <span class="nav-text">垃圾收集器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Serial%E6%94%B6%E9%9B%86%E5%99%A8"><span class="nav-number">4.5.1.</span> <span class="nav-text">Serial收集器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ParNew%E6%94%B6%E9%9B%86%E5%99%A8"><span class="nav-number">4.5.2.</span> <span class="nav-text">ParNew收集器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Parallel-Scavenge%E6%94%B6%E9%9B%86%E5%99%A8"><span class="nav-number">4.5.3.</span> <span class="nav-text">Parallel Scavenge收集器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Serial-Old%E6%94%B6%E9%9B%86%E5%99%A8"><span class="nav-number">4.5.4.</span> <span class="nav-text">Serial Old收集器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Parallel-Old%E6%94%B6%E9%9B%86%E5%99%A8"><span class="nav-number">4.5.5.</span> <span class="nav-text">Parallel Old收集器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CMS%E6%94%B6%E9%9B%86%E5%99%A8%EF%BC%88Concurrent-Mark-Sweep%EF%BC%89"><span class="nav-number">4.5.6.</span> <span class="nav-text">CMS收集器（Concurrent Mark Sweep）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#G1%E6%94%B6%E9%9B%86%E5%99%A8%EF%BC%88Garbage-First%EF%BC%89"><span class="nav-number">4.5.7.</span> <span class="nav-text">G1收集器（Garbage First）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2"><span class="nav-number">4.6.</span> <span class="nav-text">内存泄露</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Apomelo</p>
  <div class="site-description" itemprop="description">我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/apomelo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;apomelo" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:apomeloc@gmail.com" title="E-Mail → mailto:apomeloc@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2019/04/18/java-jvm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="JVM | Apomelo - 追逐">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JVM
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-18 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-18T00:00:00+08:00">2019-04-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-07-23 00:00:00" itemprop="dateModified" datetime="2022-07-23T00:00:00+08:00">2022-07-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
    <span id="/posts/2019/04/18/java-jvm/" class="post-meta-item leancloud_visitors" data-flag-title="JVM" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="JVM-简介"><a href="#JVM-简介" class="headerlink" title="JVM 简介"></a>JVM 简介</h2><p>JVM(Java虚拟机, Java virtual machine), Java虚拟机，一种能够运行Java bytecode的虚拟机，以堆栈结构机器来进行实做。最早由Sun微系统所研发并实现第一个实现版本，是Java平台的一部分，能够运行以Java语言写作的软件程序。 Java虚拟机有自己完善的硬体架构，如处理器、堆栈、寄存器等，还具有相应的指令系统。</p>
<p>Java 虚拟机是整个 Java 平台的基石，是 Java 技术用以实现硬件无关与操作系统无关的关键部分，是 Java 语言生成出极小体积的编译代码的运行平台，是保障用户机器免于恶意代码损害的保护屏障。</p>
<h3 id="历史和特性"><a href="#历史和特性" class="headerlink" title="历史和特性"></a>历史和特性</h3><p>第一个 Java 虚拟机的原型机是由 Sun Microsystems 公司实现的，它被用在一种类似 PDA（Personal Digital Assistant，俗称掌上电脑）的手持设备上仿真实现 Java 虚拟机指令集。时至今日， Oracle 已有许多 Java 虚拟机实现应用于移动设备、桌面电脑、服务器等领域。</p>
<p>Java 虚拟机并不局限于特定的<strong>实现技术、主机硬件和操作系统</strong>， Java 虚拟机也不局限于特定的<strong>代码执行方式</strong>，它不强求使用解释器来执行程序，也可以通过把自己的指令集编译为实际 CPU 的指令来实现，它可以通过微代码（Microcode）来实现，或者甚至直接实现在 CPU 中。</p>
<h2 id="JVM-知识体系总览"><a href="#JVM-知识体系总览" class="headerlink" title="JVM 知识体系总览"></a>JVM 知识体系总览</h2><h3 id="JVM-知识体系"><a href="#JVM-知识体系" class="headerlink" title="JVM 知识体系"></a>JVM 知识体系</h3><p><img src="/imgs/java-jvm/jvm%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB.png" alt="jvm知识体系"></p>
<h3 id="JVM-结构"><a href="#JVM-结构" class="headerlink" title="JVM 结构"></a>JVM 结构</h3><ol>
<li><p>类加载器（Class Loader）：加载字节码文件到内存。</p>
</li>
<li><p>运行时数据区（Runtime Data Area）：JVM 核心内存空间结构模型。</p>
</li>
<li><p>执行引擎（Execution Engine）：对 JVM 指令进行解析，翻译成机器码，解析完成后提交到操作系统中。</p>
</li>
<li><p>本地库接口（Native Interface）：供 Java 调用的融合了不同开发语言的原生库。</p>
</li>
<li><p>本地方法库（Native Libraies）：Java 本地方法的具体实现。</p>
</li>
</ol>
<p><img src="/imgs/java-jvm/jvm%E7%BB%93%E6%9E%84.png" alt="jvm结构"></p>
<h3 id="JVM-问题分析与定位"><a href="#JVM-问题分析与定位" class="headerlink" title="JVM 问题分析与定位"></a>JVM 问题分析与定位</h3><p><img src="/imgs/java-jvm/jvm%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9A%E4%BD%8D.png" alt="jvm问题分析与定位"></p>
<h2 id="字节码详解"><a href="#字节码详解" class="headerlink" title="字节码详解"></a>字节码详解</h2><h3 id="字节码编译"><a href="#字节码编译" class="headerlink" title="字节码编译"></a>字节码编译</h3><p>计算机不能直接运行java代码，必须要先把java代码文件（ .java文件）编译为字节码文件（.class文件），接着运行java虚拟机，再由java虚拟机运行编译后的字节码文件。</p>
<p>Java代码间接翻译成字节码，储存字节码的文件再交由运行于不同平台上的JVM虚拟机去读取执行，从而实现一次编写，到处运行的目的。 </p>
<p>JVM也不再只支持Java，由此衍生出了许多基于JVM的编程语言，如Groovy, Scala, Koltin等等。</p>
<h3 id="字节码文件"><a href="#字节码文件" class="headerlink" title="字节码文件"></a>字节码文件</h3><p>class文件本质上是一个以8位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑的排列在class文件中。jvm根据其特定的规则解析该二进制数据，从而得到相关信息。</p>
<p>Class文件采用一种伪结构来存储数据，它有两种类型：无符号数和表。</p>
<h4 id="反编译字节码文件"><a href="#反编译字节码文件" class="headerlink" title="反编译字节码文件"></a>反编译字节码文件</h4><p>使用到java内置的一个反编译工具javap可以反编译字节码文件, 用法: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap &lt;options&gt; &lt;classes&gt;</span><br></pre></td></tr></table></figure>

<p>其中<code>&lt;options&gt;</code>选项包括:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-<span class="built_in">help</span>  --<span class="built_in">help</span>  -?        输出此用法消息</span><br><span class="line">-version                 版本信息</span><br><span class="line">-v  -verbose             输出附加信息</span><br><span class="line">-l                       输出行号和本地变量表</span><br><span class="line">-public                  仅显示 public 类和成员</span><br><span class="line">-protected               显示 protected/public 类和成员</span><br><span class="line">-package                 显示 package/protected/public 类</span><br><span class="line">                         和成员 (默认)</span><br><span class="line">-p  -private             显示所有类和成员</span><br><span class="line">-c                       对代码进行反汇编</span><br><span class="line">-s                       输出内部类型签名</span><br><span class="line">-sysinfo                 显示正在处理的类的</span><br><span class="line">                         系统信息 (路径, 大小, 日期, MD5 散列)</span><br><span class="line">-constants               显示最终常量</span><br><span class="line">-classpath &lt;path&gt;        指定查找用户类文件的位置</span><br><span class="line">-<span class="built_in">cp</span> &lt;path&gt;               指定查找用户类文件的位置</span><br><span class="line">-bootclasspath &lt;path&gt;    覆盖引导类文件的位置</span><br></pre></td></tr></table></figure>

<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>下面以一个简单的例子来逐步认识字节码。</p>
<h5 id="java源文件"><a href="#java源文件" class="headerlink" title="java源文件"></a>java源文件</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.javap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/7/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> m;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">inc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> m + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> x;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            x = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            x = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            x = <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="生成class文件"><a href="#生成class文件" class="headerlink" title="生成class文件"></a>生成class文件</h5><p>通过以下命令, 可以在当前所在路径下生成一个Main.class文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Main.java</span><br></pre></td></tr></table></figure>

<p>以文本的形式打开生成的class文件，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cafe babe <span class="number">0000</span> <span class="number">0034</span> <span class="number">0025</span> 0a00 <span class="number">0500</span> 1f09</span><br><span class="line"><span class="number">0004</span> <span class="number">0020</span> <span class="number">0700</span> <span class="number">2107</span> <span class="number">0022</span> <span class="number">0700</span> <span class="number">2301</span> <span class="number">0001</span></span><br><span class="line">6d01 <span class="number">0001</span> <span class="number">4901</span> <span class="number">0006</span> 3c69 <span class="number">6e69</span> 743e <span class="number">0100</span></span><br><span class="line">0328 <span class="number">2956</span> <span class="number">0100</span> <span class="number">0443</span> 6f64 <span class="number">6501</span> <span class="number">000f</span> 4c69</span><br><span class="line"><span class="number">6e65</span> <span class="number">4e75</span> 6d62 <span class="number">6572</span> <span class="number">5461</span> 626c <span class="number">6501</span> <span class="number">0012</span></span><br><span class="line">4c6f <span class="number">6361</span> 6c56 <span class="number">6172</span> <span class="number">6961</span> 626c <span class="number">6554</span> <span class="number">6162</span></span><br><span class="line">6c65 <span class="number">0100</span> <span class="number">0474</span> <span class="number">6869</span> <span class="number">7301</span> <span class="number">0011</span> 4c74 <span class="number">6573</span></span><br><span class="line"><span class="number">742f</span> 6a61 <span class="number">7661</span> <span class="number">702f</span> 4d61 696e 3b01 <span class="number">0004</span></span><br><span class="line">6d61 696e <span class="number">0100</span> <span class="number">1628</span> 5b4c 6a61 <span class="number">7661</span> 2f6c</span><br><span class="line">616e <span class="number">672f</span> <span class="number">5374</span> <span class="number">7269</span> <span class="number">6e67</span> 3b29 <span class="number">5601</span> <span class="number">0004</span></span><br><span class="line"><span class="number">6172</span> <span class="number">6773</span> <span class="number">0100</span> 135b 4c6a <span class="number">6176</span> <span class="number">612f</span> 6c61</span><br><span class="line"><span class="number">6e67</span> 2f53 <span class="number">7472</span> 696e 673b <span class="number">0100</span> <span class="number">104d</span> <span class="number">6574</span></span><br><span class="line"><span class="number">686f</span> <span class="number">6450</span> <span class="number">6172</span> <span class="number">616d</span> <span class="number">6574</span> <span class="number">6572</span> <span class="number">7301</span> <span class="number">0003</span></span><br><span class="line">696e <span class="number">6301</span> <span class="number">0003</span> <span class="number">2829</span> <span class="number">4901</span> <span class="number">0003</span> <span class="number">666f</span> 6f01</span><br><span class="line"><span class="number">0001</span> <span class="number">7801</span> <span class="number">0001</span> <span class="number">6501</span> <span class="number">0015</span> 4c6a <span class="number">6176</span> <span class="number">612f</span></span><br><span class="line">6c61 <span class="number">6e67</span> 2f45 <span class="number">7863</span> <span class="number">6570</span> <span class="number">7469</span> 6f6e 3b01</span><br><span class="line"><span class="number">000d</span> <span class="number">5374</span> <span class="number">6163</span> 6b4d <span class="number">6170</span> <span class="number">5461</span> 626c <span class="number">6507</span></span><br><span class="line"><span class="number">0021</span> <span class="number">0700</span> <span class="number">2401</span> 000a <span class="number">536f</span> <span class="number">7572</span> <span class="number">6365</span> <span class="number">4669</span></span><br><span class="line">6c65 <span class="number">0100</span> <span class="number">094d</span> <span class="number">6169</span> 6e2e 6a61 <span class="number">7661</span> 0c00</span><br><span class="line">0800 090c <span class="number">0006</span> <span class="number">0007</span> <span class="number">0100</span> 136a <span class="number">6176</span> <span class="number">612f</span></span><br><span class="line">6c61 <span class="number">6e67</span> 2f45 <span class="number">7863</span> <span class="number">6570</span> <span class="number">7469</span> 6f6e <span class="number">0100</span></span><br><span class="line">0f74 <span class="number">6573</span> <span class="number">742f</span> 6a61 <span class="number">7661</span> <span class="number">702f</span> 4d61 696e</span><br><span class="line"><span class="number">0100</span> 106a <span class="number">6176</span> <span class="number">612f</span> 6c61 <span class="number">6e67</span> 2f4f 626a</span><br><span class="line"><span class="number">6563</span> <span class="number">7401</span> <span class="number">0013</span> 6a61 <span class="number">7661</span> 2f6c 616e <span class="number">672f</span></span><br><span class="line"><span class="number">5468</span> <span class="number">726f</span> <span class="number">7761</span> 626c <span class="number">6500</span> <span class="number">2100</span> <span class="number">0400</span> <span class="number">0500</span></span><br><span class="line"><span class="number">0000</span> <span class="number">0100</span> <span class="number">0200</span> <span class="number">0600</span> <span class="number">0700</span> <span class="number">0000</span> <span class="number">0400</span> <span class="number">0100</span></span><br><span class="line">0800 0900 <span class="number">0100</span> 0a00 <span class="number">0000</span> 2f00 <span class="number">0100</span> <span class="number">0100</span></span><br><span class="line"><span class="number">0000</span> 052a b700 01b1 <span class="number">0000</span> <span class="number">0002</span> 000b <span class="number">0000</span></span><br><span class="line"><span class="number">0006</span> <span class="number">0001</span> <span class="number">0000</span> <span class="number">0007</span> 000c <span class="number">0000</span> 000c <span class="number">0001</span></span><br><span class="line"><span class="number">0000</span> <span class="number">0005</span> <span class="number">000d</span> 000e <span class="number">0000</span> 0009 <span class="number">000f</span> <span class="number">0010</span></span><br><span class="line"><span class="number">0002</span> 000a <span class="number">0000</span> 002b <span class="number">0000</span> <span class="number">0001</span> <span class="number">0000</span> <span class="number">0001</span></span><br><span class="line">b100 <span class="number">0000</span> <span class="number">0200</span> <span class="number">0b00</span> <span class="number">0000</span> <span class="number">0600</span> <span class="number">0100</span> <span class="number">0000</span></span><br><span class="line"><span class="number">0b00</span> 0c00 <span class="number">0000</span> 0c00 <span class="number">0100</span> <span class="number">0000</span> <span class="number">0100</span> <span class="number">1100</span></span><br><span class="line"><span class="number">1200</span> <span class="number">0000</span> <span class="number">1300</span> <span class="number">0000</span> <span class="number">0501</span> <span class="number">0011</span> <span class="number">0000</span> <span class="number">0001</span></span><br><span class="line"><span class="number">0014</span> <span class="number">0015</span> <span class="number">0001</span> 000a <span class="number">0000</span> <span class="number">0031</span> <span class="number">0002</span> <span class="number">0001</span></span><br><span class="line"><span class="number">0000</span> <span class="number">0007</span> 2ab4 <span class="number">0002</span> <span class="number">0460</span> ac00 <span class="number">0000</span> <span class="number">0200</span></span><br><span class="line"><span class="number">0b00</span> <span class="number">0000</span> <span class="number">0600</span> <span class="number">0100</span> <span class="number">0000</span> <span class="number">0e00</span> 0c00 <span class="number">0000</span></span><br><span class="line">0c00 <span class="number">0100</span> <span class="number">0000</span> <span class="number">0700</span> 0d00 <span class="number">0e00</span> <span class="number">0000</span> <span class="number">0100</span></span><br><span class="line"><span class="number">1600</span> <span class="number">1500</span> <span class="number">0100</span> 0a00 <span class="number">0000</span> c200 <span class="number">0100</span> <span class="number">0500</span></span><br><span class="line"><span class="number">0000</span> <span class="number">1804</span> 3c1b 3d06 3c1c ac4d 053c 1b3e</span><br><span class="line">063c 1dac 3a04 063c <span class="number">1904</span> bf00 <span class="number">0400</span> <span class="number">0000</span></span><br><span class="line"><span class="number">0400</span> 0800 <span class="number">0300</span> <span class="number">0000</span> <span class="number">0400</span> <span class="number">1100</span> <span class="number">0000</span> 0800</span><br><span class="line">0d00 <span class="number">1100</span> <span class="number">0000</span> <span class="number">1100</span> <span class="number">1300</span> <span class="number">1100</span> <span class="number">0000</span> <span class="number">0300</span></span><br><span class="line"><span class="number">0b00</span> <span class="number">0000</span> <span class="number">2e00</span> <span class="number">0b00</span> <span class="number">0000</span> <span class="number">1400</span> <span class="number">0200</span> <span class="number">1500</span></span><br><span class="line"><span class="number">0400</span> 1a00 <span class="number">0600</span> <span class="number">1500</span> 0800 <span class="number">1600</span> 0900 <span class="number">1700</span></span><br><span class="line"><span class="number">0b00</span> <span class="number">1800</span> 0d00 1a00 0f00 <span class="number">1800</span> <span class="number">1100</span> 1a00</span><br><span class="line"><span class="number">1500</span> 1b00 0c00 <span class="number">0000</span> <span class="number">3400</span> <span class="number">0500</span> <span class="number">0200</span> <span class="number">0600</span></span><br><span class="line"><span class="number">1700</span> <span class="number">0700</span> <span class="number">0100</span> 0900 0800 <span class="number">1800</span> <span class="number">1900</span> <span class="number">0200</span></span><br><span class="line"><span class="number">0b00</span> <span class="number">0600</span> <span class="number">1700</span> <span class="number">0700</span> <span class="number">0100</span> <span class="number">0000</span> <span class="number">1800</span> 0d00</span><br><span class="line"><span class="number">0e00</span> <span class="number">0000</span> <span class="number">1500</span> <span class="number">0300</span> <span class="number">1700</span> <span class="number">0700</span> <span class="number">0100</span> 1a00</span><br><span class="line"><span class="number">0000</span> 0a00 0248 <span class="number">0700</span> 1b48 <span class="number">0700</span> 1c00 <span class="number">0100</span></span><br><span class="line">1d00 <span class="number">0000</span> <span class="number">0200</span> 1e</span><br></pre></td></tr></table></figure>

<h5 id="反编译class文件"><a href="#反编译class文件" class="headerlink" title="反编译class文件"></a>反编译class文件</h5><p>输入命令 <code>javap -verbose -p Main.class</code> 查看输出内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">Classfile /D:/Project/test/javap/Main.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">2022</span>-<span class="number">7</span>-<span class="number">29</span>; size <span class="number">823</span> bytes</span><br><span class="line">  MD5 checksum 690a2c3b12765481dadabc27d3967ca7</span><br><span class="line">  Compiled from <span class="string">&quot;Main.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span>.javap.Main</span><br><span class="line">  minor version: <span class="number">0</span></span><br><span class="line">  major version: <span class="number">52</span></span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">1</span> = Methodref          #<span class="number">5.</span>#<span class="number">31</span>         <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">2</span> = Fieldref           #<span class="number">4.</span>#<span class="number">32</span>         <span class="comment">// test/javap/Main.m:I</span></span><br><span class="line">   #<span class="number">3</span> = Class              #<span class="number">33</span>            <span class="comment">// java/lang/Exception</span></span><br><span class="line">   #<span class="number">4</span> = Class              #<span class="number">34</span>            <span class="comment">// test/javap/Main</span></span><br><span class="line">   #<span class="number">5</span> = Class              #<span class="number">35</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">   #<span class="number">6</span> = Utf8               m</span><br><span class="line">   #<span class="number">7</span> = Utf8               I</span><br><span class="line">   #<span class="number">8</span> = Utf8               &lt;init&gt;</span><br><span class="line">   #<span class="number">9</span> = Utf8               ()V</span><br><span class="line">  #<span class="number">10</span> = Utf8               Code</span><br><span class="line">  #<span class="number">11</span> = Utf8               LineNumberTable</span><br><span class="line">  #<span class="number">12</span> = Utf8               LocalVariableTable</span><br><span class="line">  #<span class="number">13</span> = Utf8               <span class="built_in">this</span></span><br><span class="line">  #<span class="number">14</span> = Utf8               Ltest/javap/Main;</span><br><span class="line">  #<span class="number">15</span> = Utf8               main</span><br><span class="line">  #<span class="number">16</span> = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #<span class="number">17</span> = Utf8               args</span><br><span class="line">  #<span class="number">18</span> = Utf8               [Ljava/lang/String;</span><br><span class="line">  #<span class="number">19</span> = Utf8               MethodParameters</span><br><span class="line">  #<span class="number">20</span> = Utf8               inc</span><br><span class="line">  #<span class="number">21</span> = Utf8               ()I</span><br><span class="line">  #<span class="number">22</span> = Utf8               foo</span><br><span class="line">  #<span class="number">23</span> = Utf8               x</span><br><span class="line">  #<span class="number">24</span> = Utf8               e</span><br><span class="line">  #<span class="number">25</span> = Utf8               Ljava/lang/Exception;</span><br><span class="line">  #<span class="number">26</span> = Utf8               StackMapTable</span><br><span class="line">  #<span class="number">27</span> = Class              #<span class="number">33</span>            <span class="comment">// java/lang/Exception</span></span><br><span class="line">  #<span class="number">28</span> = Class              #<span class="number">36</span>            <span class="comment">// java/lang/Throwable</span></span><br><span class="line">  #<span class="number">29</span> = Utf8               SourceFile</span><br><span class="line">  #<span class="number">30</span> = Utf8               Main.java</span><br><span class="line">  #<span class="number">31</span> = NameAndType        #<span class="number">8</span>:#<span class="number">9</span>          <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">32</span> = NameAndType        #<span class="number">6</span>:#<span class="number">7</span>          <span class="comment">// m:I</span></span><br><span class="line">  #<span class="number">33</span> = Utf8               java/lang/Exception</span><br><span class="line">  #<span class="number">34</span> = Utf8               test/javap/Main</span><br><span class="line">  #<span class="number">35</span> = Utf8               java/lang/Object</span><br><span class="line">  #<span class="number">36</span> = Utf8               java/lang/Throwable</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> m;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_PRIVATE</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> test.javap.Main();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">7</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="built_in">this</span>   Ltest/javap/Main;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">0</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">11</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>  args   [Ljava/lang/String;</span><br><span class="line">    MethodParameters:</span><br><span class="line">      Name                           Flags</span><br><span class="line">      args</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">inc</span><span class="params">()</span>;</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: getfield      #<span class="number">2</span>                  <span class="comment">// Field m:I</span></span><br><span class="line">         <span class="number">4</span>: iconst_1</span><br><span class="line">         <span class="number">5</span>: iadd</span><br><span class="line">         <span class="number">6</span>: ireturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">14</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">7</span>     <span class="number">0</span>  <span class="built_in">this</span>   Ltest/javap/Main;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">foo</span><span class="params">()</span>;</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">5</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: iconst_1</span><br><span class="line">         <span class="number">1</span>: istore_1</span><br><span class="line">         <span class="number">2</span>: iload_1</span><br><span class="line">         <span class="number">3</span>: istore_2</span><br><span class="line">         <span class="number">4</span>: iconst_3</span><br><span class="line">         <span class="number">5</span>: istore_1</span><br><span class="line">         <span class="number">6</span>: iload_2</span><br><span class="line">         <span class="number">7</span>: ireturn</span><br><span class="line">         <span class="number">8</span>: astore_2</span><br><span class="line">         <span class="number">9</span>: iconst_2</span><br><span class="line">        <span class="number">10</span>: istore_1</span><br><span class="line">        <span class="number">11</span>: iload_1</span><br><span class="line">        <span class="number">12</span>: istore_3</span><br><span class="line">        <span class="number">13</span>: iconst_3</span><br><span class="line">        <span class="number">14</span>: istore_1</span><br><span class="line">        <span class="number">15</span>: iload_3</span><br><span class="line">        <span class="number">16</span>: ireturn</span><br><span class="line">        <span class="number">17</span>: astore        <span class="number">4</span></span><br><span class="line">        <span class="number">19</span>: iconst_3</span><br><span class="line">        <span class="number">20</span>: istore_1</span><br><span class="line">        <span class="number">21</span>: aload         <span class="number">4</span></span><br><span class="line">        <span class="number">23</span>: athrow</span><br><span class="line">      Exception table:</span><br><span class="line">         from    to  target type</span><br><span class="line">             <span class="number">0</span>     <span class="number">4</span>     <span class="number">8</span>   Class java/lang/Exception</span><br><span class="line">             <span class="number">0</span>     <span class="number">4</span>    <span class="number">17</span>   any</span><br><span class="line">             <span class="number">8</span>    <span class="number">13</span>    <span class="number">17</span>   any</span><br><span class="line">            <span class="number">17</span>    <span class="number">19</span>    <span class="number">17</span>   any</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">20</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">21</span>: <span class="number">2</span></span><br><span class="line">        line <span class="number">26</span>: <span class="number">4</span></span><br><span class="line">        line <span class="number">21</span>: <span class="number">6</span></span><br><span class="line">        line <span class="number">22</span>: <span class="number">8</span></span><br><span class="line">        line <span class="number">23</span>: <span class="number">9</span></span><br><span class="line">        line <span class="number">24</span>: <span class="number">11</span></span><br><span class="line">        line <span class="number">26</span>: <span class="number">13</span></span><br><span class="line">        line <span class="number">24</span>: <span class="number">15</span></span><br><span class="line">        line <span class="number">26</span>: <span class="number">17</span></span><br><span class="line">        line <span class="number">27</span>: <span class="number">21</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">2</span>       <span class="number">6</span>     <span class="number">1</span>     x   I</span><br><span class="line">            <span class="number">9</span>       <span class="number">8</span>     <span class="number">2</span>     e   Ljava/lang/Exception;</span><br><span class="line">           <span class="number">11</span>       <span class="number">6</span>     <span class="number">1</span>     x   I</span><br><span class="line">            <span class="number">0</span>      <span class="number">24</span>     <span class="number">0</span>  <span class="built_in">this</span>   Ltest/javap/Main;</span><br><span class="line">           <span class="number">21</span>       <span class="number">3</span>     <span class="number">1</span>     x   I</span><br><span class="line">      StackMapTable: number_of_entries = <span class="number">2</span></span><br><span class="line">        frame_type = <span class="number">72</span> <span class="comment">/* same_locals_1_stack_item */</span></span><br><span class="line">          stack = [ <span class="keyword">class</span> <span class="title class_">java</span>/lang/Exception ]</span><br><span class="line">        frame_type = <span class="number">72</span> <span class="comment">/* same_locals_1_stack_item */</span></span><br><span class="line">          stack = [ <span class="keyword">class</span> <span class="title class_">java</span>/lang/Throwable ]</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: <span class="string">&quot;Main.java&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Class文件结构"><a href="#Class文件结构" class="headerlink" title="Class文件结构"></a>Class文件结构</h4><p><img src="/imgs/java-jvm/jvm-class%E7%BB%93%E6%9E%84.png" alt="jvm-class结构"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4              magic;                                 <span class="comment">//Class 文件的标志</span></span><br><span class="line">    u2              minor_version;                         <span class="comment">//Class 的小版本号</span></span><br><span class="line">    u2              major_version;                         <span class="comment">//Class 的大版本号</span></span><br><span class="line">    u2              constant_pool_count;                   <span class="comment">//常量池的数量</span></span><br><span class="line">    cp_info         constant_pool[constant_pool_count-<span class="number">1</span>];  <span class="comment">//常量池</span></span><br><span class="line">    u2              access_flags;                          <span class="comment">//Class 的访问标记</span></span><br><span class="line">    u2              this_class;                            <span class="comment">//当前类</span></span><br><span class="line">    u2              super_class;                           <span class="comment">//父类</span></span><br><span class="line">    u2              interfaces_count;                      <span class="comment">//接口</span></span><br><span class="line">    u2              interfaces[interfaces_count];          <span class="comment">//一个类可以实现多个接口</span></span><br><span class="line">    u2              fields_count;                          <span class="comment">//Class 文件的字段属性</span></span><br><span class="line">    field_info      fields[fields_count];                  <span class="comment">//一个类会可以有个字段</span></span><br><span class="line">    u2              methods_count;                         <span class="comment">//Class 文件的方法数量</span></span><br><span class="line">    method_info     methods[methods_count];                <span class="comment">//一个类可以有个多个方法</span></span><br><span class="line">    u2              attributes_count;                      <span class="comment">//此类的属性表中的属性数</span></span><br><span class="line">    attribute_info  attributes[attributes_count];          <span class="comment">//属性表集合</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>每个 Class 文件的头 4 个字节称为魔数（magic），它的值固定为 0xCAFEBABE，唯有以”cafe babe”开头的class文件方可被虚拟机所接受，这4个字节就是字节码文件的身份识别。</li>
<li>紧接着magic之后的四个字节存储的是 Class 文件的次版本号和主版本号。例如 java 1.8.0_131-b11 对应的4个字节是 0x00000034，0000是编译器jdk版本的次版本号0，0034转化为十进制是52，是主版本号。</li>
</ol>
<h4 id="文件信息"><a href="#文件信息" class="headerlink" title="文件信息"></a>文件信息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Classfile /D:/Project/test/javap/Main.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">2022</span>-<span class="number">7</span>-<span class="number">29</span>; size <span class="number">823</span> bytes</span><br><span class="line">  MD5 checksum 690a2c3b12765481dadabc27d3967ca7</span><br><span class="line">  Compiled from <span class="string">&quot;Main.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span>.javap.Main</span><br><span class="line">  minor version: <span class="number">0</span></span><br><span class="line">  major version: <span class="number">52</span></span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br></pre></td></tr></table></figure>

<p>开头的7行信息包括:Class文件当前所在位置，最后修改时间和文件大小，MD5值，编译自哪个文件，类的全限定名，jdk次版本号，主版本号。 </p>
<p>紧接着的是该类的访问标志：ACC_PUBLIC, ACC_SUPER, 访问标志的含义如下:</p>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>标志值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>是否为Public类型</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
<td>是否被声明为final，只有类可以设置</td>
</tr>
<tr>
<td>ACC_SUPER</td>
<td>0x0020</td>
<td>是否允许使用invokespecial字节码指令的新语义．</td>
</tr>
<tr>
<td>ACC_INTERFACE</td>
<td>0x0200</td>
<td>标志这是一个接口</td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x0400</td>
<td>是否为abstract类型，对于接口或者抽象类来说，次标志值为真，其他类型为假</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>标志这个类并非由用户代码产生</td>
</tr>
<tr>
<td>ACC_ANNOTATION</td>
<td>0x2000</td>
<td>标志这是一个注解</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>标志这是一个枚举</td>
</tr>
</tbody></table>
<h4 id="常量池"><a href="#常量池" class="headerlink" title="常量池"></a>常量池</h4><p><code>Constant pool</code> 意为常量池。</p>
<p>常量池可以理解成Class文件中的资源仓库。主要存放的是两大类常量：字面量(Literal)和符号引用(Symbolic References)。字面量类似于java中的常量概念，如文本字符串，final常量等，而符号引用则属于编译原理方面的概念，包括以下三种: </p>
<ul>
<li>类和接口的全限定名(Fully Qualified Name) </li>
<li>字段的名称和描述符号(Descriptor) </li>
<li>方法的名称和描述符</li>
</ul>
<p>对照反编译文件分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">1</span> = Methodref          #<span class="number">5.</span>#<span class="number">31</span>         <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">5</span> = Class              #<span class="number">35</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">   #<span class="number">8</span> = Utf8               &lt;init&gt;</span><br><span class="line">   #<span class="number">9</span> = Utf8               ()V</span><br><span class="line">  #<span class="number">31</span> = NameAndType        #<span class="number">8</span>:#<span class="number">9</span>          <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">35</span> = Utf8               java/lang/Object</span><br></pre></td></tr></table></figure>

<p>第一个常量是一个方法定义，指向了第4和第18个常量。以此类推查看第4和第18个常量。最后可以拼接成第一个常量右侧的注释内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java/lang/Object.<span class="string">&quot;&lt;init&gt;&quot;</span>:()V </span><br></pre></td></tr></table></figure>

<p>这段可以理解为该类的实例构造器的声明，由于Main类没有重写构造方法，所以调用的是父类的构造方法。此处也说明了Main类的直接父类是Object。 该方法默认返回值是V, 也就是void，无返回值。</p>
<p>第二个常量同理可得:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> #<span class="number">2</span> = Fieldref           #<span class="number">4.</span>#<span class="number">32</span>         <span class="comment">// test/javap/Main.m:I</span></span><br><span class="line"> #<span class="number">4</span> = Class              #<span class="number">34</span>            <span class="comment">// test/javap/Main</span></span><br><span class="line"> #<span class="number">6</span> = Utf8               m</span><br><span class="line"> #<span class="number">7</span> = Utf8               I</span><br><span class="line">#<span class="number">32</span> = NameAndType        #<span class="number">6</span>:#<span class="number">7</span>          <span class="comment">// m:I</span></span><br><span class="line">#<span class="number">34</span> = Utf8               test/javap/Main</span><br></pre></td></tr></table></figure>

<p>复制代码此处声明了一个字段m，类型为I, I即是int类型。</p>
<h5 id="字节码的类型对应"><a href="#字节码的类型对应" class="headerlink" title="字节码的类型对应"></a>字节码的类型对应</h5><table>
<thead>
<tr>
<th>标识字符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>B</td>
<td>基本类型byte</td>
</tr>
<tr>
<td>C</td>
<td>基本类型char</td>
</tr>
<tr>
<td>D</td>
<td>基本类型double</td>
</tr>
<tr>
<td>F</td>
<td>基本类型float</td>
</tr>
<tr>
<td>I</td>
<td>基本类型int</td>
</tr>
<tr>
<td>J</td>
<td>基本类型long</td>
</tr>
<tr>
<td>S</td>
<td>基本类型short</td>
</tr>
<tr>
<td>Z</td>
<td>基本类型boolean</td>
</tr>
<tr>
<td>V</td>
<td>特殊类型void</td>
</tr>
<tr>
<td>L</td>
<td>对象类型，以分号结尾，如Ljava&#x2F;lang&#x2F;Object;</td>
</tr>
</tbody></table>
<p>对于数组类型，每一位使用一个前置的 <code>[</code> 字符来描述，如定义一个 <code>java.lang.String[][]</code> 类型的维数组，将被记录为 <code>[[Ljava/lang/String;</code></p>
<h4 id="方法表集合"><a href="#方法表集合" class="headerlink" title="方法表集合"></a>方法表集合</h4><p>在常量池之后的是对类内部的方法描述，在字节码中以表的集合形式表现，暂且不管字节码文件的16进制文件内容如何，我们直接看反编译后的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此处声明了一个私有变量m，类型为int，返回值为int</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> m;</span><br><span class="line">  descriptor: I</span><br><span class="line">  flags: ACC_PRIVATE</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里是构造方法：Main()，返回值为void, public方法</span></span><br><span class="line"><span class="keyword">public</span> test.javap.Main();</span><br><span class="line">  descriptor: ()V</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">       <span class="number">0</span>: aload_0</span><br><span class="line">       <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">       <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line <span class="number">7</span>: <span class="number">0</span></span><br><span class="line">    LocalVariableTable:</span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="built_in">this</span>   Ltest/javap/Main;</span><br></pre></td></tr></table></figure>

<p>code内的主要属性为: </p>
<ul>
<li>stack: 最大操作数栈，JVM运行时会根据这个值来分配栈帧(Frame)中的操作栈深度,此处为1 </li>
<li>locals: 局部变量所需的存储空间，单位为Slot, Slot是虚拟机为局部变量分配内存时所使用的最小单位，为4个字节大小。方法参数(包括实例方法中的隐藏参数this)，显示异常处理器的参数(try catch中的catch块所定义的异常)，方法体中定义的局部变量都需要使用局部变量表来存放。值得一提的是，locals的大小并不一定等于所有局部变量所占的Slot之和，因为局部变量中的Slot是可以重用的。 </li>
<li>args_size: 方法参数的个数，这里是1，因为每个实例方法都会有一个隐藏参数this attribute_info: 方法体内容，0,1,4为字节码”行号”，该段代码的意思是将第一个引用类型本地变量推送至栈顶，然后执行该类型的实例方法，也就是常量池存放的第一个变量，也就是注释里的java&#x2F;lang&#x2F;Object.””:()V, 然后执行返回语句，结束方法。 </li>
<li>LineNumberTable: 该属性的作用是描述源码行号与字节码行号(字节码偏移量)之间的对应关系。可以使用 -g:none 或-g:lines选项来取消或要求生成这项信息，如果选择不生成LineNumberTable，当程序运行异常时将无法获取到发生异常的源码行号，也无法按照源码的行数来调试程序。 </li>
<li>LocalVariableTable: 该属性的作用是描述帧栈中局部变量与源码中定义的变量之间的关系。可以使用 -g:none 或 -g:vars来取消或生成这项信息，如果没有生成这项信息，那么当别人引用这个方法时，将无法获取到参数名称，取而代之的是arg0, arg1这样的占位符。start 表示该局部变量在哪一行开始可见，length 表示可见行数，Slot 代表所在帧栈位置，Name 是变量名称，然后是类型签名。</li>
</ul>
<p>同理可以分析Main类中的另一个方法”inc()”:</p>
<p>方法体内的内容是：将this入栈，获取字段#2并置于栈顶, 将int类型的1入栈，将栈内顶部的两个数值相加，返回一个int类型的值。</p>
<h4 id="类名"><a href="#类名" class="headerlink" title="类名"></a>类名</h4><p>最后很显然是源码文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SourceFile: <span class="string">&quot;Main.java&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="分析try-catch-finally"><a href="#分析try-catch-finally" class="headerlink" title="分析try-catch-finally"></a>分析try-catch-finally</h4><p>分析上面示例中的方法 foo()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">foo</span><span class="params">()</span>;</span><br><span class="line">  descriptor: ()I</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=<span class="number">1</span>, locals=<span class="number">5</span>, args_size=<span class="number">1</span></span><br><span class="line">       <span class="number">0</span>: iconst_1  <span class="comment">//int型1入栈 -&gt;栈顶=1</span></span><br><span class="line">       <span class="number">1</span>: istore_1  <span class="comment">//将栈顶的int型数值存入第二个局部变量 -&gt;局部2=1</span></span><br><span class="line">       <span class="number">2</span>: iload_1   <span class="comment">//将第二个int型局部变量推送至栈顶 -&gt;栈顶=1</span></span><br><span class="line">       <span class="number">3</span>: istore_2  <span class="comment">//!!将栈顶int型数值存入第三个局部变量 -&gt;局部3=1</span></span><br><span class="line"></span><br><span class="line">       <span class="number">4</span>: iconst_3  <span class="comment">//int型3入栈 -&gt;栈顶=3</span></span><br><span class="line">       <span class="number">5</span>: istore_1  <span class="comment">//将栈顶的int型数值存入第二个局部变量 -&gt;局部2=3</span></span><br><span class="line">       <span class="number">6</span>: iload_2   <span class="comment">//!!将第三个int型局部变量推送至栈顶 -&gt;栈顶=1</span></span><br><span class="line">       <span class="number">7</span>: ireturn   <span class="comment">//从当前方法返回栈顶int数值 -&gt;1</span></span><br><span class="line"></span><br><span class="line">       <span class="number">8</span>: astore_2  <span class="comment">// -&gt;局部3=Exception</span></span><br><span class="line">       <span class="number">9</span>: iconst_2  <span class="comment">// -&gt;栈顶=2</span></span><br><span class="line">      <span class="number">10</span>: istore_1  <span class="comment">// -&gt;局部2=2</span></span><br><span class="line">      <span class="number">11</span>: iload_1   <span class="comment">// -&gt;栈顶=2</span></span><br><span class="line">      <span class="number">12</span>: istore_3  <span class="comment">//!! -&gt;局部4=2</span></span><br><span class="line"></span><br><span class="line">      <span class="number">13</span>: iconst_3  <span class="comment">// -&gt;栈顶=3</span></span><br><span class="line">      <span class="number">14</span>: istore_1  <span class="comment">// -&gt;局部1=3</span></span><br><span class="line">      <span class="number">15</span>: iload_3   <span class="comment">//!! -&gt;栈顶=2</span></span><br><span class="line">      <span class="number">16</span>: ireturn   <span class="comment">// -&gt; 2</span></span><br><span class="line"></span><br><span class="line">      <span class="number">17</span>: astore        <span class="number">4</span>  <span class="comment">//将栈顶引用型数值存入第五个局部变量=any</span></span><br><span class="line">      <span class="number">19</span>: iconst_3         <span class="comment">//将int型数值3入栈 -&gt; 栈顶3</span></span><br><span class="line">      <span class="number">20</span>: istore_1         <span class="comment">//将栈顶第一个int数值存入第二个局部变量 -&gt; 局部2=3</span></span><br><span class="line">      <span class="number">21</span>: aload         <span class="number">4</span>  <span class="comment">//将局部第五个局部变量(引用型)推送至栈顶</span></span><br><span class="line">      <span class="number">23</span>: athrow           <span class="comment">//将栈顶的异常抛出</span></span><br><span class="line">    Exception table:</span><br><span class="line">       from    to  target type</span><br><span class="line">           <span class="number">0</span>     <span class="number">4</span>     <span class="number">8</span>   Class java/lang/Exception  <span class="comment">//0到4行对应的异常，对应#8中储存的异常</span></span><br><span class="line">           <span class="number">0</span>     <span class="number">4</span>    <span class="number">17</span>   any                        <span class="comment">//Exeption之外的其他异常</span></span><br><span class="line">           <span class="number">8</span>    <span class="number">13</span>    <span class="number">17</span>   any</span><br><span class="line">          <span class="number">17</span>    <span class="number">19</span>    <span class="number">17</span>   any</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line <span class="number">20</span>: <span class="number">0</span></span><br><span class="line">      line <span class="number">21</span>: <span class="number">2</span></span><br><span class="line">      line <span class="number">26</span>: <span class="number">4</span></span><br><span class="line">      line <span class="number">21</span>: <span class="number">6</span></span><br><span class="line">      line <span class="number">22</span>: <span class="number">8</span></span><br><span class="line">      line <span class="number">23</span>: <span class="number">9</span></span><br><span class="line">      line <span class="number">24</span>: <span class="number">11</span></span><br><span class="line">      line <span class="number">26</span>: <span class="number">13</span></span><br><span class="line">      line <span class="number">24</span>: <span class="number">15</span></span><br><span class="line">      line <span class="number">26</span>: <span class="number">17</span></span><br><span class="line">      line <span class="number">27</span>: <span class="number">21</span></span><br><span class="line">    LocalVariableTable:</span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          <span class="number">2</span>       <span class="number">6</span>     <span class="number">1</span>     x   I</span><br><span class="line">          <span class="number">9</span>       <span class="number">8</span>     <span class="number">2</span>     e   Ljava/lang/Exception;</span><br><span class="line">         <span class="number">11</span>       <span class="number">6</span>     <span class="number">1</span>     x   I</span><br><span class="line">          <span class="number">0</span>      <span class="number">24</span>     <span class="number">0</span>  <span class="built_in">this</span>   Ltest/javap/Main;</span><br><span class="line">         <span class="number">21</span>       <span class="number">3</span>     <span class="number">1</span>     x   I</span><br><span class="line">    StackMapTable: number_of_entries = <span class="number">2</span></span><br><span class="line">      frame_type = <span class="number">72</span> <span class="comment">/* same_locals_1_stack_item */</span></span><br><span class="line">        stack = [ <span class="keyword">class</span> <span class="title class_">java</span>/lang/Exception ]</span><br><span class="line">      frame_type = <span class="number">72</span> <span class="comment">/* same_locals_1_stack_item */</span></span><br><span class="line">        stack = [ <span class="keyword">class</span> <span class="title class_">java</span>/lang/Throwable ]</span><br></pre></td></tr></table></figure>

<p>试问当不发生异常和发生异常的情况下，foo()的返回值分别是多少？</p>
<p>在字节码的4,5，以及13,14中执行的是同一个操作，就是将int型的3入操作数栈顶，并存入第二个局部变量。这正是我们源码在finally语句块中内容。也就是说，JVM在处理异常时，会在每个可能的分支都将finally语句重复执行一遍。</p>
<p>通过一步步分析字节码，可以得出最后的运行结果是：</p>
<ul>
<li>不发生异常时: return 1</li>
<li>发生异常时: return 2</li>
<li>发生非Exception及其子类的异常，抛出异常，不返回值</li>
</ul>
<h3 id="字节码增强技术"><a href="#字节码增强技术" class="headerlink" title="字节码增强技术"></a>字节码增强技术</h3><p>字节码增强技术就是一类对现有字节码进行修改或者动态生成全新字节码文件的技术。</p>
<p>字节码增强技术相当于是一把打开运行时JVM的钥匙，利用它可以动态地对运行中的程序做修改，也可以跟踪JVM运行中程序的状态。</p>
<p>此外，我们平时使用的动态代理、AOP也与字节码增强密切相关，它们实质上还是利用各种手段生成符合规范的字节码文件。</p>
<p>综上所述，掌握字节码增强后可以高效地定位并快速修复一些棘手的问题（如线上性能问题、方法出现不可控的出入参需要紧急加日志等问题），也可以在开发中减少冗余代码，大大提高开发效率。</p>
<p><img src="/imgs/java-jvm/java%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA.png" alt="java字节码增强"></p>
<h4 id="ASM"><a href="#ASM" class="headerlink" title="ASM"></a>ASM</h4><p>对于需要手动操纵字节码的需求，可以使用ASM，它可以直接生产 <code>.class</code> 字节码文件，也可以在类被加载入JVM之前动态修改类行为。</p>
<p>ASM的应用场景有AOP（Cglib就是基于ASM）、热部署、修改其他jar包中的类等。</p>
<p>访问者模式主要用于修改或操作一些数据结构比较稳定的数据，节码文件的结构是由JVM固定的，所以很适合利用访问者模式对字节码文件进行修改。 </p>
<h5 id="ASM-API"><a href="#ASM-API" class="headerlink" title="ASM API"></a>ASM API</h5><h6 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h6><p>ASM Core API可以类比解析XML文件中的SAX方式，不需要把这个类的整个结构读取进来，就可以用流式的方法来处理字节码文件。好处是非常节约内存，但是编程难度较大。</p>
<p>出于性能考虑，一般情况下编程都使用Core API。在Core API中有以下几个关键类：</p>
<ul>
<li>ClassReader：用于读取已经编译好的.class文件。 </li>
<li>ClassWriter：用于重新构建编译后的类，如修改类名、属性以及方法，也可以生成新的类的字节码文件。 </li>
<li>各种Visitor类：如上所述，CoreAPI根据字节码从上到下依次处理，对于字节码文件中不同的区域有不同的Visitor，比如用于访问方法的MethodVisitor、用于访问类变量的FieldVisitor、用于访问注解的AnnotationVisitor等。为了实现AOP，重点要使用的是MethodVisitor。</li>
</ul>
<h6 id="树形API"><a href="#树形API" class="headerlink" title="树形API"></a>树形API</h6><p>ASM Tree API可以类比解析XML文件中的DOM方式，把整个类的结构读取到内存中，缺点是消耗内存多，但是编程比较简单。</p>
<p>TreeApi不同于CoreAPI，TreeAPI通过各种Node类来映射字节码的各个区域，类比DOM节点，就可以很好地理解这种编程方式。</p>
<h5 id="直接利用ASM实现AOP"><a href="#直接利用ASM实现AOP" class="headerlink" title="直接利用ASM实现AOP"></a>直接利用ASM实现AOP</h5><p>利用ASM的CoreAPI来增强类。只实现在方法调用前、后增加逻辑，通俗易懂且方便理解。</p>
<p>首先定义需要被增强的Base类：其中只包含一个process()方法，方法内输出一行“process”。增强后，我们期望的是，方法执行前输出“start”，之后输出”end”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了利用ASM实现AOP，需要定义两个类：</p>
<ol>
<li>MyClassVisitor类，用于对字节码的visit以及修改；</li>
<li>Generator类，在这个类中定义ClassReader和ClassWriter，其中的逻辑是，classReader读取字节码，然后交给MyClassVisitor类处理，处理完成后由ClassWriter写字节码并将旧的字节码替换掉。</li>
</ol>
<h6 id="Generator类"><a href="#Generator类" class="headerlink" title="Generator类"></a>Generator类</h6><p>Generator类较简单，我们先看一下它的实现，如下所示，然后重点解释MyClassVisitor类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.org.objectweb.asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Generator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//读取</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(<span class="string">&quot;test/org/objectweb/asm/Base&quot;</span>);</span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">        <span class="comment">//处理</span></span><br><span class="line">        <span class="type">ClassVisitor</span> <span class="variable">classVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClassVisitor</span>(classWriter);</span><br><span class="line">        classReader.accept(classVisitor, ClassReader.SKIP_DEBUG);</span><br><span class="line">        <span class="type">byte</span>[] data = classWriter.toByteArray();</span><br><span class="line">        <span class="comment">//输出</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;target/classes/test/org/objectweb/asm/Base.class&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(f);</span><br><span class="line">        fout.write(data);</span><br><span class="line">        fout.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;now generator cc success!!!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="MyClassVisitor类"><a href="#MyClassVisitor类" class="headerlink" title="MyClassVisitor类"></a>MyClassVisitor类</h6><p>MyClassVisitor继承自ClassVisitor，用于对字节码的观察。它还包含一个内部类MyMethodVisitor，继承自MethodVisitor用于对类内方法的观察，它的整体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.org.objectweb.asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClassVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> <span class="keyword">implements</span> <span class="title class_">Opcodes</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClassVisitor</span><span class="params">(ClassVisitor cv)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(ASM5, cv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(<span class="type">int</span> version, <span class="type">int</span> access, String name, String signature,</span></span><br><span class="line"><span class="params">                      String superName, String[] interfaces)</span> &#123;</span><br><span class="line">        cv.visit(version, access, name, signature, superName, interfaces);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String desc, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        <span class="type">MethodVisitor</span> <span class="variable">mv</span> <span class="operator">=</span> cv.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line">        <span class="comment">// Base类中有两个方法：无参构造以及process方法，这里不增强构造方法</span></span><br><span class="line">        <span class="keyword">if</span> (!name.equals(<span class="string">&quot;&lt;init&gt;&quot;</span>) &amp;&amp; mv != <span class="literal">null</span>) &#123;</span><br><span class="line">            mv = <span class="keyword">new</span> <span class="title class_">MyMethodVisitor</span>(mv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MyMethodVisitor</span> <span class="keyword">extends</span> <span class="title class_">MethodVisitor</span> <span class="keyword">implements</span> <span class="title class_">Opcodes</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyMethodVisitor</span><span class="params">(MethodVisitor mv)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(Opcodes.ASM5, mv);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.visitCode();</span><br><span class="line">            mv.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">            mv.visitLdcInsn(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">            mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitInsn</span><span class="params">(<span class="type">int</span> opcode)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((opcode &gt;= Opcodes.IRETURN &amp;&amp; opcode &lt;= Opcodes.RETURN)</span><br><span class="line">                    || opcode == Opcodes.ATHROW) &#123;</span><br><span class="line">                <span class="comment">// 方法在返回之前，打印&quot;end&quot;</span></span><br><span class="line">                mv.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">                mv.visitLdcInsn(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">                mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mv.visitInsn(opcode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用这个类就可以实现对字节码的修改。详细解读其中的代码，对字节码做修改的步骤是： </p>
<ol>
<li>首先通过MyClassVisitor类中的visitMethod方法，判断当前字节码读到哪一个方法了。跳过构造方法 <code>&lt;init&gt;</code> 后，将需要被增强的方法交给内部类MyMethodVisitor来进行处理。 </li>
<li>接下来，进入内部类MyMethodVisitor中的visitCode方法，它会在ASM开始访问某一个方法的Code区时被调用，重写visitCode方法，将AOP中的前置逻辑就放在这里。</li>
<li>MyMethodVisitor继续读取字节码指令，每当ASM访问到无参数指令时，都会调用MyMethodVisitor中的visitInsn方法。我们判断了当前指令是否为无参数的 “return” 指令，如果是就在它的前面添加一些指令，也就是将AOP的后置逻辑放在该方法中。 </li>
<li>综上，重写MyMethodVisitor中的两个方法，就可以实现AOP了，而重写方法时就需要用ASM的写法，手动写入或者修改字节码。通过调用methodVisitor的visitXXXXInsn()方法就可以实现字节码的插入，XXXX对应相应的操作码助记符类型，比如mv.visitLdcInsn(“end”)对应的操作码就是ldc “end”，即将字符串“end”压入栈。</li>
<li>完成这两个visitor类后，运行Generator中的main方法完成对Base类的字节码增强，增强后的结果可以在编译后的target文件夹中找到Base.class文件进行查看，可以看到反编译后的代码已经改变了。然后写一个测试类MyTest，在其中new Base()，并调用base.process()方法。</li>
</ol>
<p>运行后的class文件反编译后:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> test.org.objectweb.asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Base</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试输出结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start</span><br><span class="line">process</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h5 id="ASM工具"><a href="#ASM工具" class="headerlink" title="ASM工具"></a>ASM工具</h5><p>利用ASM手写字节码时，需要利用一系列visitXXXXInsn()方法来写对应的助记符，所以需要先将每一行源代码转化为一个个的助记符，然后通过ASM的语法转换为visitXXXXInsn()这种写法。</p>
<p>所以可以借助ASM插件来进行编写，这里举例idea插件, idea 2022.1.3 可用的有 <a target="_blank" rel="noopener" href="https://plugins.jetbrains.com/plugin/13914-class-decompile">Class Decompile</a> (推荐) 和 ASM Bytecode Viewer。另外，ASM Bytecode Outline 已不可用。</p>
<h4 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h4><p>ASM是在指令层次上操作字节码的，Javassist是强调源代码层次操作字节码的框架。</p>
<p>Javassist的优点就在于编程简单，在实现字节码增强时，可以无须关注字节码刻板的结构。直接使用java编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构或者动态生成类。</p>
<p>其中最重要的是ClassPool、CtClass、CtMethod、CtField这四个类：</p>
<ol>
<li>CtClass（compile-time class）：编译时类信息，它是一个class文件在代码中的抽象表现形式，可以通过一个类的全限定名来获取一个CtClass对象，用来表示这个类文件。 </li>
<li>ClassPool：从开发视角来看，ClassPool是一张保存CtClass信息的HashTable，key为类名，value为类名对应的CtClass对象。当我们需要对某个类进行修改时，就是通过pool.getCtClass(“className”)方法从pool中获取到相应的CtClass。 </li>
<li>CtMethod：对应的是类中的方法。</li>
<li>CtField：对应的是类中的属性。</li>
</ol>
<p>写一个小Demo来展示Javassist简单、快速的特点。我们依然是对Base中的process()方法做增强，在方法调用前后分别输出”start”和”end”。</p>
<p>我们需要做的就是从pool中获取到相应的CtClass对象和其中的方法，然后执行method.insertBefore和insertAfter方法，参数为要插入的Java代码，再以字符串的形式传入即可，实现起来也极为简单。</p>
<p>实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.javassist;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavassistTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IllegalAccessException, InstantiationException, IOException &#123;</span><br><span class="line"><span class="comment">//        Base base = new Base();   // 取消注释这一行，运行时会报错，原因：JVM不允许在运行时动态重载一个类</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">cp</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> cp.get(<span class="string">&quot;test.javassist.Base&quot;</span>);</span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">m</span> <span class="operator">=</span> cc.getDeclaredMethod(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">        <span class="comment">// 是否带 &#123;&#125; 没有区别</span></span><br><span class="line">        m.insertBefore(<span class="string">&quot;System.out.println(\&quot;start\&quot;);&quot;</span>);</span><br><span class="line">        m.insertAfter(<span class="string">&quot;&#123; System.out.println(\&quot;end\&quot;); &#125;&quot;</span>);</span><br><span class="line">        cc.writeFile(<span class="string">&quot;target/classes&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; c = cc.toClass();</span><br><span class="line">        <span class="type">Base</span> <span class="variable">b</span> <span class="operator">=</span> (Base) c.newInstance();</span><br><span class="line">        b.process();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="运行时类的重载"><a href="#运行时类的重载" class="headerlink" title="运行时类的重载"></a>运行时类的重载</h5><p>如果我们在一个JVM中，先加载了一个类，然后又对其进行字节码增强并重新加载会发生什么呢？</p>
<p>在上文中Javassist的Demo中main()方法的第一行添加Base b&#x3D;new Base()，即在增强前就先让JVM加载Base类，然后在执行到c.toClass()方法时会抛出错误，在最后调用了ClassLoader的native方法defineClass()时报错。</p>
<p>综上，JVM不允许在运行时动态<strong>重载</strong>一个类，确切的说是不允许修改已经加载的类，和运行时修改未加载的类然后加载是两个概念。</p>
<p>但是，如果只能在类加载前对类进行强化，那字节码增强技术的使用场景就变得很窄了。</p>
<p>期望：在一个持续运行并已经加载了所有类的JVM中，还能利用字节码增强技术对其中的类行为做替换并重新加载。</p>
<p>为了模拟这种情况，我们将Base类做改写，在其中编写main方法，每五秒调用一次process()方法，在process()方法中输出一行“process”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.lang.instrument;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> ManagementFactory.getRuntimeMXBean().getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> name.split(<span class="string">&quot;@&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// 打印当前Pid</span></span><br><span class="line">        System.out.println(<span class="string">&quot;pid:&quot;</span>+s);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            process();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Instrument"><a href="#Instrument" class="headerlink" title="Instrument"></a>Instrument</h5><p>instrument是JVM提供的一个可以修改已加载类的类库，专门为Java语言编写的插桩服务提供支持。</p>
<p>它需要依赖JVMTI的Attach API机制实现。在JDK 1.6以前，instrument只能在JVM刚启动开始加载类时生效，而在JDK 1.6之后，instrument支持了在运行时对类定义的修改。</p>
<p>要使用instrument的类修改功能，我们需要实现它提供的ClassFileTransformer接口，定义一个类文件转换器,接口中的transform()方法会在类文件被加载时调用。在transform方法里，可以利用上文中的ASM或Javassist对传入的字节码进行改写或替换，生成新的字节码数组后返回。</p>
<p>这里定义一个实现了ClassFileTransformer接口的类TestTransformer，依然在其中利用Javassist对Base类中的process()方法进行增强，在前后分别打印“start”和“end”，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.lang.instrument;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformerTest</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Transforming &quot;</span> + className);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">cp</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> cp.get(<span class="string">&quot;test.java.lang.instrument.Base&quot;</span>);</span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">m</span> <span class="operator">=</span> cc.getDeclaredMethod(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">            m.insertBefore(<span class="string">&quot;&#123; System.out.println(\&quot;start\&quot;); &#125;&quot;</span>);</span><br><span class="line">            m.insertAfter(<span class="string">&quot;&#123; System.out.println(\&quot;end\&quot;); &#125;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> cc.toBytecode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在有了Transformer，那么它要如何注入到正在运行的JVM呢？还需要定义一个Agent，借助Agent的能力将Instrument注入到JVM中。</p>
<p>现在要介绍的是Agent中用到的另一个类Instrumentation。在JDK 1.6之后，Instrumentation可以做启动后的Instrument、本地代码（Native Code）的Instrument，以及动态改变Classpath等等。我们可以向Instrumentation中添加上文中定义的Transformer，并指定要被重加载的类，代码如下所示。这样，<strong>当Agent被Attach到一个JVM中时</strong>，就会执行类字节码替换并重载入JVM的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.lang.instrument;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AgentTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="comment">// 指定自定义的Transformer，在其中利用Javassist做字节码替换</span></span><br><span class="line">        inst.addTransformer(<span class="keyword">new</span> <span class="title class_">TransformerTest</span>(), <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 重定义类并载入新的字节码</span></span><br><span class="line">            inst.retransformClasses(Base.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;Agent Load Done.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;agent load failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="JVMTI-amp-Agent-amp-Attach-API"><a href="#JVMTI-amp-Agent-amp-Attach-API" class="headerlink" title="JVMTI &amp; Agent &amp; Attach API"></a>JVMTI &amp; Agent &amp; Attach API</h5><p>上面给出了Agent类的代码，追根溯源需要先介绍JPDA（Java Platform Debugger Architecture）。如果JVM启动时开启了JPDA，那么类是允许被重新加载的。在这种情况下，已被加载的旧版本类信息可以被卸载，然后重新加载新版本的类。正如JDPA名称中的Debugger，JDPA其实是一套用于调试Java程序的标准，任何JDK都必须实现该标准。</p>
<p>JPDA定义了一整套完整的体系，它将调试体系分为三部分，并规定了三者之间的通信接口。三部分由低到高分别是Java 虚拟机工具接口（JVMTI），Java 调试协议（JDWP）以及 Java 调试接口（JDI）</p>
<h6 id="JVMTI"><a href="#JVMTI" class="headerlink" title="JVMTI"></a>JVMTI</h6><p>JVMTI（JVM TOOL INTERFACE，JVM工具接口）是JVM提供的一套对JVM进行操作的工具接口。通过JVMTI，可以实现对JVM的多种操作，它通过接口注册各种事件勾子，在JVM事件触发时，同时触发预定义的勾子，以实现对各个JVM事件的响应，事件包括类文件加载、异常产生与捕获、线程启动和结束、进入和退出临界区、成员变量修改、GC开始和结束、方法调用进入和退出、临界区竞争与等待、VM启动与退出等等。</p>
<h6 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h6><p>Agent 是JVMTI的一种实现，Agent有两种启动方式，一是随Java进程启动而启动，经常见到的java -agentlib就是这种方式；二是运行时载入，通过attach API，将模块（jar包）动态地Attach到指定进程id的Java进程内。</p>
<h6 id="Attach-API"><a href="#Attach-API" class="headerlink" title="Attach API"></a>Attach API</h6><p>Attach API 的作用是提供JVM进程间通信的能力，比如说我们为了让另外一个JVM进程把线上服务的线程Dump出来，会运行jstack或jmap的进程，并传递pid的参数，告诉它要对哪个进程进行线程Dump，这就是Attach API做的事情。</p>
<h6 id="注入JVM示例"><a href="#注入JVM示例" class="headerlink" title="注入JVM示例"></a>注入JVM示例</h6><p>下面，我们通过Attach API的loadAgent()方法，将打包好的Agent jar包动态Attach到目标JVM上。具体实现起来的步骤如下：</p>
<ol>
<li>定义Agent，并在其中实现AgentMain方法，如上一小节中定义的代码块7中的AgentTest类；</li>
<li>将AgentTest类打成一个包含MANIFEST.MF的jar包，其中需要在MANIFEST.MF文件中新增3行Agent属性，同时需要将Agent-Class属性指定为AgentTest的全限定名，如下所示： <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Implementation-Title: test-project</span><br><span class="line">Implementation-Version: <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">Built-By: C</span><br><span class="line">Implementation-Vendor-Id: com.test</span><br><span class="line">Created-By: Apache Maven <span class="number">3.6</span><span class="number">.1</span></span><br><span class="line">Build-Jdk: <span class="number">1.8</span><span class="number">.0_212</span></span><br><span class="line">Implementation-URL: http:<span class="comment">//maven.apache.org/</span></span><br><span class="line"><span class="comment">// 下面三行为新增的3行</span></span><br><span class="line">Agent-Class: test.java.lang.instrument.AgentTest</span><br><span class="line">Can-Redefine-Classes: <span class="literal">true</span></span><br><span class="line">Can-Retransform-Classes: <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li>最后利用Attach API，将我们打包好的jar包Attach到指定的JVM pid上，代码如下： <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.lang.instrument;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AgentInitializationException;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AgentLoadException;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AttachNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttachTest</span> &#123;</span><br><span class="line">    <span class="comment">// 注意: 工程需要引入包: jdk所在目录/lib/tools.jar</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> AttachNotSupportedException, IOException, AgentLoadException, AgentInitializationException &#123;</span><br><span class="line">        <span class="comment">// 传入目标 JVM pid</span></span><br><span class="line">        <span class="type">VirtualMachine</span> <span class="variable">vm</span> <span class="operator">=</span> VirtualMachine.attach(<span class="string">&quot;2276&quot;</span>);</span><br><span class="line">        vm.loadAgent(<span class="string">&quot;target/test-project-1.0.0.jar&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>由于在MANIFEST.MF中指定了Agent-Class，所以在Attach后，目标JVM在运行时会走到TestAgent类中定义的agentmain()方法，而在这个方法中，我们利用Instrumentation，将指定类的字节码通过定义的类转化器TestTransformer做了Base类的字节码替换（通过javassist），并完成了类的重新加载。</li>
</ol>
<p>以下为运行时重新载入类的效果：先运行Base中的main()方法，启动一个JVM，可以在控制台看到每隔五秒输出一次”process”。接着执行Attacher中的main()方法，并将上一个JVM的pid传入。此时回到上一个main()方法的控制台，可以看到现在每隔五秒输出”process”前后会分别输出”start”和”end”，也就是说完成了运行时的字节码增强，并重新载入了这个类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pid:<span class="number">2276</span></span><br><span class="line">process</span><br><span class="line">process</span><br><span class="line">Transforming test/java/lang/instrument/Base</span><br><span class="line">Agent Load Done.</span><br><span class="line">start</span><br><span class="line">process</span><br><span class="line">end</span><br><span class="line">start</span><br><span class="line">process</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h6 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h6><p>至此，字节码增强技术的可使用范围就不再局限于JVM加载类前了。通过上述几个类库，我们可以在运行时对JVM中的类进行修改并重载了。通过这种手段，可以做的事情就变得很多了： </p>
<ul>
<li>热部署：不部署服务而对线上服务做修改，可以做打点、增加日志等操作。 </li>
<li>Mock：测试时候对某些服务做Mock。 </li>
<li>性能诊断工具：比如bTrace就是利用Instrument，实现无侵入地跟踪一个正在运行的JVM，监控到类和方法级别的状态信息。</li>
</ul>
<h2 id="GC-详解"><a href="#GC-详解" class="headerlink" title="GC 详解"></a>GC 详解</h2><p>JVM中GC专题（GC算法、回收器、内存泄露排查等等）</p>
<h3 id="GC简介"><a href="#GC简介" class="headerlink" title="GC简介"></a>GC简介</h3><p>垃圾回收(Garbage Collection)是Java虚拟机(JVM)垃圾回收器提供的一种用于在<label style="color:red; font-family:微软雅黑">空闲时间、不定时回收、无任何对象引用</label>的对象所占据的内存空间的一种机制。</p>
<h3 id="判断对象是否存活的算法"><a href="#判断对象是否存活的算法" class="headerlink" title="判断对象是否存活的算法"></a>判断对象是否存活的算法</h3><ol>
<li>引用计数算法（Reference Counting）</li>
</ol>
<p>给对象中添加一个引用计数器。当一个对象被创建并初始化赋值后，该变量计数设置为1。<br>每当有一个地方引用它时，计数器值就加1（a &#x3D; b， b被引用，则b引用的对象计数+1）。<br>当引用失效时（一个对象的某个引用超过了生命周期（出作用域后）或者被设置为一个新值时），计数器值就减1。任何引用计数为0的对象就是不可能再被使用的。<br><strong>缺点</strong>：对象循环引用时不可被回收。例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestA</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">A</span> <span class="variable">a1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">        <span class="type">A</span> <span class="variable">a2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">        a1.instance = a2;</span><br><span class="line">        a2.instance = a1;</span><br><span class="line">    </span><br><span class="line">        a1 = <span class="literal">null</span>;</span><br><span class="line">        a2 = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>可达性分析算法（Reachability Analysis）</li>
</ol>
<p>通过一系列名为”GC Roots”的对象作为起始点向下搜索，搜索走过的路径称为引用链，当一个对象到GC Roots没有任何引用链相连时，就证明此对象是不可用的。</p>
<p>在根搜索算法中，要真正宣告一个对象死亡，至少要经历两次标记过程：</p>
<blockquote>
<p>(1) 如果对象在进行根搜索后发现没有与GC Roots相连接的引用链，那它会被第一次标记并且进行一次筛选。筛选的条件是此对象是否有必要执行finalize()方法（可看作析构函数，类似于OC中的dealloc，Swift中的deinit）。当对象没有覆盖finalize()方法，或finalize()方法已经被虚拟机调用过，虚拟机将这两种情况都视为没有必要执行。<br> <br>(2) 如果该对象被判定为有必要执行finalize()方法，那么这个对象将会被放置在一个名为F-Queue队列中，并在稍后由一条由虚拟机自动建立的、低优先级的Finalizer线程去执行finalize()方法。finalize()方法是对象逃脱死亡命运的最后一次机会（因为一个对象的finalize()方法最多只会被系统自动调用一次），稍后GC将对F-Queue中的对象进行第二次小规模的标记，如果要在finalize()方法中成功拯救自己，只要在finalize()方法中让该对象重新引用链上的任何一个对象建立关联即可。而如果对象这时还没有关联到任何链上的引用，那它就会被回收掉。</p>
</blockquote>
<p><strong>GC Roots:</strong></p>
<ol>
<li>虚拟机栈中引用的对象</li>
<li>方法区中常量引用的对象</li>
<li>方法区中静态属性引用的变量</li>
<li>本地方法栈JNI（一般指naive方法）中引用的对象</li>
</ol>
<p>也可以理解为下面几种（引用于<a target="_blank" rel="noopener" href="http://help.eclipse.org/luna/index.jsp?topic=/org.eclipse.mat.ui.help/concepts/gcroots.html&cp=37_2_3">Help - Eclipse Platform</a>）：</p>
<ul>
<li>System Class - 由初始、系统类加载器(bootstrap&#x2F;system class loader)加载的对象</li>
<li>JNI Local - native代码中的local变量</li>
<li>JNI Global - native代码中的global变量</li>
<li>Thread Block - 活动的线程块引用的对象</li>
<li>Thread - 活着的线程</li>
<li>Busy Monitor - 调用了wait()、notify()方法的对象，同步的对象</li>
<li>Java Local - local变量</li>
<li>Native Stack - native代码中in或out参数，例如：用户定义的JNI代码或JVM内部代码。通常是这种情况，因为许多方法具有native部分，并且作为方法参数处理的对象成为GC根。</li>
<li>Finalizable - 等待finalizer运行的队列中的对象</li>
<li>Unfinalized - 具有finalize方法但尚未终止且不在finalizer队列中的对象</li>
<li>Unreachable - 从任何其他根无法访问的对象，但为了保留改对象已被MAT标记为根，否则不会包含在分析中的对象</li>
<li>Java Stack Frame - java栈帧（持有本地变量）。仅在使用首选项集解析转储时生成，以将Java堆栈帧视为对象。</li>
<li>Unknown - 未知的根类型对象。某些转储（例如IBM Portable Heap Dump文件）没有根信息。对于这些转储，MAT解析器标记没有入站引用或无法从任何其他根作为此类型的根进行访问的对象。这可确保MAT保留转储中的所有对象。</li>
</ul>
<h3 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h3><ol>
<li>强引用（Strong Reference）<br>如“Object obj &#x3D; new Object（）”，这类引用是Java程序中最普遍的。只要强引用还存在，垃圾收集器就永远不会回收掉被引用的对象。</li>
<li>软引用（Soft Reference）<br>它用来描述一些可能还有用，但并非必须的对象。在系统内存不够用时，这类引用关联的对象将被垃圾收集器回收。JDK1.2之后提供了SoftReference类来实现软引用。</li>
<li>弱引用（Weak Reference）<br>它也是用来描述非须对象的，但它的强度比软引用更弱些，被弱引用关联的对象只能生存到下一次垃圾收集发生之前。当垃圾收集器工作时，无论当前内存是否足够，都会回收掉只被弱引用关联的对象。在JDK1.2之后，提供了WeakReference类来实现弱引用。</li>
<li>虚引用（Phantom Reference）<br>最弱的一种引用关系，完全不会对其生存时间构成影响，也无法通过虚引用来取得一个对象实例。为一个对象设置虚引用关联的唯一目的是希望能在这个对象被收集器回收时收到一个系统通知。JDK1.2之后提供了PhantomReference类来实现虚引用。</li>
</ol>
<table>
<thead>
<tr>
<th align="center">引用类型</th>
<th align="center">GC回收时间</th>
<th align="center">用途</th>
<th align="center">生存时间</th>
</tr>
</thead>
<tbody><tr>
<td align="center">强引用</td>
<td align="center">Never</td>
<td align="center">-</td>
<td align="center">JVM停止运行时</td>
</tr>
<tr>
<td align="center">软引用</td>
<td align="center">内存不足时</td>
<td align="center">对象缓存</td>
<td align="center">内存不足时</td>
</tr>
<tr>
<td align="center">弱引用</td>
<td align="center">GC时</td>
<td align="center">对象缓存</td>
<td align="center">下一次GC</td>
</tr>
<tr>
<td align="center">虚引用</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody></table>
<h3 id="回收算法"><a href="#回收算法" class="headerlink" title="回收算法"></a>回收算法</h3><h4 id="标记—复制算法"><a href="#标记—复制算法" class="headerlink" title="标记—复制算法"></a>标记—复制算法</h4><p>定义：将可用内存划分成相等大小两块，每次只使用其中一块，当这一块用完后将还存活的对象复制到另一块，然后将已使用过的内存一次清理。<br>适用：存活对象较少的垃圾回收，一般用于新生代（新生代内存默认按照8:1:1分为Eden，From Survivor，To Survivor三个空间，每次浪费10%）。<br>缺点：内存缩小为原来的一半。<br>优点：每次对整个半区进行内存回收，不用考虑内存碎片问题，只要移动堆顶指针，按顺序分配内存即可；实现简单，运行高效。<br><img src="/imgs/java-jvm/%E6%A0%87%E8%AE%B0%E5%A4%8D%E5%88%B6%E5%9B%9E%E6%94%B6%E5%89%8D%E5%90%8E%E7%8A%B6%E6%80%81.png" alt="标记复制回收前后状态"></p>
<h4 id="标记—整理算法"><a href="#标记—整理算法" class="headerlink" title="标记—整理算法"></a>标记—整理算法</h4><p>定义：先标记要回收的对象，将存活对象移至一端，最后清理端边界以外的内存<br>适用：一般用于年老代<br><img src="/imgs/java-jvm/%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86%E5%9B%9E%E6%94%B6%E5%89%8D%E5%90%8E%E7%8A%B6%E6%80%81.png" alt="标记整理回收前后状态"></p>
<h4 id="标记—清除算法"><a href="#标记—清除算法" class="headerlink" title="标记—清除算法"></a>标记—清除算法</h4><p>定义：先标记要回收的对象，然后统一回收<br>适用：存活对象较多的垃圾回收<br>缺点：会产生大量不连续的内存碎片，需要定期整理<br><img src="/imgs/java-jvm/%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%E5%9B%9E%E6%94%B6%E5%89%8D%E5%90%8E%E7%8A%B6%E6%80%81.png" alt="标记清除回收前后状态"></p>
<h3 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h3><p>常见的垃圾收集器有七种，以下是关系图，连线表示可以搭配使用：<br><img src="/imgs/java-jvm/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E5%88%86%E7%B1%BB%E5%9B%BE.png" alt="垃圾回收器分类图.png"></p>
<h4 id="Serial收集器"><a href="#Serial收集器" class="headerlink" title="Serial收集器"></a>Serial收集器</h4><p>算法：标记—复制<br>用于：新生代<br>特性：单线程，在进行垃圾收集时必须暂停其他所有的工作线程（”Stop the World”）。虚拟机运行在Client模式下的默认新生代收集器。</p>
<h4 id="ParNew收集器"><a href="#ParNew收集器" class="headerlink" title="ParNew收集器"></a>ParNew收集器</h4><p>算法：标记—复制<br>用于：新生代<br>特性：并发收集，Serial收集器的多线程版本。一般是Server模式下的虚拟机中首选的新生代收集器。</p>
<h4 id="Parallel-Scavenge收集器"><a href="#Parallel-Scavenge收集器" class="headerlink" title="Parallel Scavenge收集器"></a>Parallel Scavenge收集器</h4><p>算法：标记—复制<br>用于：新生代<br>特性：并发收集，关注点与其他收集器不同，CMS等收集器的关注点是尽可能缩短垃圾收集时用户线程的停顿时间，而Parallel Scavenge收集器的目的则是达到一个可控制的吞吐量（Throughput, 吞吐量&#x3D;运行用户代码时间&#x2F;(运行用户代码时间+垃圾收集时间)），虚拟机总共运行了100分钟，其中垃圾收集花掉1分钟，吞吐量就是99%。</p>
<h4 id="Serial-Old收集器"><a href="#Serial-Old收集器" class="headerlink" title="Serial Old收集器"></a>Serial Old收集器</h4><p>算法：标记—整理<br>用于：年老代<br>特性：单线程，Serial收集器的年老代版本。主要被Client模式下的虚拟机使用。</p>
<h4 id="Parallel-Old收集器"><a href="#Parallel-Old收集器" class="headerlink" title="Parallel Old收集器"></a>Parallel Old收集器</h4><p>算法：标记—整理<br>用于：年老代<br>特性：并发收集，Parallel Scavenge收集器的年老代版本，在注重吞吐量及CPU资源敏感的场合，都可以优先考虑Parallel Scavenge + Parallel Old收集器。</p>
<h4 id="CMS收集器（Concurrent-Mark-Sweep）"><a href="#CMS收集器（Concurrent-Mark-Sweep）" class="headerlink" title="CMS收集器（Concurrent Mark Sweep）"></a>CMS收集器（Concurrent Mark Sweep）</h4><p>算法：标记—清除<br>用于：年老代<br>特性：并发收集、低停顿。以获取最短回收停顿时间为目的。当需要服务的响应速度块、系统停顿时间短，可以优先考虑ParNew + CMS收集器。<br>过程：</p>
<ul>
<li>初始标记（CMS initial mark）：需要”Stop The World”，标记GC Roots能直接关联到的对象，速度快。</li>
<li>并发标记（CMS concurrent mark）：进行GC Roots Tracing过程。</li>
<li>重新标记（CMS remark）：需要”Stop The World”，修正并发标记期间，因用户程序继续运行而导致标记产生变动的那一部分对象的标记记录。停顿时间：初始标记&lt;重新标记&lt;&lt;并发标记。</li>
<li>并发清除（CMS concurrent sweep）：清除标记后要回收的对象，时间较长。</li>
</ul>
<h4 id="G1收集器（Garbage-First）"><a href="#G1收集器（Garbage-First）" class="headerlink" title="G1收集器（Garbage First）"></a>G1收集器（Garbage First）</h4><p>算法：基于“标记-整理”<br>用于：独自管理整个Java堆内存，不需要和其他收集器配合使用<br>特性：</p>
<ul>
<li>并发收集</li>
<li>可预测的停顿时间</li>
<li>压缩空间方面有优势</li>
<li>内部依然区分新生代和年老代，但是Eden, Survivor, Old区不再固定、在内存使用效率上来说更灵活。</li>
<li>将整个Java堆（包括新生代、年老代）划分为多个大小固定的独立区域（Region），并且跟踪这些区域里面的垃圾堆积程度，在后台维护一个优先列表，每次根据允许的收集时间，优先回收垃圾最多的区域（这就是Garbage First名称的由来）。区域划分、有优先级的区域回收。<br>过程：</li>
<li>初始标记（CMS initial mark）：需要”Stop The World”，标记GC Roots能直接关联到的对象，速度快。</li>
<li>并发标记（CMS concurrent mark）：进行GC Roots Tracing过程，此过程之间可以进行年轻代收集。</li>
<li>重新标记（CMS remark）：完全标记堆中的活跃对象，使用一个叫作snapshot-at-the-beginning(SATB)的比CMS收集器的更快的算法。此过程需要一个暂停的时间，去处理剩下的SATB日志缓冲区和所有更新，找出所有未被访问的存活对象，同时安全完成存活数据计算，这个阶段也是并发执行的。</li>
<li>选择回收（CMS concurrent sweep）：根据允许的收集时间，优先回收垃圾最多的区域。</li>
</ul>
<h3 id="内存泄露"><a href="#内存泄露" class="headerlink" title="内存泄露"></a>内存泄露</h3><p>一般来说，内存泄露的发生都是因为使用不当导致的。</p>
<p>使用不当又分为：</p>
<ol>
<li>自己写出来的死循环。</li>
<li>框架使用不当。例如：Disruptor中的RingBuffer、Netty中的ByteBuf</li>
<li>使用的开源库中存在内存泄露问题。</li>
</ol>
<p>解决方案：</p>
<ol>
<li>用jstack、jstat、jmap查看线程堆栈信息，并转写出堆转储文件。</li>
<li>放到win系统中用<a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/community/groups/service/html/communityview?communityUuid=4544bafe-c7a2-455f-9d43-eb866ea60091">IBM HeapAnalyzer</a>等类似工具进行分析。</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-x-overview.html">♥JVM相关知识体系详解♥</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-class.html">JVM 基础 - 类字节码详解</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-class-enhancer.html">JVM 基础 - 字节码的增强技术</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-classload.html">JVM 基础 - Java 类加载机制</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-struct.html">JVM 基础 - JVM 内存结构</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-x-introduce.html">JVM 基础 - Java 内存模型引入</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-jmm.html">JVM 基础 - Java 内存模型详解</a><br>1、<a target="_blank" rel="noopener" href="https://www.infoq.cn/article/rhw0p6vhzoz1swcd86rw">一文讲清 JVM 内存结构 | 极客视点</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/jvm/" rel="tag"># jvm</a>
              <a href="/tags/gc/" rel="tag"># gc</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/2019/04/17/%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E3%80%81%E6%96%87%E4%BB%B6%E5%A4%B9%E2%80%94%E2%80%94%E5%88%9B%E5%BB%BA%E3%80%81%E4%BF%AE%E6%94%B9%E3%80%81%E8%AE%BF%E9%97%AE%E6%97%B6%E9%97%B4/" rel="prev" title="修改文件、文件夹——创建、修改、访问时间">
                  <i class="fa fa-chevron-left"></i> 修改文件、文件夹——创建、修改、访问时间
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/2019/05/28/protobuf%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/" rel="next" title="protobuf使用详解">
                  protobuf使用详解 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Apomelo</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.14.2/algoliasearch-lite.umd.js" integrity="sha256-dImjLPUsG/6p3+i7gVKBiDM8EemJAhQ0VvkRK2pVsQY=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.43.1/instantsearch.production.min.js" integrity="sha256-jLNoKrKRDKAOg8JBqkl8jSy2tpqCGQ1/++9QRYtWl8k=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.3/mermaid.min.js","integrity":"sha256-TIYL00Rhw/8WaoUhYTLX9SKIEFdXxg+yMWSLVUbhiLg="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"N5VN0ybf5xGuqDFhjzC5RlRL-MdYXbMMI","app_key":"ru1RlOeEotFp87wLFIHucgVu","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
