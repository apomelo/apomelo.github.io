<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"apomelo.cc","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"A3LWYBODE0","apiKey":"c40595ca0a82310430032a8bc32214a2","indexName":"apomelo","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="我有一壶酒，足以慰风尘。尽倾江海里，赠饮天下人。">
<meta property="og:type" content="website">
<meta property="og:title" content="Apomelo - 追逐">
<meta property="og:url" content="https://apomelo.cc/index.html">
<meta property="og:site_name" content="Apomelo - 追逐">
<meta property="og:description" content="我有一壶酒，足以慰风尘。尽倾江海里，赠饮天下人。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Apomelo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://apomelo.cc/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Apomelo - 追逐</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2KQDESYMZF"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-2KQDESYMZF');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6c01cfc90b27c8f2cf8c97e38b2f117c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Apomelo - 追逐</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2019/04/18/java-jvm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2019/04/18/java-jvm/" class="post-title-link" itemprop="url">JVM</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-18 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-18T00:00:00+08:00">2019-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-23 00:00:00" itemprop="dateModified" datetime="2022-07-23T00:00:00+08:00">2022-07-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/posts/2019/04/18/java-jvm/" class="post-meta-item leancloud_visitors" data-flag-title="JVM" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="JVM-简介"><a href="#JVM-简介" class="headerlink" title="JVM 简介"></a>JVM 简介</h2><p>JVM(Java虚拟机, Java virtual machine), Java虚拟机，一种能够运行Java bytecode的虚拟机，以堆栈结构机器来进行实做。最早由Sun微系统所研发并实现第一个实现版本，是Java平台的一部分，能够运行以Java语言写作的软件程序。 Java虚拟机有自己完善的硬体架构，如处理器、堆栈、寄存器等，还具有相应的指令系统。</p>
<p>Java 虚拟机是整个 Java 平台的基石，是 Java 技术用以实现硬件无关与操作系统无关的关键部分，是 Java 语言生成出极小体积的编译代码的运行平台，是保障用户机器免于恶意代码损害的保护屏障。</p>
<h3 id="历史和特性"><a href="#历史和特性" class="headerlink" title="历史和特性"></a>历史和特性</h3><p>第一个 Java 虚拟机的原型机是由 Sun Microsystems 公司实现的，它被用在一种类似 PDA（Personal Digital Assistant，俗称掌上电脑）的手持设备上仿真实现 Java 虚拟机指令集。时至今日， Oracle 已有许多 Java 虚拟机实现应用于移动设备、桌面电脑、服务器等领域。</p>
<p>Java 虚拟机并不局限于特定的<strong>实现技术、主机硬件和操作系统</strong>， Java 虚拟机也不局限于特定的<strong>代码执行方式</strong>，它不强求使用解释器来执行程序，也可以通过把自己的指令集编译为实际 CPU 的指令来实现，它可以通过微代码（Microcode）来实现，或者甚至直接实现在 CPU 中。</p>
<h2 id="JVM-知识体系总览"><a href="#JVM-知识体系总览" class="headerlink" title="JVM 知识体系总览"></a>JVM 知识体系总览</h2><h3 id="JVM-知识体系"><a href="#JVM-知识体系" class="headerlink" title="JVM 知识体系"></a>JVM 知识体系</h3><p><img src="/imgs/java-jvm/jvm%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB.png" alt="jvm知识体系"></p>
<h3 id="JVM-结构"><a href="#JVM-结构" class="headerlink" title="JVM 结构"></a>JVM 结构</h3><ol>
<li><p>类加载器（Class Loader）：加载字节码文件到内存。</p>
</li>
<li><p>运行时数据区（Runtime Data Area）：JVM 核心内存空间结构模型。</p>
</li>
<li><p>执行引擎（Execution Engine）：对 JVM 指令进行解析，翻译成机器码，解析完成后提交到操作系统中。</p>
</li>
<li><p>本地库接口（Native Interface）：供 Java 调用的融合了不同开发语言的原生库。</p>
</li>
<li><p>本地方法库（Native Libraies）：Java 本地方法的具体实现。</p>
</li>
</ol>
<p><img src="/imgs/java-jvm/jvm%E7%BB%93%E6%9E%84.png" alt="jvm结构"></p>
<h3 id="JVM-问题分析与定位"><a href="#JVM-问题分析与定位" class="headerlink" title="JVM 问题分析与定位"></a>JVM 问题分析与定位</h3><p><img src="/imgs/java-jvm/jvm%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9A%E4%BD%8D.png" alt="jvm问题分析与定位"></p>
<h2 id="字节码详解"><a href="#字节码详解" class="headerlink" title="字节码详解"></a>字节码详解</h2><h3 id="字节码编译"><a href="#字节码编译" class="headerlink" title="字节码编译"></a>字节码编译</h3><p>计算机不能直接运行java代码，必须要先把java代码文件（ .java文件）编译为字节码文件（.class文件），接着运行java虚拟机，再由java虚拟机运行编译后的字节码文件。</p>
<p>Java代码间接翻译成字节码，储存字节码的文件再交由运行于不同平台上的JVM虚拟机去读取执行，从而实现一次编写，到处运行的目的。 </p>
<p>JVM也不再只支持Java，由此衍生出了许多基于JVM的编程语言，如Groovy, Scala, Koltin等等。</p>
<h3 id="字节码文件"><a href="#字节码文件" class="headerlink" title="字节码文件"></a>字节码文件</h3><p>class文件本质上是一个以8位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑的排列在class文件中。jvm根据其特定的规则解析该二进制数据，从而得到相关信息。</p>
<p>Class文件采用一种伪结构来存储数据，它有两种类型：无符号数和表。</p>
<h4 id="反编译字节码文件"><a href="#反编译字节码文件" class="headerlink" title="反编译字节码文件"></a>反编译字节码文件</h4><p>使用到java内置的一个反编译工具javap可以反编译字节码文件, 用法: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap &lt;options&gt; &lt;classes&gt;</span><br></pre></td></tr></table></figure>

<p>其中<code>&lt;options&gt;</code>选项包括:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-<span class="built_in">help</span>  --<span class="built_in">help</span>  -?        输出此用法消息</span><br><span class="line">-version                 版本信息</span><br><span class="line">-v  -verbose             输出附加信息</span><br><span class="line">-l                       输出行号和本地变量表</span><br><span class="line">-public                  仅显示 public 类和成员</span><br><span class="line">-protected               显示 protected/public 类和成员</span><br><span class="line">-package                 显示 package/protected/public 类</span><br><span class="line">                         和成员 (默认)</span><br><span class="line">-p  -private             显示所有类和成员</span><br><span class="line">-c                       对代码进行反汇编</span><br><span class="line">-s                       输出内部类型签名</span><br><span class="line">-sysinfo                 显示正在处理的类的</span><br><span class="line">                         系统信息 (路径, 大小, 日期, MD5 散列)</span><br><span class="line">-constants               显示最终常量</span><br><span class="line">-classpath &lt;path&gt;        指定查找用户类文件的位置</span><br><span class="line">-cp &lt;path&gt;               指定查找用户类文件的位置</span><br><span class="line">-bootclasspath &lt;path&gt;    覆盖引导类文件的位置</span><br></pre></td></tr></table></figure>

<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>下面以一个简单的例子来逐步认识字节码。</p>
<h5 id="java源文件"><a href="#java源文件" class="headerlink" title="java源文件"></a>java源文件</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.javap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/7/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">inc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            x = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            x = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            x = <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="生成class文件"><a href="#生成class文件" class="headerlink" title="生成class文件"></a>生成class文件</h5><p>通过以下命令, 可以在当前所在路径下生成一个Main.class文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Main.java</span><br></pre></td></tr></table></figure>

<p>以文本的形式打开生成的class文件，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cafe babe <span class="number">0000</span> <span class="number">0034</span> <span class="number">0025</span> 0a00 <span class="number">0500</span> 1f09</span><br><span class="line"><span class="number">0004</span> <span class="number">0020</span> <span class="number">0700</span> <span class="number">2107</span> <span class="number">0022</span> <span class="number">0700</span> <span class="number">2301</span> <span class="number">0001</span></span><br><span class="line">6d01 <span class="number">0001</span> <span class="number">4901</span> <span class="number">0006</span> 3c69 <span class="number">6e69</span> 743e <span class="number">0100</span></span><br><span class="line">0328 <span class="number">2956</span> <span class="number">0100</span> <span class="number">0443</span> 6f64 <span class="number">6501</span> <span class="number">000f</span> 4c69</span><br><span class="line"><span class="number">6e65</span> <span class="number">4e75</span> 6d62 <span class="number">6572</span> <span class="number">5461</span> 626c <span class="number">6501</span> <span class="number">0012</span></span><br><span class="line">4c6f <span class="number">6361</span> 6c56 <span class="number">6172</span> <span class="number">6961</span> 626c <span class="number">6554</span> <span class="number">6162</span></span><br><span class="line">6c65 <span class="number">0100</span> <span class="number">0474</span> <span class="number">6869</span> <span class="number">7301</span> <span class="number">0011</span> 4c74 <span class="number">6573</span></span><br><span class="line"><span class="number">742f</span> 6a61 <span class="number">7661</span> <span class="number">702f</span> 4d61 696e 3b01 <span class="number">0004</span></span><br><span class="line">6d61 696e <span class="number">0100</span> <span class="number">1628</span> 5b4c 6a61 <span class="number">7661</span> 2f6c</span><br><span class="line">616e <span class="number">672f</span> <span class="number">5374</span> <span class="number">7269</span> <span class="number">6e67</span> 3b29 <span class="number">5601</span> <span class="number">0004</span></span><br><span class="line"><span class="number">6172</span> <span class="number">6773</span> <span class="number">0100</span> 135b 4c6a <span class="number">6176</span> <span class="number">612f</span> 6c61</span><br><span class="line"><span class="number">6e67</span> 2f53 <span class="number">7472</span> 696e 673b <span class="number">0100</span> <span class="number">104d</span> <span class="number">6574</span></span><br><span class="line"><span class="number">686f</span> <span class="number">6450</span> <span class="number">6172</span> <span class="number">616d</span> <span class="number">6574</span> <span class="number">6572</span> <span class="number">7301</span> <span class="number">0003</span></span><br><span class="line">696e <span class="number">6301</span> <span class="number">0003</span> <span class="number">2829</span> <span class="number">4901</span> <span class="number">0003</span> <span class="number">666f</span> 6f01</span><br><span class="line"><span class="number">0001</span> <span class="number">7801</span> <span class="number">0001</span> <span class="number">6501</span> <span class="number">0015</span> 4c6a <span class="number">6176</span> <span class="number">612f</span></span><br><span class="line">6c61 <span class="number">6e67</span> 2f45 <span class="number">7863</span> <span class="number">6570</span> <span class="number">7469</span> 6f6e 3b01</span><br><span class="line"><span class="number">000d</span> <span class="number">5374</span> <span class="number">6163</span> 6b4d <span class="number">6170</span> <span class="number">5461</span> 626c <span class="number">6507</span></span><br><span class="line"><span class="number">0021</span> <span class="number">0700</span> <span class="number">2401</span> 000a <span class="number">536f</span> <span class="number">7572</span> <span class="number">6365</span> <span class="number">4669</span></span><br><span class="line">6c65 <span class="number">0100</span> <span class="number">094d</span> <span class="number">6169</span> 6e2e 6a61 <span class="number">7661</span> 0c00</span><br><span class="line">0800 090c <span class="number">0006</span> <span class="number">0007</span> <span class="number">0100</span> 136a <span class="number">6176</span> <span class="number">612f</span></span><br><span class="line">6c61 <span class="number">6e67</span> 2f45 <span class="number">7863</span> <span class="number">6570</span> <span class="number">7469</span> 6f6e <span class="number">0100</span></span><br><span class="line">0f74 <span class="number">6573</span> <span class="number">742f</span> 6a61 <span class="number">7661</span> <span class="number">702f</span> 4d61 696e</span><br><span class="line"><span class="number">0100</span> 106a <span class="number">6176</span> <span class="number">612f</span> 6c61 <span class="number">6e67</span> 2f4f 626a</span><br><span class="line"><span class="number">6563</span> <span class="number">7401</span> <span class="number">0013</span> 6a61 <span class="number">7661</span> 2f6c 616e <span class="number">672f</span></span><br><span class="line"><span class="number">5468</span> <span class="number">726f</span> <span class="number">7761</span> 626c <span class="number">6500</span> <span class="number">2100</span> <span class="number">0400</span> <span class="number">0500</span></span><br><span class="line"><span class="number">0000</span> <span class="number">0100</span> <span class="number">0200</span> <span class="number">0600</span> <span class="number">0700</span> <span class="number">0000</span> <span class="number">0400</span> <span class="number">0100</span></span><br><span class="line">0800 0900 <span class="number">0100</span> 0a00 <span class="number">0000</span> 2f00 <span class="number">0100</span> <span class="number">0100</span></span><br><span class="line"><span class="number">0000</span> 052a b700 01b1 <span class="number">0000</span> <span class="number">0002</span> 000b <span class="number">0000</span></span><br><span class="line"><span class="number">0006</span> <span class="number">0001</span> <span class="number">0000</span> <span class="number">0007</span> 000c <span class="number">0000</span> 000c <span class="number">0001</span></span><br><span class="line"><span class="number">0000</span> <span class="number">0005</span> <span class="number">000d</span> 000e <span class="number">0000</span> 0009 <span class="number">000f</span> <span class="number">0010</span></span><br><span class="line"><span class="number">0002</span> 000a <span class="number">0000</span> 002b <span class="number">0000</span> <span class="number">0001</span> <span class="number">0000</span> <span class="number">0001</span></span><br><span class="line">b100 <span class="number">0000</span> <span class="number">0200</span> <span class="number">0b00</span> <span class="number">0000</span> <span class="number">0600</span> <span class="number">0100</span> <span class="number">0000</span></span><br><span class="line"><span class="number">0b00</span> 0c00 <span class="number">0000</span> 0c00 <span class="number">0100</span> <span class="number">0000</span> <span class="number">0100</span> <span class="number">1100</span></span><br><span class="line"><span class="number">1200</span> <span class="number">0000</span> <span class="number">1300</span> <span class="number">0000</span> <span class="number">0501</span> <span class="number">0011</span> <span class="number">0000</span> <span class="number">0001</span></span><br><span class="line"><span class="number">0014</span> <span class="number">0015</span> <span class="number">0001</span> 000a <span class="number">0000</span> <span class="number">0031</span> <span class="number">0002</span> <span class="number">0001</span></span><br><span class="line"><span class="number">0000</span> <span class="number">0007</span> 2ab4 <span class="number">0002</span> <span class="number">0460</span> ac00 <span class="number">0000</span> <span class="number">0200</span></span><br><span class="line"><span class="number">0b00</span> <span class="number">0000</span> <span class="number">0600</span> <span class="number">0100</span> <span class="number">0000</span> <span class="number">0e00</span> 0c00 <span class="number">0000</span></span><br><span class="line">0c00 <span class="number">0100</span> <span class="number">0000</span> <span class="number">0700</span> 0d00 <span class="number">0e00</span> <span class="number">0000</span> <span class="number">0100</span></span><br><span class="line"><span class="number">1600</span> <span class="number">1500</span> <span class="number">0100</span> 0a00 <span class="number">0000</span> c200 <span class="number">0100</span> <span class="number">0500</span></span><br><span class="line"><span class="number">0000</span> <span class="number">1804</span> 3c1b 3d06 3c1c ac4d 053c 1b3e</span><br><span class="line">063c 1dac 3a04 063c <span class="number">1904</span> bf00 <span class="number">0400</span> <span class="number">0000</span></span><br><span class="line"><span class="number">0400</span> 0800 <span class="number">0300</span> <span class="number">0000</span> <span class="number">0400</span> <span class="number">1100</span> <span class="number">0000</span> 0800</span><br><span class="line">0d00 <span class="number">1100</span> <span class="number">0000</span> <span class="number">1100</span> <span class="number">1300</span> <span class="number">1100</span> <span class="number">0000</span> <span class="number">0300</span></span><br><span class="line"><span class="number">0b00</span> <span class="number">0000</span> <span class="number">2e00</span> <span class="number">0b00</span> <span class="number">0000</span> <span class="number">1400</span> <span class="number">0200</span> <span class="number">1500</span></span><br><span class="line"><span class="number">0400</span> 1a00 <span class="number">0600</span> <span class="number">1500</span> 0800 <span class="number">1600</span> 0900 <span class="number">1700</span></span><br><span class="line"><span class="number">0b00</span> <span class="number">1800</span> 0d00 1a00 0f00 <span class="number">1800</span> <span class="number">1100</span> 1a00</span><br><span class="line"><span class="number">1500</span> 1b00 0c00 <span class="number">0000</span> <span class="number">3400</span> <span class="number">0500</span> <span class="number">0200</span> <span class="number">0600</span></span><br><span class="line"><span class="number">1700</span> <span class="number">0700</span> <span class="number">0100</span> 0900 0800 <span class="number">1800</span> <span class="number">1900</span> <span class="number">0200</span></span><br><span class="line"><span class="number">0b00</span> <span class="number">0600</span> <span class="number">1700</span> <span class="number">0700</span> <span class="number">0100</span> <span class="number">0000</span> <span class="number">1800</span> 0d00</span><br><span class="line"><span class="number">0e00</span> <span class="number">0000</span> <span class="number">1500</span> <span class="number">0300</span> <span class="number">1700</span> <span class="number">0700</span> <span class="number">0100</span> 1a00</span><br><span class="line"><span class="number">0000</span> 0a00 0248 <span class="number">0700</span> 1b48 <span class="number">0700</span> 1c00 <span class="number">0100</span></span><br><span class="line">1d00 <span class="number">0000</span> <span class="number">0200</span> 1e</span><br></pre></td></tr></table></figure>

<h5 id="反编译class文件"><a href="#反编译class文件" class="headerlink" title="反编译class文件"></a>反编译class文件</h5><p>输入命令 <code>javap -verbose -p Main.class</code> 查看输出内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">Classfile /D:/Project/test/javap/Main.class</span><br><span class="line">  Last modified <span class="number">2022</span>-<span class="number">7</span>-<span class="number">29</span>; size <span class="number">823</span> bytes</span><br><span class="line">  MD5 checksum 690a2c3b12765481dadabc27d3967ca7</span><br><span class="line">  Compiled from <span class="string">&quot;Main.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span>.<span class="title">javap</span>.<span class="title">Main</span></span></span><br><span class="line"><span class="class">  <span class="title">minor</span> <span class="title">version</span>: 0</span></span><br><span class="line"><span class="class">  <span class="title">major</span> <span class="title">version</span>: 52</span></span><br><span class="line"><span class="class">  <span class="title">flags</span>: <span class="title">ACC_PUBLIC</span>, <span class="title">ACC_SUPER</span></span></span><br><span class="line"><span class="class"><span class="title">Constant</span> <span class="title">pool</span>:</span></span><br><span class="line"><span class="class">   #1 </span>= Methodref          #<span class="number">5.</span>#<span class="number">31</span>         <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">2</span> = Fieldref           #<span class="number">4.</span>#<span class="number">32</span>         <span class="comment">// test/javap/Main.m:I</span></span><br><span class="line">   #<span class="number">3</span> = Class              #<span class="number">33</span>            <span class="comment">// java/lang/Exception</span></span><br><span class="line">   #<span class="number">4</span> = Class              #<span class="number">34</span>            <span class="comment">// test/javap/Main</span></span><br><span class="line">   #<span class="number">5</span> = Class              #<span class="number">35</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">   #<span class="number">6</span> = Utf8               m</span><br><span class="line">   #<span class="number">7</span> = Utf8               I</span><br><span class="line">   #<span class="number">8</span> = Utf8               &lt;init&gt;</span><br><span class="line">   #<span class="number">9</span> = Utf8               ()V</span><br><span class="line">  #<span class="number">10</span> = Utf8               Code</span><br><span class="line">  #<span class="number">11</span> = Utf8               LineNumberTable</span><br><span class="line">  #<span class="number">12</span> = Utf8               LocalVariableTable</span><br><span class="line">  #<span class="number">13</span> = Utf8               <span class="keyword">this</span></span><br><span class="line">  #<span class="number">14</span> = Utf8               Ltest/javap/Main;</span><br><span class="line">  #<span class="number">15</span> = Utf8               main</span><br><span class="line">  #<span class="number">16</span> = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #<span class="number">17</span> = Utf8               args</span><br><span class="line">  #<span class="number">18</span> = Utf8               [Ljava/lang/String;</span><br><span class="line">  #<span class="number">19</span> = Utf8               MethodParameters</span><br><span class="line">  #<span class="number">20</span> = Utf8               inc</span><br><span class="line">  #<span class="number">21</span> = Utf8               ()I</span><br><span class="line">  #<span class="number">22</span> = Utf8               foo</span><br><span class="line">  #<span class="number">23</span> = Utf8               x</span><br><span class="line">  #<span class="number">24</span> = Utf8               e</span><br><span class="line">  #<span class="number">25</span> = Utf8               Ljava/lang/Exception;</span><br><span class="line">  #<span class="number">26</span> = Utf8               StackMapTable</span><br><span class="line">  #<span class="number">27</span> = Class              #<span class="number">33</span>            <span class="comment">// java/lang/Exception</span></span><br><span class="line">  #<span class="number">28</span> = Class              #<span class="number">36</span>            <span class="comment">// java/lang/Throwable</span></span><br><span class="line">  #<span class="number">29</span> = Utf8               SourceFile</span><br><span class="line">  #<span class="number">30</span> = Utf8               Main.java</span><br><span class="line">  #<span class="number">31</span> = NameAndType        #<span class="number">8</span>:#<span class="number">9</span>          <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">32</span> = NameAndType        #<span class="number">6</span>:#<span class="number">7</span>          <span class="comment">// m:I</span></span><br><span class="line">  #<span class="number">33</span> = Utf8               java/lang/Exception</span><br><span class="line">  #<span class="number">34</span> = Utf8               test/javap/Main</span><br><span class="line">  #<span class="number">35</span> = Utf8               java/lang/Object</span><br><span class="line">  #<span class="number">36</span> = Utf8               java/lang/Throwable</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> m;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_PRIVATE</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> test.javap.Main();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">7</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="keyword">this</span>   Ltest/javap/Main;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">0</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">11</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>  args   [Ljava/lang/String;</span><br><span class="line">    MethodParameters:</span><br><span class="line">      <span class="function">Name                           Flags</span></span><br><span class="line"><span class="function">      args</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">inc</span><span class="params">()</span></span>;</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: getfield      #<span class="number">2</span>                  <span class="comment">// Field m:I</span></span><br><span class="line">         <span class="number">4</span>: iconst_1</span><br><span class="line">         <span class="number">5</span>: iadd</span><br><span class="line">         <span class="number">6</span>: ireturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">14</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">7</span>     <span class="number">0</span>  <span class="keyword">this</span>   Ltest/javap/Main;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">5</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: iconst_1</span><br><span class="line">         <span class="number">1</span>: istore_1</span><br><span class="line">         <span class="number">2</span>: iload_1</span><br><span class="line">         <span class="number">3</span>: istore_2</span><br><span class="line">         <span class="number">4</span>: iconst_3</span><br><span class="line">         <span class="number">5</span>: istore_1</span><br><span class="line">         <span class="number">6</span>: iload_2</span><br><span class="line">         <span class="number">7</span>: ireturn</span><br><span class="line">         <span class="number">8</span>: astore_2</span><br><span class="line">         <span class="number">9</span>: iconst_2</span><br><span class="line">        <span class="number">10</span>: istore_1</span><br><span class="line">        <span class="number">11</span>: iload_1</span><br><span class="line">        <span class="number">12</span>: istore_3</span><br><span class="line">        <span class="number">13</span>: iconst_3</span><br><span class="line">        <span class="number">14</span>: istore_1</span><br><span class="line">        <span class="number">15</span>: iload_3</span><br><span class="line">        <span class="number">16</span>: ireturn</span><br><span class="line">        <span class="number">17</span>: astore        <span class="number">4</span></span><br><span class="line">        <span class="number">19</span>: iconst_3</span><br><span class="line">        <span class="number">20</span>: istore_1</span><br><span class="line">        <span class="number">21</span>: aload         <span class="number">4</span></span><br><span class="line">        <span class="number">23</span>: athrow</span><br><span class="line">      Exception table:</span><br><span class="line">         from    to  target type</span><br><span class="line">             <span class="number">0</span>     <span class="number">4</span>     <span class="number">8</span>   Class java/lang/Exception</span><br><span class="line">             <span class="number">0</span>     <span class="number">4</span>    <span class="number">17</span>   any</span><br><span class="line">             <span class="number">8</span>    <span class="number">13</span>    <span class="number">17</span>   any</span><br><span class="line">            <span class="number">17</span>    <span class="number">19</span>    <span class="number">17</span>   any</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">20</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">21</span>: <span class="number">2</span></span><br><span class="line">        line <span class="number">26</span>: <span class="number">4</span></span><br><span class="line">        line <span class="number">21</span>: <span class="number">6</span></span><br><span class="line">        line <span class="number">22</span>: <span class="number">8</span></span><br><span class="line">        line <span class="number">23</span>: <span class="number">9</span></span><br><span class="line">        line <span class="number">24</span>: <span class="number">11</span></span><br><span class="line">        line <span class="number">26</span>: <span class="number">13</span></span><br><span class="line">        line <span class="number">24</span>: <span class="number">15</span></span><br><span class="line">        line <span class="number">26</span>: <span class="number">17</span></span><br><span class="line">        line <span class="number">27</span>: <span class="number">21</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">2</span>       <span class="number">6</span>     <span class="number">1</span>     x   I</span><br><span class="line">            <span class="number">9</span>       <span class="number">8</span>     <span class="number">2</span>     e   Ljava/lang/Exception;</span><br><span class="line">           <span class="number">11</span>       <span class="number">6</span>     <span class="number">1</span>     x   I</span><br><span class="line">            <span class="number">0</span>      <span class="number">24</span>     <span class="number">0</span>  <span class="keyword">this</span>   Ltest/javap/Main;</span><br><span class="line">           <span class="number">21</span>       <span class="number">3</span>     <span class="number">1</span>     x   I</span><br><span class="line">      StackMapTable: number_of_entries = <span class="number">2</span></span><br><span class="line">        frame_type = <span class="number">72</span> <span class="comment">/* same_locals_1_stack_item */</span></span><br><span class="line">          stack = [ <span class="class"><span class="keyword">class</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Exception</span> ]</span></span><br><span class="line"><span class="class">        <span class="title">frame_type</span> </span>= <span class="number">72</span> <span class="comment">/* same_locals_1_stack_item */</span></span><br><span class="line">          stack = [ <span class="class"><span class="keyword">class</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Throwable</span> ]</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"><span class="title">SourceFile</span>: &quot;<span class="title">Main</span>.<span class="title">java</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Class文件结构"><a href="#Class文件结构" class="headerlink" title="Class文件结构"></a>Class文件结构</h4><p><img src="/imgs/java-jvm/jvm-class%E7%BB%93%E6%9E%84.png" alt="jvm-class结构"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4              magic;                                 <span class="comment">//Class 文件的标志</span></span><br><span class="line">    u2              minor_version;                         <span class="comment">//Class 的小版本号</span></span><br><span class="line">    u2              major_version;                         <span class="comment">//Class 的大版本号</span></span><br><span class="line">    u2              constant_pool_count;                   <span class="comment">//常量池的数量</span></span><br><span class="line">    cp_info         constant_pool[constant_pool_count-<span class="number">1</span>];  <span class="comment">//常量池</span></span><br><span class="line">    u2              access_flags;                          <span class="comment">//Class 的访问标记</span></span><br><span class="line">    u2              this_class;                            <span class="comment">//当前类</span></span><br><span class="line">    u2              super_class;                           <span class="comment">//父类</span></span><br><span class="line">    u2              interfaces_count;                      <span class="comment">//接口</span></span><br><span class="line">    u2              interfaces[interfaces_count];          <span class="comment">//一个类可以实现多个接口</span></span><br><span class="line">    u2              fields_count;                          <span class="comment">//Class 文件的字段属性</span></span><br><span class="line">    field_info      fields[fields_count];                  <span class="comment">//一个类会可以有个字段</span></span><br><span class="line">    u2              methods_count;                         <span class="comment">//Class 文件的方法数量</span></span><br><span class="line">    method_info     methods[methods_count];                <span class="comment">//一个类可以有个多个方法</span></span><br><span class="line">    u2              attributes_count;                      <span class="comment">//此类的属性表中的属性数</span></span><br><span class="line">    attribute_info  attributes[attributes_count];          <span class="comment">//属性表集合</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>每个 Class 文件的头 4 个字节称为魔数（magic），它的值固定为 0xCAFEBABE，唯有以”cafe babe”开头的class文件方可被虚拟机所接受，这4个字节就是字节码文件的身份识别。</li>
<li>紧接着magic之后的四个字节存储的是 Class 文件的次版本号和主版本号。例如 java 1.8.0_131-b11 对应的4个字节是 0x00000034，0000是编译器jdk版本的次版本号0，0034转化为十进制是52，是主版本号。</li>
</ol>
<h4 id="文件信息"><a href="#文件信息" class="headerlink" title="文件信息"></a>文件信息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Classfile /D:/Project/test/javap/Main.class</span><br><span class="line">  Last modified <span class="number">2022</span>-<span class="number">7</span>-<span class="number">29</span>; size <span class="number">823</span> bytes</span><br><span class="line">  MD5 checksum 690a2c3b12765481dadabc27d3967ca7</span><br><span class="line">  Compiled from <span class="string">&quot;Main.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span>.<span class="title">javap</span>.<span class="title">Main</span></span></span><br><span class="line"><span class="class">  <span class="title">minor</span> <span class="title">version</span>: 0</span></span><br><span class="line"><span class="class">  <span class="title">major</span> <span class="title">version</span>: 52</span></span><br><span class="line"><span class="class">  <span class="title">flags</span>: <span class="title">ACC_PUBLIC</span>, <span class="title">ACC_SUPER</span></span></span><br></pre></td></tr></table></figure>

<p>开头的7行信息包括:Class文件当前所在位置，最后修改时间和文件大小，MD5值，编译自哪个文件，类的全限定名，jdk次版本号，主版本号。 </p>
<p>紧接着的是该类的访问标志：ACC_PUBLIC, ACC_SUPER, 访问标志的含义如下:</p>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>标志值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>是否为Public类型</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
<td>是否被声明为final，只有类可以设置</td>
</tr>
<tr>
<td>ACC_SUPER</td>
<td>0x0020</td>
<td>是否允许使用invokespecial字节码指令的新语义．</td>
</tr>
<tr>
<td>ACC_INTERFACE</td>
<td>0x0200</td>
<td>标志这是一个接口</td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x0400</td>
<td>是否为abstract类型，对于接口或者抽象类来说，次标志值为真，其他类型为假</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>标志这个类并非由用户代码产生</td>
</tr>
<tr>
<td>ACC_ANNOTATION</td>
<td>0x2000</td>
<td>标志这是一个注解</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>标志这是一个枚举</td>
</tr>
</tbody></table>
<h4 id="常量池"><a href="#常量池" class="headerlink" title="常量池"></a>常量池</h4><p><code>Constant pool</code> 意为常量池。</p>
<p>常量池可以理解成Class文件中的资源仓库。主要存放的是两大类常量：字面量(Literal)和符号引用(Symbolic References)。字面量类似于java中的常量概念，如文本字符串，final常量等，而符号引用则属于编译原理方面的概念，包括以下三种: </p>
<ul>
<li>类和接口的全限定名(Fully Qualified Name) </li>
<li>字段的名称和描述符号(Descriptor) </li>
<li>方法的名称和描述符</li>
</ul>
<p>对照反编译文件分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">1</span> = Methodref          #<span class="number">5.</span>#<span class="number">31</span>         <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">5</span> = Class              #<span class="number">35</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">   #<span class="number">8</span> = Utf8               &lt;init&gt;</span><br><span class="line">   #<span class="number">9</span> = Utf8               ()V</span><br><span class="line">  #<span class="number">31</span> = NameAndType        #<span class="number">8</span>:#<span class="number">9</span>          <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">35</span> = Utf8               java/lang/Object</span><br></pre></td></tr></table></figure>

<p>第一个常量是一个方法定义，指向了第4和第18个常量。以此类推查看第4和第18个常量。最后可以拼接成第一个常量右侧的注释内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java/lang/Object.<span class="string">&quot;&lt;init&gt;&quot;</span>:()V </span><br></pre></td></tr></table></figure>

<p>这段可以理解为该类的实例构造器的声明，由于Main类没有重写构造方法，所以调用的是父类的构造方法。此处也说明了Main类的直接父类是Object。 该方法默认返回值是V, 也就是void，无返回值。</p>
<p>第二个常量同理可得:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> #<span class="number">2</span> = Fieldref           #<span class="number">4.</span>#<span class="number">32</span>         <span class="comment">// test/javap/Main.m:I</span></span><br><span class="line"> #<span class="number">4</span> = Class              #<span class="number">34</span>            <span class="comment">// test/javap/Main</span></span><br><span class="line"> #<span class="number">6</span> = Utf8               m</span><br><span class="line"> #<span class="number">7</span> = Utf8               I</span><br><span class="line">#<span class="number">32</span> = NameAndType        #<span class="number">6</span>:#<span class="number">7</span>          <span class="comment">// m:I</span></span><br><span class="line">#<span class="number">34</span> = Utf8               test/javap/Main</span><br></pre></td></tr></table></figure>

<p>复制代码此处声明了一个字段m，类型为I, I即是int类型。</p>
<h5 id="字节码的类型对应"><a href="#字节码的类型对应" class="headerlink" title="字节码的类型对应"></a>字节码的类型对应</h5><table>
<thead>
<tr>
<th>标识字符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>B</td>
<td>基本类型byte</td>
</tr>
<tr>
<td>C</td>
<td>基本类型char</td>
</tr>
<tr>
<td>D</td>
<td>基本类型double</td>
</tr>
<tr>
<td>F</td>
<td>基本类型float</td>
</tr>
<tr>
<td>I</td>
<td>基本类型int</td>
</tr>
<tr>
<td>J</td>
<td>基本类型long</td>
</tr>
<tr>
<td>S</td>
<td>基本类型short</td>
</tr>
<tr>
<td>Z</td>
<td>基本类型boolean</td>
</tr>
<tr>
<td>V</td>
<td>特殊类型void</td>
</tr>
<tr>
<td>L</td>
<td>对象类型，以分号结尾，如Ljava/lang/Object;</td>
</tr>
</tbody></table>
<p>对于数组类型，每一位使用一个前置的 <code>[</code> 字符来描述，如定义一个 <code>java.lang.String[][]</code> 类型的维数组，将被记录为 <code>[[Ljava/lang/String;</code></p>
<h4 id="方法表集合"><a href="#方法表集合" class="headerlink" title="方法表集合"></a>方法表集合</h4><p>在常量池之后的是对类内部的方法描述，在字节码中以表的集合形式表现，暂且不管字节码文件的16进制文件内容如何，我们直接看反编译后的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此处声明了一个私有变量m，类型为int，返回值为int</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> m;</span><br><span class="line">  descriptor: I</span><br><span class="line">  flags: ACC_PRIVATE</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里是构造方法：Main()，返回值为void, public方法</span></span><br><span class="line"><span class="keyword">public</span> test.javap.Main();</span><br><span class="line">  descriptor: ()V</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">       <span class="number">0</span>: aload_0</span><br><span class="line">       <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">       <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line <span class="number">7</span>: <span class="number">0</span></span><br><span class="line">    LocalVariableTable:</span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="keyword">this</span>   Ltest/javap/Main;</span><br></pre></td></tr></table></figure>

<p>code内的主要属性为: </p>
<ul>
<li>stack: 最大操作数栈，JVM运行时会根据这个值来分配栈帧(Frame)中的操作栈深度,此处为1 </li>
<li>locals: 局部变量所需的存储空间，单位为Slot, Slot是虚拟机为局部变量分配内存时所使用的最小单位，为4个字节大小。方法参数(包括实例方法中的隐藏参数this)，显示异常处理器的参数(try catch中的catch块所定义的异常)，方法体中定义的局部变量都需要使用局部变量表来存放。值得一提的是，locals的大小并不一定等于所有局部变量所占的Slot之和，因为局部变量中的Slot是可以重用的。 </li>
<li>args_size: 方法参数的个数，这里是1，因为每个实例方法都会有一个隐藏参数this attribute_info: 方法体内容，0,1,4为字节码”行号”，该段代码的意思是将第一个引用类型本地变量推送至栈顶，然后执行该类型的实例方法，也就是常量池存放的第一个变量，也就是注释里的java/lang/Object.””:()V, 然后执行返回语句，结束方法。 </li>
<li>LineNumberTable: 该属性的作用是描述源码行号与字节码行号(字节码偏移量)之间的对应关系。可以使用 -g:none 或-g:lines选项来取消或要求生成这项信息，如果选择不生成LineNumberTable，当程序运行异常时将无法获取到发生异常的源码行号，也无法按照源码的行数来调试程序。 </li>
<li>LocalVariableTable: 该属性的作用是描述帧栈中局部变量与源码中定义的变量之间的关系。可以使用 -g:none 或 -g:vars来取消或生成这项信息，如果没有生成这项信息，那么当别人引用这个方法时，将无法获取到参数名称，取而代之的是arg0, arg1这样的占位符。start 表示该局部变量在哪一行开始可见，length 表示可见行数，Slot 代表所在帧栈位置，Name 是变量名称，然后是类型签名。</li>
</ul>
<p>同理可以分析Main类中的另一个方法”inc()”:</p>
<p>方法体内的内容是：将this入栈，获取字段#2并置于栈顶, 将int类型的1入栈，将栈内顶部的两个数值相加，返回一个int类型的值。</p>
<h4 id="类名"><a href="#类名" class="headerlink" title="类名"></a>类名</h4><p>最后很显然是源码文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SourceFile: <span class="string">&quot;Main.java&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="分析try-catch-finally"><a href="#分析try-catch-finally" class="headerlink" title="分析try-catch-finally"></a>分析try-catch-finally</h4><p>分析上面示例中的方法 foo()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line">  descriptor: ()I</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=<span class="number">1</span>, locals=<span class="number">5</span>, args_size=<span class="number">1</span></span><br><span class="line">       <span class="number">0</span>: iconst_1  <span class="comment">//int型1入栈 -&gt;栈顶=1</span></span><br><span class="line">       <span class="number">1</span>: istore_1  <span class="comment">//将栈顶的int型数值存入第二个局部变量 -&gt;局部2=1</span></span><br><span class="line">       <span class="number">2</span>: iload_1   <span class="comment">//将第二个int型局部变量推送至栈顶 -&gt;栈顶=1</span></span><br><span class="line">       <span class="number">3</span>: istore_2  <span class="comment">//!!将栈顶int型数值存入第三个局部变量 -&gt;局部3=1</span></span><br><span class="line"></span><br><span class="line">       <span class="number">4</span>: iconst_3  <span class="comment">//int型3入栈 -&gt;栈顶=3</span></span><br><span class="line">       <span class="number">5</span>: istore_1  <span class="comment">//将栈顶的int型数值存入第二个局部变量 -&gt;局部2=3</span></span><br><span class="line">       <span class="number">6</span>: iload_2   <span class="comment">//!!将第三个int型局部变量推送至栈顶 -&gt;栈顶=1</span></span><br><span class="line">       <span class="number">7</span>: ireturn   <span class="comment">//从当前方法返回栈顶int数值 -&gt;1</span></span><br><span class="line"></span><br><span class="line">       <span class="number">8</span>: astore_2  <span class="comment">// -&gt;局部3=Exception</span></span><br><span class="line">       <span class="number">9</span>: iconst_2  <span class="comment">// -&gt;栈顶=2</span></span><br><span class="line">      <span class="number">10</span>: istore_1  <span class="comment">// -&gt;局部2=2</span></span><br><span class="line">      <span class="number">11</span>: iload_1   <span class="comment">// -&gt;栈顶=2</span></span><br><span class="line">      <span class="number">12</span>: istore_3  <span class="comment">//!! -&gt;局部4=2</span></span><br><span class="line"></span><br><span class="line">      <span class="number">13</span>: iconst_3  <span class="comment">// -&gt;栈顶=3</span></span><br><span class="line">      <span class="number">14</span>: istore_1  <span class="comment">// -&gt;局部1=3</span></span><br><span class="line">      <span class="number">15</span>: iload_3   <span class="comment">//!! -&gt;栈顶=2</span></span><br><span class="line">      <span class="number">16</span>: ireturn   <span class="comment">// -&gt; 2</span></span><br><span class="line"></span><br><span class="line">      <span class="number">17</span>: astore        <span class="number">4</span>  <span class="comment">//将栈顶引用型数值存入第五个局部变量=any</span></span><br><span class="line">      <span class="number">19</span>: iconst_3         <span class="comment">//将int型数值3入栈 -&gt; 栈顶3</span></span><br><span class="line">      <span class="number">20</span>: istore_1         <span class="comment">//将栈顶第一个int数值存入第二个局部变量 -&gt; 局部2=3</span></span><br><span class="line">      <span class="number">21</span>: aload         <span class="number">4</span>  <span class="comment">//将局部第五个局部变量(引用型)推送至栈顶</span></span><br><span class="line">      <span class="number">23</span>: athrow           <span class="comment">//将栈顶的异常抛出</span></span><br><span class="line">    Exception table:</span><br><span class="line">       from    to  target type</span><br><span class="line">           <span class="number">0</span>     <span class="number">4</span>     <span class="number">8</span>   Class java/lang/Exception  <span class="comment">//0到4行对应的异常，对应#8中储存的异常</span></span><br><span class="line">           <span class="number">0</span>     <span class="number">4</span>    <span class="number">17</span>   any                        <span class="comment">//Exeption之外的其他异常</span></span><br><span class="line">           <span class="number">8</span>    <span class="number">13</span>    <span class="number">17</span>   any</span><br><span class="line">          <span class="number">17</span>    <span class="number">19</span>    <span class="number">17</span>   any</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line <span class="number">20</span>: <span class="number">0</span></span><br><span class="line">      line <span class="number">21</span>: <span class="number">2</span></span><br><span class="line">      line <span class="number">26</span>: <span class="number">4</span></span><br><span class="line">      line <span class="number">21</span>: <span class="number">6</span></span><br><span class="line">      line <span class="number">22</span>: <span class="number">8</span></span><br><span class="line">      line <span class="number">23</span>: <span class="number">9</span></span><br><span class="line">      line <span class="number">24</span>: <span class="number">11</span></span><br><span class="line">      line <span class="number">26</span>: <span class="number">13</span></span><br><span class="line">      line <span class="number">24</span>: <span class="number">15</span></span><br><span class="line">      line <span class="number">26</span>: <span class="number">17</span></span><br><span class="line">      line <span class="number">27</span>: <span class="number">21</span></span><br><span class="line">    LocalVariableTable:</span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          <span class="number">2</span>       <span class="number">6</span>     <span class="number">1</span>     x   I</span><br><span class="line">          <span class="number">9</span>       <span class="number">8</span>     <span class="number">2</span>     e   Ljava/lang/Exception;</span><br><span class="line">         <span class="number">11</span>       <span class="number">6</span>     <span class="number">1</span>     x   I</span><br><span class="line">          <span class="number">0</span>      <span class="number">24</span>     <span class="number">0</span>  <span class="keyword">this</span>   Ltest/javap/Main;</span><br><span class="line">         <span class="number">21</span>       <span class="number">3</span>     <span class="number">1</span>     x   I</span><br><span class="line">    StackMapTable: number_of_entries = <span class="number">2</span></span><br><span class="line">      frame_type = <span class="number">72</span> <span class="comment">/* same_locals_1_stack_item */</span></span><br><span class="line">        stack = [ <span class="class"><span class="keyword">class</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Exception</span> ]</span></span><br><span class="line"><span class="class">      <span class="title">frame_type</span> </span>= <span class="number">72</span> <span class="comment">/* same_locals_1_stack_item */</span></span><br><span class="line">        stack = [ <span class="class"><span class="keyword">class</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Throwable</span> ]</span></span><br></pre></td></tr></table></figure>

<p>试问当不发生异常和发生异常的情况下，foo()的返回值分别是多少？</p>
<p>在字节码的4,5，以及13,14中执行的是同一个操作，就是将int型的3入操作数栈顶，并存入第二个局部变量。这正是我们源码在finally语句块中内容。也就是说，JVM在处理异常时，会在每个可能的分支都将finally语句重复执行一遍。</p>
<p>通过一步步分析字节码，可以得出最后的运行结果是：</p>
<ul>
<li>不发生异常时: return 1</li>
<li>发生异常时: return 2</li>
<li>发生非Exception及其子类的异常，抛出异常，不返回值</li>
</ul>
<h3 id="字节码增强技术"><a href="#字节码增强技术" class="headerlink" title="字节码增强技术"></a>字节码增强技术</h3><p>字节码增强技术就是一类对现有字节码进行修改或者动态生成全新字节码文件的技术。</p>
<p>字节码增强技术相当于是一把打开运行时JVM的钥匙，利用它可以动态地对运行中的程序做修改，也可以跟踪JVM运行中程序的状态。</p>
<p>此外，我们平时使用的动态代理、AOP也与字节码增强密切相关，它们实质上还是利用各种手段生成符合规范的字节码文件。</p>
<p>综上所述，掌握字节码增强后可以高效地定位并快速修复一些棘手的问题（如线上性能问题、方法出现不可控的出入参需要紧急加日志等问题），也可以在开发中减少冗余代码，大大提高开发效率。</p>
<p><img src="/imgs/java-jvm/java%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA.png" alt="java字节码增强"></p>
<h4 id="ASM"><a href="#ASM" class="headerlink" title="ASM"></a>ASM</h4><p>对于需要手动操纵字节码的需求，可以使用ASM，它可以直接生产 <code>.class</code> 字节码文件，也可以在类被加载入JVM之前动态修改类行为。</p>
<p>ASM的应用场景有AOP（Cglib就是基于ASM）、热部署、修改其他jar包中的类等。</p>
<p>访问者模式主要用于修改或操作一些数据结构比较稳定的数据，节码文件的结构是由JVM固定的，所以很适合利用访问者模式对字节码文件进行修改。 </p>
<h5 id="ASM-API"><a href="#ASM-API" class="headerlink" title="ASM API"></a>ASM API</h5><h6 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h6><p>ASM Core API可以类比解析XML文件中的SAX方式，不需要把这个类的整个结构读取进来，就可以用流式的方法来处理字节码文件。好处是非常节约内存，但是编程难度较大。</p>
<p>出于性能考虑，一般情况下编程都使用Core API。在Core API中有以下几个关键类：</p>
<ul>
<li>ClassReader：用于读取已经编译好的.class文件。 </li>
<li>ClassWriter：用于重新构建编译后的类，如修改类名、属性以及方法，也可以生成新的类的字节码文件。 </li>
<li>各种Visitor类：如上所述，CoreAPI根据字节码从上到下依次处理，对于字节码文件中不同的区域有不同的Visitor，比如用于访问方法的MethodVisitor、用于访问类变量的FieldVisitor、用于访问注解的AnnotationVisitor等。为了实现AOP，重点要使用的是MethodVisitor。</li>
</ul>
<h6 id="树形API"><a href="#树形API" class="headerlink" title="树形API"></a>树形API</h6><p>ASM Tree API可以类比解析XML文件中的DOM方式，把整个类的结构读取到内存中，缺点是消耗内存多，但是编程比较简单。</p>
<p>TreeApi不同于CoreAPI，TreeAPI通过各种Node类来映射字节码的各个区域，类比DOM节点，就可以很好地理解这种编程方式。</p>
<h5 id="直接利用ASM实现AOP"><a href="#直接利用ASM实现AOP" class="headerlink" title="直接利用ASM实现AOP"></a>直接利用ASM实现AOP</h5><p>利用ASM的CoreAPI来增强类。只实现在方法调用前、后增加逻辑，通俗易懂且方便理解。</p>
<p>首先定义需要被增强的Base类：其中只包含一个process()方法，方法内输出一行“process”。增强后，我们期望的是，方法执行前输出“start”，之后输出”end”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了利用ASM实现AOP，需要定义两个类：</p>
<ol>
<li>MyClassVisitor类，用于对字节码的visit以及修改；</li>
<li>Generator类，在这个类中定义ClassReader和ClassWriter，其中的逻辑是，classReader读取字节码，然后交给MyClassVisitor类处理，处理完成后由ClassWriter写字节码并将旧的字节码替换掉。</li>
</ol>
<h6 id="Generator类"><a href="#Generator类" class="headerlink" title="Generator类"></a>Generator类</h6><p>Generator类较简单，我们先看一下它的实现，如下所示，然后重点解释MyClassVisitor类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.org.objectweb.asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Generator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//读取</span></span><br><span class="line">        ClassReader classReader = <span class="keyword">new</span> ClassReader(<span class="string">&quot;test/org/objectweb/asm/Base&quot;</span>);</span><br><span class="line">        ClassWriter classWriter = <span class="keyword">new</span> ClassWriter(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">        <span class="comment">//处理</span></span><br><span class="line">        ClassVisitor classVisitor = <span class="keyword">new</span> MyClassVisitor(classWriter);</span><br><span class="line">        classReader.accept(classVisitor, ClassReader.SKIP_DEBUG);</span><br><span class="line">        <span class="keyword">byte</span>[] data = classWriter.toByteArray();</span><br><span class="line">        <span class="comment">//输出</span></span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">&quot;target/classes/test/org/objectweb/asm/Base.class&quot;</span>);</span><br><span class="line">        FileOutputStream fout = <span class="keyword">new</span> FileOutputStream(f);</span><br><span class="line">        fout.write(data);</span><br><span class="line">        fout.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;now generator cc success!!!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="MyClassVisitor类"><a href="#MyClassVisitor类" class="headerlink" title="MyClassVisitor类"></a>MyClassVisitor类</h6><p>MyClassVisitor继承自ClassVisitor，用于对字节码的观察。它还包含一个内部类MyMethodVisitor，继承自MethodVisitor用于对类内方法的观察，它的整体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.org.objectweb.asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassVisitor</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> <span class="keyword">implements</span> <span class="title">Opcodes</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyClassVisitor</span><span class="params">(ClassVisitor cv)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ASM5, cv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature,</span></span></span><br><span class="line"><span class="params"><span class="function">                      String superName, String[] interfaces)</span> </span>&#123;</span><br><span class="line">        cv.visit(version, access, name, signature, superName, interfaces);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span> </span>&#123;</span><br><span class="line">        MethodVisitor mv = cv.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line">        <span class="comment">// Base类中有两个方法：无参构造以及process方法，这里不增强构造方法</span></span><br><span class="line">        <span class="keyword">if</span> (!name.equals(<span class="string">&quot;&lt;init&gt;&quot;</span>) &amp;&amp; mv != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mv = <span class="keyword">new</span> MyMethodVisitor(mv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyMethodVisitor</span> <span class="keyword">extends</span> <span class="title">MethodVisitor</span> <span class="keyword">implements</span> <span class="title">Opcodes</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyMethodVisitor</span><span class="params">(MethodVisitor mv)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(Opcodes.ASM5, mv);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.visitCode();</span><br><span class="line">            mv.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">            mv.visitLdcInsn(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">            mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">(<span class="keyword">int</span> opcode)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ((opcode &gt;= Opcodes.IRETURN &amp;&amp; opcode &lt;= Opcodes.RETURN)</span><br><span class="line">                    || opcode == Opcodes.ATHROW) &#123;</span><br><span class="line">                <span class="comment">// 方法在返回之前，打印&quot;end&quot;</span></span><br><span class="line">                mv.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">                mv.visitLdcInsn(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">                mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mv.visitInsn(opcode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用这个类就可以实现对字节码的修改。详细解读其中的代码，对字节码做修改的步骤是： </p>
<ol>
<li>首先通过MyClassVisitor类中的visitMethod方法，判断当前字节码读到哪一个方法了。跳过构造方法 <code>&lt;init&gt;</code> 后，将需要被增强的方法交给内部类MyMethodVisitor来进行处理。 </li>
<li>接下来，进入内部类MyMethodVisitor中的visitCode方法，它会在ASM开始访问某一个方法的Code区时被调用，重写visitCode方法，将AOP中的前置逻辑就放在这里。</li>
<li>MyMethodVisitor继续读取字节码指令，每当ASM访问到无参数指令时，都会调用MyMethodVisitor中的visitInsn方法。我们判断了当前指令是否为无参数的 “return” 指令，如果是就在它的前面添加一些指令，也就是将AOP的后置逻辑放在该方法中。 </li>
<li>综上，重写MyMethodVisitor中的两个方法，就可以实现AOP了，而重写方法时就需要用ASM的写法，手动写入或者修改字节码。通过调用methodVisitor的visitXXXXInsn()方法就可以实现字节码的插入，XXXX对应相应的操作码助记符类型，比如mv.visitLdcInsn(“end”)对应的操作码就是ldc “end”，即将字符串“end”压入栈。</li>
<li>完成这两个visitor类后，运行Generator中的main方法完成对Base类的字节码增强，增强后的结果可以在编译后的target文件夹中找到Base.class文件进行查看，可以看到反编译后的代码已经改变了。然后写一个测试类MyTest，在其中new Base()，并调用base.process()方法。</li>
</ol>
<p>运行后的class文件反编译后:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> test.org.objectweb.asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Base</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试输出结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start</span><br><span class="line">process</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h5 id="ASM工具"><a href="#ASM工具" class="headerlink" title="ASM工具"></a>ASM工具</h5><p>利用ASM手写字节码时，需要利用一系列visitXXXXInsn()方法来写对应的助记符，所以需要先将每一行源代码转化为一个个的助记符，然后通过ASM的语法转换为visitXXXXInsn()这种写法。</p>
<p>所以可以借助ASM插件来进行编写，这里举例idea插件, idea 2022.1.3 可用的有 <a target="_blank" rel="noopener" href="https://plugins.jetbrains.com/plugin/13914-class-decompile">Class Decompile</a> (推荐) 和 ASM Bytecode Viewer。另外，ASM Bytecode Outline 已不可用。</p>
<h4 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h4><p>ASM是在指令层次上操作字节码的，Javassist是强调源代码层次操作字节码的框架。</p>
<p>Javassist的优点就在于编程简单，在实现字节码增强时，可以无须关注字节码刻板的结构。直接使用java编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构或者动态生成类。</p>
<p>其中最重要的是ClassPool、CtClass、CtMethod、CtField这四个类：</p>
<ol>
<li>CtClass（compile-time class）：编译时类信息，它是一个class文件在代码中的抽象表现形式，可以通过一个类的全限定名来获取一个CtClass对象，用来表示这个类文件。 </li>
<li>ClassPool：从开发视角来看，ClassPool是一张保存CtClass信息的HashTable，key为类名，value为类名对应的CtClass对象。当我们需要对某个类进行修改时，就是通过pool.getCtClass(“className”)方法从pool中获取到相应的CtClass。 </li>
<li>CtMethod：对应的是类中的方法。</li>
<li>CtField：对应的是类中的属性。</li>
</ol>
<p>写一个小Demo来展示Javassist简单、快速的特点。我们依然是对Base中的process()方法做增强，在方法调用前后分别输出”start”和”end”。</p>
<p>我们需要做的就是从pool中获取到相应的CtClass对象和其中的方法，然后执行method.insertBefore和insertAfter方法，参数为要插入的Java代码，再以字符串的形式传入即可，实现起来也极为简单。</p>
<p>实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.javassist;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavassistTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IllegalAccessException, InstantiationException, IOException </span>&#123;</span><br><span class="line"><span class="comment">//        Base base = new Base();   // 取消注释这一行，运行时会报错，原因：JVM不允许在运行时动态重载一个类</span></span><br><span class="line">        ClassPool cp = ClassPool.getDefault();</span><br><span class="line">        CtClass cc = cp.get(<span class="string">&quot;test.javassist.Base&quot;</span>);</span><br><span class="line">        CtMethod m = cc.getDeclaredMethod(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">        <span class="comment">// 是否带 &#123;&#125; 没有区别</span></span><br><span class="line">        m.insertBefore(<span class="string">&quot;System.out.println(\&quot;start\&quot;);&quot;</span>);</span><br><span class="line">        m.insertAfter(<span class="string">&quot;&#123; System.out.println(\&quot;end\&quot;); &#125;&quot;</span>);</span><br><span class="line">        cc.writeFile(<span class="string">&quot;target/classes&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; c = cc.toClass();</span><br><span class="line">        Base b = (Base) c.newInstance();</span><br><span class="line">        b.process();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="运行时类的重载"><a href="#运行时类的重载" class="headerlink" title="运行时类的重载"></a>运行时类的重载</h5><p>如果我们在一个JVM中，先加载了一个类，然后又对其进行字节码增强并重新加载会发生什么呢？</p>
<p>在上文中Javassist的Demo中main()方法的第一行添加Base b=new Base()，即在增强前就先让JVM加载Base类，然后在执行到c.toClass()方法时会抛出错误，在最后调用了ClassLoader的native方法defineClass()时报错。</p>
<p>综上，JVM不允许在运行时动态<strong>重载</strong>一个类，确切的说是不允许修改已经加载的类，和运行时修改未加载的类然后加载是两个概念。</p>
<p>但是，如果只能在类加载前对类进行强化，那字节码增强技术的使用场景就变得很窄了。</p>
<p>期望：在一个持续运行并已经加载了所有类的JVM中，还能利用字节码增强技术对其中的类行为做替换并重新加载。</p>
<p>为了模拟这种情况，我们将Base类做改写，在其中编写main方法，每五秒调用一次process()方法，在process()方法中输出一行“process”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.lang.instrument;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String name = ManagementFactory.getRuntimeMXBean().getName();</span><br><span class="line">        String s = name.split(<span class="string">&quot;@&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// 打印当前Pid</span></span><br><span class="line">        System.out.println(<span class="string">&quot;pid:&quot;</span>+s);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            process();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Instrument"><a href="#Instrument" class="headerlink" title="Instrument"></a>Instrument</h5><p>instrument是JVM提供的一个可以修改已加载类的类库，专门为Java语言编写的插桩服务提供支持。</p>
<p>它需要依赖JVMTI的Attach API机制实现。在JDK 1.6以前，instrument只能在JVM刚启动开始加载类时生效，而在JDK 1.6之后，instrument支持了在运行时对类定义的修改。</p>
<p>要使用instrument的类修改功能，我们需要实现它提供的ClassFileTransformer接口，定义一个类文件转换器,接口中的transform()方法会在类文件被加载时调用。在transform方法里，可以利用上文中的ASM或Javassist对传入的字节码进行改写或替换，生成新的字节码数组后返回。</p>
<p>这里定义一个实现了ClassFileTransformer接口的类TestTransformer，依然在其中利用Javassist对Base类中的process()方法进行增强，在前后分别打印“start”和“end”，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.lang.instrument;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformerTest</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Transforming &quot;</span> + className);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ClassPool cp = ClassPool.getDefault();</span><br><span class="line">            CtClass cc = cp.get(<span class="string">&quot;test.java.lang.instrument.Base&quot;</span>);</span><br><span class="line">            CtMethod m = cc.getDeclaredMethod(<span class="string">&quot;process&quot;</span>);</span><br><span class="line">            m.insertBefore(<span class="string">&quot;&#123; System.out.println(\&quot;start\&quot;); &#125;&quot;</span>);</span><br><span class="line">            m.insertAfter(<span class="string">&quot;&#123; System.out.println(\&quot;end\&quot;); &#125;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> cc.toBytecode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在有了Transformer，那么它要如何注入到正在运行的JVM呢？还需要定义一个Agent，借助Agent的能力将Instrument注入到JVM中。</p>
<p>现在要介绍的是Agent中用到的另一个类Instrumentation。在JDK 1.6之后，Instrumentation可以做启动后的Instrument、本地代码（Native Code）的Instrument，以及动态改变Classpath等等。我们可以向Instrumentation中添加上文中定义的Transformer，并指定要被重加载的类，代码如下所示。这样，<strong>当Agent被Attach到一个JVM中时</strong>，就会执行类字节码替换并重载入JVM的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.lang.instrument;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String args, Instrumentation inst)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 指定自定义的Transformer，在其中利用Javassist做字节码替换</span></span><br><span class="line">        inst.addTransformer(<span class="keyword">new</span> TransformerTest(), <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 重定义类并载入新的字节码</span></span><br><span class="line">            inst.retransformClasses(Base.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;Agent Load Done.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;agent load failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="JVMTI-amp-Agent-amp-Attach-API"><a href="#JVMTI-amp-Agent-amp-Attach-API" class="headerlink" title="JVMTI &amp; Agent &amp; Attach API"></a>JVMTI &amp; Agent &amp; Attach API</h5><p>上面给出了Agent类的代码，追根溯源需要先介绍JPDA（Java Platform Debugger Architecture）。如果JVM启动时开启了JPDA，那么类是允许被重新加载的。在这种情况下，已被加载的旧版本类信息可以被卸载，然后重新加载新版本的类。正如JDPA名称中的Debugger，JDPA其实是一套用于调试Java程序的标准，任何JDK都必须实现该标准。</p>
<p>JPDA定义了一整套完整的体系，它将调试体系分为三部分，并规定了三者之间的通信接口。三部分由低到高分别是Java 虚拟机工具接口（JVMTI），Java 调试协议（JDWP）以及 Java 调试接口（JDI）</p>
<h6 id="JVMTI"><a href="#JVMTI" class="headerlink" title="JVMTI"></a>JVMTI</h6><p>JVMTI（JVM TOOL INTERFACE，JVM工具接口）是JVM提供的一套对JVM进行操作的工具接口。通过JVMTI，可以实现对JVM的多种操作，它通过接口注册各种事件勾子，在JVM事件触发时，同时触发预定义的勾子，以实现对各个JVM事件的响应，事件包括类文件加载、异常产生与捕获、线程启动和结束、进入和退出临界区、成员变量修改、GC开始和结束、方法调用进入和退出、临界区竞争与等待、VM启动与退出等等。</p>
<h6 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h6><p>Agent 是JVMTI的一种实现，Agent有两种启动方式，一是随Java进程启动而启动，经常见到的java -agentlib就是这种方式；二是运行时载入，通过attach API，将模块（jar包）动态地Attach到指定进程id的Java进程内。</p>
<h6 id="Attach-API"><a href="#Attach-API" class="headerlink" title="Attach API"></a>Attach API</h6><p>Attach API 的作用是提供JVM进程间通信的能力，比如说我们为了让另外一个JVM进程把线上服务的线程Dump出来，会运行jstack或jmap的进程，并传递pid的参数，告诉它要对哪个进程进行线程Dump，这就是Attach API做的事情。</p>
<h6 id="注入JVM示例"><a href="#注入JVM示例" class="headerlink" title="注入JVM示例"></a>注入JVM示例</h6><p>下面，我们通过Attach API的loadAgent()方法，将打包好的Agent jar包动态Attach到目标JVM上。具体实现起来的步骤如下：</p>
<ol>
<li>定义Agent，并在其中实现AgentMain方法，如上一小节中定义的代码块7中的AgentTest类；</li>
<li>将AgentTest类打成一个包含MANIFEST.MF的jar包，其中需要在MANIFEST.MF文件中新增3行Agent属性，同时需要将Agent-Class属性指定为AgentTest的全限定名，如下所示： <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Implementation-Title: test-project</span><br><span class="line">Implementation-Version: <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">Built-By: C</span><br><span class="line">Implementation-Vendor-Id: com.test</span><br><span class="line">Created-By: Apache Maven <span class="number">3.6</span><span class="number">.1</span></span><br><span class="line">Build-Jdk: <span class="number">1.8</span><span class="number">.0_212</span></span><br><span class="line">Implementation-URL: http:<span class="comment">//maven.apache.org/</span></span><br><span class="line"><span class="comment">// 下面三行为新增的3行</span></span><br><span class="line">Agent-Class: test.java.lang.instrument.AgentTest</span><br><span class="line">Can-Redefine-Classes: <span class="keyword">true</span></span><br><span class="line">Can-Retransform-Classes: <span class="keyword">true</span></span><br></pre></td></tr></table></figure></li>
<li>最后利用Attach API，将我们打包好的jar包Attach到指定的JVM pid上，代码如下： <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.lang.instrument;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AgentInitializationException;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AgentLoadException;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AttachNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 注意: 工程需要引入包: jdk所在目录/lib/tools.jar</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> AttachNotSupportedException, IOException, AgentLoadException, AgentInitializationException </span>&#123;</span><br><span class="line">        <span class="comment">// 传入目标 JVM pid</span></span><br><span class="line">        VirtualMachine vm = VirtualMachine.attach(<span class="string">&quot;2276&quot;</span>);</span><br><span class="line">        vm.loadAgent(<span class="string">&quot;target/test-project-1.0.0.jar&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>由于在MANIFEST.MF中指定了Agent-Class，所以在Attach后，目标JVM在运行时会走到TestAgent类中定义的agentmain()方法，而在这个方法中，我们利用Instrumentation，将指定类的字节码通过定义的类转化器TestTransformer做了Base类的字节码替换（通过javassist），并完成了类的重新加载。</li>
</ol>
<p>以下为运行时重新载入类的效果：先运行Base中的main()方法，启动一个JVM，可以在控制台看到每隔五秒输出一次”process”。接着执行Attacher中的main()方法，并将上一个JVM的pid传入。此时回到上一个main()方法的控制台，可以看到现在每隔五秒输出”process”前后会分别输出”start”和”end”，也就是说完成了运行时的字节码增强，并重新载入了这个类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pid:<span class="number">2276</span></span><br><span class="line">process</span><br><span class="line">process</span><br><span class="line">Transforming test/java/lang/instrument/Base</span><br><span class="line">Agent Load Done.</span><br><span class="line">start</span><br><span class="line">process</span><br><span class="line">end</span><br><span class="line">start</span><br><span class="line">process</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h6 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h6><p>至此，字节码增强技术的可使用范围就不再局限于JVM加载类前了。通过上述几个类库，我们可以在运行时对JVM中的类进行修改并重载了。通过这种手段，可以做的事情就变得很多了： </p>
<ul>
<li>热部署：不部署服务而对线上服务做修改，可以做打点、增加日志等操作。 </li>
<li>Mock：测试时候对某些服务做Mock。 </li>
<li>性能诊断工具：比如bTrace就是利用Instrument，实现无侵入地跟踪一个正在运行的JVM，监控到类和方法级别的状态信息。</li>
</ul>
<h2 id="GC-详解"><a href="#GC-详解" class="headerlink" title="GC 详解"></a>GC 详解</h2><p>JVM中GC专题（GC算法、回收器、内存泄露排查等等）</p>
<h3 id="GC简介"><a href="#GC简介" class="headerlink" title="GC简介"></a>GC简介</h3><p>垃圾回收(Garbage Collection)是Java虚拟机(JVM)垃圾回收器提供的一种用于在<label style="color:red; font-family:微软雅黑">空闲时间、不定时回收、无任何对象引用</label>的对象所占据的内存空间的一种机制。</p>
<h3 id="判断对象是否存活的算法"><a href="#判断对象是否存活的算法" class="headerlink" title="判断对象是否存活的算法"></a>判断对象是否存活的算法</h3><ol>
<li>引用计数算法（Reference Counting）</li>
</ol>
<p>给对象中添加一个引用计数器。当一个对象被创建并初始化赋值后，该变量计数设置为1。<br>每当有一个地方引用它时，计数器值就加1（a = b， b被引用，则b引用的对象计数+1）。<br>当引用失效时（一个对象的某个引用超过了生命周期（出作用域后）或者被设置为一个新值时），计数器值就减1。任何引用计数为0的对象就是不可能再被使用的。<br><strong>缺点</strong>：对象循环引用时不可被回收。例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Object instance = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestA</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        A a1 = <span class="keyword">new</span> A();</span><br><span class="line">        A a2 = <span class="keyword">new</span> A();</span><br><span class="line">        a1.instance = a2;</span><br><span class="line">        a2.instance = a1;</span><br><span class="line">    </span><br><span class="line">        a1 = <span class="keyword">null</span>;</span><br><span class="line">        a2 = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>可达性分析算法（Reachability Analysis）</li>
</ol>
<p>通过一系列名为”GC Roots”的对象作为起始点向下搜索，搜索走过的路径称为引用链，当一个对象到GC Roots没有任何引用链相连时，就证明此对象是不可用的。</p>
<p>在根搜索算法中，要真正宣告一个对象死亡，至少要经历两次标记过程：</p>
<blockquote>
<p>(1) 如果对象在进行根搜索后发现没有与GC Roots相连接的引用链，那它会被第一次标记并且进行一次筛选。筛选的条件是此对象是否有必要执行finalize()方法（可看作析构函数，类似于OC中的dealloc，Swift中的deinit）。当对象没有覆盖finalize()方法，或finalize()方法已经被虚拟机调用过，虚拟机将这两种情况都视为没有必要执行。<br> <br>(2) 如果该对象被判定为有必要执行finalize()方法，那么这个对象将会被放置在一个名为F-Queue队列中，并在稍后由一条由虚拟机自动建立的、低优先级的Finalizer线程去执行finalize()方法。finalize()方法是对象逃脱死亡命运的最后一次机会（因为一个对象的finalize()方法最多只会被系统自动调用一次），稍后GC将对F-Queue中的对象进行第二次小规模的标记，如果要在finalize()方法中成功拯救自己，只要在finalize()方法中让该对象重新引用链上的任何一个对象建立关联即可。而如果对象这时还没有关联到任何链上的引用，那它就会被回收掉。</p>
</blockquote>
<p><strong>GC Roots:</strong></p>
<ol>
<li>虚拟机栈中引用的对象</li>
<li>方法区中常量引用的对象</li>
<li>方法区中静态属性引用的变量</li>
<li>本地方法栈JNI（一般指naive方法）中引用的对象</li>
</ol>
<p>也可以理解为下面几种（引用于<a target="_blank" rel="noopener" href="http://help.eclipse.org/luna/index.jsp?topic=/org.eclipse.mat.ui.help/concepts/gcroots.html&cp=37_2_3">Help - Eclipse Platform</a>）：</p>
<ul>
<li>System Class - 由初始、系统类加载器(bootstrap/system class loader)加载的对象</li>
<li>JNI Local - native代码中的local变量</li>
<li>JNI Global - native代码中的global变量</li>
<li>Thread Block - 活动的线程块引用的对象</li>
<li>Thread - 活着的线程</li>
<li>Busy Monitor - 调用了wait()、notify()方法的对象，同步的对象</li>
<li>Java Local - local变量</li>
<li>Native Stack - native代码中in或out参数，例如：用户定义的JNI代码或JVM内部代码。通常是这种情况，因为许多方法具有native部分，并且作为方法参数处理的对象成为GC根。</li>
<li>Finalizable - 等待finalizer运行的队列中的对象</li>
<li>Unfinalized - 具有finalize方法但尚未终止且不在finalizer队列中的对象</li>
<li>Unreachable - 从任何其他根无法访问的对象，但为了保留改对象已被MAT标记为根，否则不会包含在分析中的对象</li>
<li>Java Stack Frame - java栈帧（持有本地变量）。仅在使用首选项集解析转储时生成，以将Java堆栈帧视为对象。</li>
<li>Unknown - 未知的根类型对象。某些转储（例如IBM Portable Heap Dump文件）没有根信息。对于这些转储，MAT解析器标记没有入站引用或无法从任何其他根作为此类型的根进行访问的对象。这可确保MAT保留转储中的所有对象。</li>
</ul>
<h3 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h3><ol>
<li>强引用（Strong Reference）<br>如“Object obj = new Object（）”，这类引用是Java程序中最普遍的。只要强引用还存在，垃圾收集器就永远不会回收掉被引用的对象。</li>
<li>软引用（Soft Reference）<br>它用来描述一些可能还有用，但并非必须的对象。在系统内存不够用时，这类引用关联的对象将被垃圾收集器回收。JDK1.2之后提供了SoftReference类来实现软引用。</li>
<li>弱引用（Weak Reference）<br>它也是用来描述非须对象的，但它的强度比软引用更弱些，被弱引用关联的对象只能生存到下一次垃圾收集发生之前。当垃圾收集器工作时，无论当前内存是否足够，都会回收掉只被弱引用关联的对象。在JDK1.2之后，提供了WeakReference类来实现弱引用。</li>
<li>虚引用（Phantom Reference）<br>最弱的一种引用关系，完全不会对其生存时间构成影响，也无法通过虚引用来取得一个对象实例。为一个对象设置虚引用关联的唯一目的是希望能在这个对象被收集器回收时收到一个系统通知。JDK1.2之后提供了PhantomReference类来实现虚引用。</li>
</ol>
<table>
<thead>
<tr>
<th align="center">引用类型</th>
<th align="center">GC回收时间</th>
<th align="center">用途</th>
<th align="center">生存时间</th>
</tr>
</thead>
<tbody><tr>
<td align="center">强引用</td>
<td align="center">Never</td>
<td align="center">-</td>
<td align="center">JVM停止运行时</td>
</tr>
<tr>
<td align="center">软引用</td>
<td align="center">内存不足时</td>
<td align="center">对象缓存</td>
<td align="center">内存不足时</td>
</tr>
<tr>
<td align="center">弱引用</td>
<td align="center">GC时</td>
<td align="center">对象缓存</td>
<td align="center">下一次GC</td>
</tr>
<tr>
<td align="center">虚引用</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody></table>
<h3 id="回收算法"><a href="#回收算法" class="headerlink" title="回收算法"></a>回收算法</h3><h4 id="标记—复制算法"><a href="#标记—复制算法" class="headerlink" title="标记—复制算法"></a>标记—复制算法</h4><p>定义：将可用内存划分成相等大小两块，每次只使用其中一块，当这一块用完后将还存活的对象复制到另一块，然后将已使用过的内存一次清理。<br>适用：存活对象较少的垃圾回收，一般用于新生代（新生代内存默认按照8:1:1分为Eden，From Survivor，To Survivor三个空间，每次浪费10%）。<br>缺点：内存缩小为原来的一半。<br>优点：每次对整个半区进行内存回收，不用考虑内存碎片问题，只要移动堆顶指针，按顺序分配内存即可；实现简单，运行高效。<br><img src="/imgs/java-jvm/%E6%A0%87%E8%AE%B0%E5%A4%8D%E5%88%B6%E5%9B%9E%E6%94%B6%E5%89%8D%E5%90%8E%E7%8A%B6%E6%80%81.png" alt="标记复制回收前后状态"></p>
<h4 id="标记—整理算法"><a href="#标记—整理算法" class="headerlink" title="标记—整理算法"></a>标记—整理算法</h4><p>定义：先标记要回收的对象，将存活对象移至一端，最后清理端边界以外的内存<br>适用：一般用于年老代<br><img src="/imgs/java-jvm/%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86%E5%9B%9E%E6%94%B6%E5%89%8D%E5%90%8E%E7%8A%B6%E6%80%81.png" alt="标记整理回收前后状态"></p>
<h4 id="标记—清除算法"><a href="#标记—清除算法" class="headerlink" title="标记—清除算法"></a>标记—清除算法</h4><p>定义：先标记要回收的对象，然后统一回收<br>适用：存活对象较多的垃圾回收<br>缺点：会产生大量不连续的内存碎片，需要定期整理<br><img src="/imgs/java-jvm/%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%E5%9B%9E%E6%94%B6%E5%89%8D%E5%90%8E%E7%8A%B6%E6%80%81.png" alt="标记清除回收前后状态"></p>
<h3 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h3><p>常见的垃圾收集器有七种，以下是关系图，连线表示可以搭配使用：<br><img src="/imgs/java-jvm/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E5%88%86%E7%B1%BB%E5%9B%BE.png" alt="垃圾回收器分类图.png"></p>
<h4 id="Serial收集器"><a href="#Serial收集器" class="headerlink" title="Serial收集器"></a>Serial收集器</h4><p>算法：标记—复制<br>用于：新生代<br>特性：单线程，在进行垃圾收集时必须暂停其他所有的工作线程（”Stop the World”）。虚拟机运行在Client模式下的默认新生代收集器。</p>
<h4 id="ParNew收集器"><a href="#ParNew收集器" class="headerlink" title="ParNew收集器"></a>ParNew收集器</h4><p>算法：标记—复制<br>用于：新生代<br>特性：并发收集，Serial收集器的多线程版本。一般是Server模式下的虚拟机中首选的新生代收集器。</p>
<h4 id="Parallel-Scavenge收集器"><a href="#Parallel-Scavenge收集器" class="headerlink" title="Parallel Scavenge收集器"></a>Parallel Scavenge收集器</h4><p>算法：标记—复制<br>用于：新生代<br>特性：并发收集，关注点与其他收集器不同，CMS等收集器的关注点是尽可能缩短垃圾收集时用户线程的停顿时间，而Parallel Scavenge收集器的目的则是达到一个可控制的吞吐量（Throughput, 吞吐量=运行用户代码时间/(运行用户代码时间+垃圾收集时间)），虚拟机总共运行了100分钟，其中垃圾收集花掉1分钟，吞吐量就是99%。</p>
<h4 id="Serial-Old收集器"><a href="#Serial-Old收集器" class="headerlink" title="Serial Old收集器"></a>Serial Old收集器</h4><p>算法：标记—整理<br>用于：年老代<br>特性：单线程，Serial收集器的年老代版本。主要被Client模式下的虚拟机使用。</p>
<h4 id="Parallel-Old收集器"><a href="#Parallel-Old收集器" class="headerlink" title="Parallel Old收集器"></a>Parallel Old收集器</h4><p>算法：标记—整理<br>用于：年老代<br>特性：并发收集，Parallel Scavenge收集器的年老代版本，在注重吞吐量及CPU资源敏感的场合，都可以优先考虑Parallel Scavenge + Parallel Old收集器。</p>
<h4 id="CMS收集器（Concurrent-Mark-Sweep）"><a href="#CMS收集器（Concurrent-Mark-Sweep）" class="headerlink" title="CMS收集器（Concurrent Mark Sweep）"></a>CMS收集器（Concurrent Mark Sweep）</h4><p>算法：标记—清除<br>用于：年老代<br>特性：并发收集、低停顿。以获取最短回收停顿时间为目的。当需要服务的响应速度块、系统停顿时间短，可以优先考虑ParNew + CMS收集器。<br>过程：</p>
<ul>
<li>初始标记（CMS initial mark）：需要”Stop The World”，标记GC Roots能直接关联到的对象，速度快。</li>
<li>并发标记（CMS concurrent mark）：进行GC Roots Tracing过程。</li>
<li>重新标记（CMS remark）：需要”Stop The World”，修正并发标记期间，因用户程序继续运行而导致标记产生变动的那一部分对象的标记记录。停顿时间：初始标记&lt;重新标记&lt;&lt;并发标记。</li>
<li>并发清除（CMS concurrent sweep）：清除标记后要回收的对象，时间较长。</li>
</ul>
<h4 id="G1收集器（Garbage-First）"><a href="#G1收集器（Garbage-First）" class="headerlink" title="G1收集器（Garbage First）"></a>G1收集器（Garbage First）</h4><p>算法：基于“标记-整理”<br>用于：独自管理整个Java堆内存，不需要和其他收集器配合使用<br>特性：</p>
<ul>
<li>并发收集</li>
<li>可预测的停顿时间</li>
<li>压缩空间方面有优势</li>
<li>内部依然区分新生代和年老代，但是Eden, Survivor, Old区不再固定、在内存使用效率上来说更灵活。</li>
<li>将整个Java堆（包括新生代、年老代）划分为多个大小固定的独立区域（Region），并且跟踪这些区域里面的垃圾堆积程度，在后台维护一个优先列表，每次根据允许的收集时间，优先回收垃圾最多的区域（这就是Garbage First名称的由来）。区域划分、有优先级的区域回收。<br>过程：</li>
<li>初始标记（CMS initial mark）：需要”Stop The World”，标记GC Roots能直接关联到的对象，速度快。</li>
<li>并发标记（CMS concurrent mark）：进行GC Roots Tracing过程，此过程之间可以进行年轻代收集。</li>
<li>重新标记（CMS remark）：完全标记堆中的活跃对象，使用一个叫作snapshot-at-the-beginning(SATB)的比CMS收集器的更快的算法。此过程需要一个暂停的时间，去处理剩下的SATB日志缓冲区和所有更新，找出所有未被访问的存活对象，同时安全完成存活数据计算，这个阶段也是并发执行的。</li>
<li>选择回收（CMS concurrent sweep）：根据允许的收集时间，优先回收垃圾最多的区域。</li>
</ul>
<h3 id="内存泄露"><a href="#内存泄露" class="headerlink" title="内存泄露"></a>内存泄露</h3><p>一般来说，内存泄露的发生都是因为使用不当导致的。</p>
<p>使用不当又分为：</p>
<ol>
<li>自己写出来的死循环。</li>
<li>框架使用不当。例如：Disruptor中的RingBuffer、Netty中的ByteBuf</li>
<li>使用的开源库中存在内存泄露问题。</li>
</ol>
<p>解决方案：</p>
<ol>
<li>用jstack、jstat、jmap查看线程堆栈信息，并转写出堆转储文件。</li>
<li>放到win系统中用<a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/community/groups/service/html/communityview?communityUuid=4544bafe-c7a2-455f-9d43-eb866ea60091">IBM HeapAnalyzer</a>等类似工具进行分析。</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-x-overview.html">♥JVM相关知识体系详解♥</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-class.html">JVM 基础 - 类字节码详解</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-class-enhancer.html">JVM 基础 - 字节码的增强技术</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-classload.html">JVM 基础 - Java 类加载机制</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-struct.html">JVM 基础 - JVM 内存结构</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-x-introduce.html">JVM 基础 - Java 内存模型引入</a><br>1、<a target="_blank" rel="noopener" href="https://pdai.tech/md/java/jvm/java-jvm-jmm.html">JVM 基础 - Java 内存模型详解</a><br>1、<a target="_blank" rel="noopener" href="https://www.infoq.cn/article/rhw0p6vhzoz1swcd86rw">一文讲清 JVM 内存结构 | 极客视点</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2022/02/20/java-%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2022/02/20/java-%E9%94%81/" class="post-title-link" itemprop="url">java锁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-20 00:00:00" itemprop="dateCreated datePublished" datetime="2022-02-20T00:00:00+08:00">2022-02-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/posts/2022/02/20/java-%E9%94%81/" class="post-meta-item leancloud_visitors" data-flag-title="java锁" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Java-锁简介"><a href="#Java-锁简介" class="headerlink" title="Java 锁简介"></a>Java 锁简介</h2><p>Java提供了种类丰富的锁，每种锁因其特性的不同，在适当的场景下能够展现出非常高的效率。</p>
<p>java主流锁如下图：<br><img src="/imgs/java-%E9%94%81/java%E4%B8%BB%E6%B5%81%E9%94%81.png" alt="java 主流锁"></p>
<h2 id="Java-对象头"><a href="#Java-对象头" class="headerlink" title="Java 对象头"></a>Java 对象头</h2><p>Java对象保存在内存中时，由 对象头（Header）、实例数据（Instance Data）、对齐填充（Padding） 三部分组成。在这儿主要介绍一下对象头。</p>
<p>java 对象头由三部分组成：</p>
<ol>
<li>Mark Word</li>
<li>Klass Pointer（指向类的指针）</li>
<li>Array Length（数组长度）（只有数组对象才有）</li>
</ol>
<h3 id="Mark-Word"><a href="#Mark-Word" class="headerlink" title="Mark Word"></a>Mark Word</h3><p>Mark Word主要用来存储对象自身的运行时数据，如hashcode、gc分代年龄等。</p>
<p>Mark Word的位长度为JVM的一个Word大小，也就是说32位JVM的Mark word为32位，64位JVM为64位。为了让一个字大小存储更多的信息，JVM将字的最低两个位设置为标记位。</p>
<p>Mark Word在32位JVM中存储状态：</p>
<table align="center">
    <tr align="center">
        <th colspan=5>Mark Word (32 bits) </th>
        <th colspan=1>State 含义</th>
    </tr>
    <tr>
        <td colspan=2>identity_hashcode:25 <br/>(对象的HashCode)</td>
        <td>age:4</td>
        <td>biased_lock:1 <br/>(是否偏向锁, 值: 0)</td>
        <td>state:2 <br/>(值: 01)</td>
        <td>Normal <br/>(无锁)</td>
    </tr>
    <tr>
        <td>thread:23 <br/>(线程ID)</td>
        <td>epoch:2</td>
        <td>age:4</td>
        <td>biased_lock:1 <br/>(是否偏向锁, 值: 1)</td>
        <td>state:2 <br/>(值: 01)</td>
        <td>Biased <br/>(偏向锁)</td>
    </tr>
    <tr>
        <td colspan=4>ptr_to_lock_record:30 <br/>(指向栈中锁记录的指针)</td>
        <td>state:2 <br/>(值: 00)</td>
        <td>Lightweight Locked <br/>(轻量级锁)</td>
    </tr>
    <tr>
        <td colspan=4>ptr_to_heavyweight_monitor:30 <br/>(    
指向重量级锁的指针)</td>
        <td>state:2 <br/>(值: 10)</td>
        <td>Heavyweight Locked <br/>(重量级锁)</td>
    </tr>
    <tr>
        <td colspan=4></td>
        <td>state:2 <br/>(值: 11)</td>
        <td>Marked for GC <br/>(GC标记)</td>
    </tr>
</table>
Mark Word在在64位JVM中存储状态：
<table align="center">
    <tr align="center">
        <th colspan=6>Mark Word (64 bits) </th>
        <th colspan=1>State 含义</th>
    </tr>
    <tr>
        <td>unused:25</td>
        <td>identity_hashcode:31 <br/>(对象的HashCode)</td>
        <td>unused:1</td>
        <td>age:4</td>
        <td>biased_lock:1 <br/>(是否偏向锁, 值: 0)</td>
        <td>state:2 <br/>(值: 01)</td>
        <td>Normal <br/>(无锁)</td>
    </tr>
    <tr>
        <td>thread:54 <br/>(线程ID)</td>
        <td>epoch:2</td>
        <td>unused:1</td>
        <td>age:4</td>
        <td>biased_lock:1 <br/>(是否偏向锁, 值: 1)</td>
        <td>state:2 <br/>(值: 01)</td>
        <td>Biased <br/>(偏向锁)</td>
    </tr>
    <tr>
        <td colspan=5>ptr_to_lock_record:62 <br/>(指向栈中锁记录的指针)</td>
        <td>state:2 <br/>(值: 00)</td>
        <td>Lightweight Locked <br/>(轻量级锁)</td>
    </tr>
    <tr>
        <td colspan=5>ptr_to_heavyweight_monitor:62 <br/>(    
指向重量级锁的指针)</td>
        <td>state:2 <br/>(值: 10)</td>
        <td>Heavyweight Locked <br/>(重量级锁)</td>
    </tr>
    <tr>
        <td colspan=5></td>
        <td>state:2 <br/>(值: 11)</td>
        <td>Marked for GC <br/>(GC标记)</td>
    </tr>
</table>

<h3 id="Klass-Pointer"><a href="#Klass-Pointer" class="headerlink" title="Klass Pointer"></a>Klass Pointer</h3><p>这一部分用于存储对象的类型指针，该指针指向它的类元数据，JVM通过这个指针确定对象是哪个类的实例。该指针的位长度为JVM的一个字大小，即32位的JVM为32位，64位的JVM为64位。</p>
<p>如果应用的对象过多，使用64位的指针将浪费大量内存，统计而言，64位的JVM将会比32位的JVM多耗费50%的内存。为了节约内存可以使用选项+UseCompressedOops开启指针压缩，其中，oop即ordinary object pointer普通对象指针。</p>
<p>开启该选项后，下列指针将压缩至32位：</p>
<ol>
<li>每个Class的属性指针（即静态变量）</li>
<li>每个对象的属性指针（即对象变量）</li>
<li>普通对象数组的每个元素指针</li>
</ol>
<p>当然，也不是所有的指针都会压缩，一些特殊类型的指针JVM不会优化，比如指向PermGen的Class对象指针(JDK8中指向元空间的Class对象指针)、本地变量、堆栈元素、入参、返回值和NULL指针等。</p>
<h3 id="Array-Length"><a href="#Array-Length" class="headerlink" title="Array Length"></a>Array Length</h3><p>如果对象是一个数组，那么对象头还需要有额外的空间用于存储数组的长度，这部分数据的长度也随着JVM架构的不同而不同：32位的JVM上，长度为32位；64位JVM则为64位。</p>
<p><strong>64位JVM如果开启+UseCompressedOops选项，该区域长度也将由64位压缩至32位</strong>。</p>
<h2 id="乐观锁-VS-悲观锁"><a href="#乐观锁-VS-悲观锁" class="headerlink" title="乐观锁 VS 悲观锁"></a>乐观锁 VS 悲观锁</h2><p>乐观锁与悲观锁是一种广义上的概念，体现了看待线程同步的不同角度。在Java和数据库中都有此概念对应的实际应用。</p>
<p>对于同一个数据的并发操作，悲观锁认为自己在使用数据的时候一定有别的线程来修改数据，因此在获取数据的时候会先加锁，确保数据不会被别的线程修改。Java中，synchronized关键字和Lock的实现类都是悲观锁。</p>
<p>而乐观锁认为自己在使用数据时不会有别的线程修改数据，所以不会添加锁，只是在更新数据的时候去判断之前有没有别的线程更新了这个数据。如果这个数据没有被更新，当前线程将自己修改的数据成功写入。如果数据已经被其他线程更新，则根据不同的实现方式执行不同的操作（例如报错或者自动重试）。</p>
<p>乐观锁在Java中是通过使用无锁编程来实现，最常采用的是CAS算法，Java原子类中的递增操作就通过CAS自旋实现的。</p>
<h2 id="互斥量（mutex）"><a href="#互斥量（mutex）" class="headerlink" title="互斥量（mutex）"></a>互斥量（mutex）</h2><p>mutex思想简单粗暴，多线程共享一个互斥量，然后线程之间去竞争，得到锁的线程可以进入临界区执行代码。mutex是睡眠等待（sleep waiting）类型的锁，线程抢锁失败就进行休眠，锁状态改变后被唤醒。</p>
<p>操作系统负责线程调度，为了实现<strong>锁的状态发生改变时再唤醒</strong>，就需要把锁交给操作系统管理。所以互斥器的加锁操作通常都需要涉及到上下文切换，操作花销也就会比自旋锁要大。</p>
<h2 id="信号量（Semaphore）"><a href="#信号量（Semaphore）" class="headerlink" title="信号量（Semaphore）"></a>信号量（Semaphore）</h2><p>信号量(Semaphore)，有时被称为信号灯，是在多线程环境下使用的一种设施, 它负责协调各个线程, 以保证它们能够正确、合理的使用公共资源。</p>
<p>POSIX信号量标准定义了有名信号量和无名信号量两种，但LinuxThreads只实现了无名新号量，同时有名量除了总是可用于多进程之间以外，在使用上与无名量并没有很大的区别。</p>
<p>Semaphore可以被抽象为五个操作：</p>
<ol>
<li>创建 Create (CreateSemaphore / sem_init)</li>
<li>等待 Wait (WaitForSingleObject / sem _wait)<ul>
<li>线程等待信号量，如果值大于0，则获得，值减一；如果只等于0，则一直线程进入睡眠状态，知道信号量值大于0或者超时。</li>
</ul>
</li>
<li>释放 Post (ReleaseMutex / sem _post)<ul>
<li>执行释放信号量，则值加一；如果此时有正在等待的线程，则唤醒该线程。</li>
</ul>
</li>
<li>试图等待 TryWait (WaitForSingleObject / sem _trywait)<ul>
<li>如果调用TryWait，线程并不真正的去获得信号量，还是检查信号量是否能够被获得，如果信号量值大于0，则TryWait返回成功；否则返回失败。</li>
</ul>
</li>
<li>销毁 Destroy (CloseHandle / sem_destroy)</li>
</ol>
<h2 id="信号量与互斥量之间的区别"><a href="#信号量与互斥量之间的区别" class="headerlink" title="信号量与互斥量之间的区别"></a>信号量与互斥量之间的区别</h2><ol>
<li>互斥量用于线程的互斥，信号线用于线程的同步。这是互斥量和信号量的根本区别，也就是互斥和同步之间的区别。<ul>
<li>互斥：是指某一资源同时只允许一个访问者对其进行访问，具有唯一性和排它性。但互斥无法限制访问者对资源的访问顺序，即访问是无序的。</li>
<li>同步：是指在互斥的基础上（大多数情况），通过其它机制实现访问者对资源的有序访问。在大多数情况下，同步已经实现了互斥，特别是所有写入资源的情况必定是互斥的。少数情况是指可以允许多个访问者同时访问资源。</li>
</ul>
</li>
<li>互斥量值只能为0/1，信号量值可以为非负整数。<ul>
<li>也就是说，一个互斥量只能用于一个资源的互斥访问，它不能实现多个资源的多线程同步问题。</li>
<li>信号量: 只要信号量的value大于0，其他线程就可以sem_wait成功，成功后信号量的value减一。若value值不大于0，则sem_wait使得线程阻塞，直到sem_post释放后value值加一,但是sem_wait返回之前还是会将此value值减一</li>
<li>互斥量: 只要被锁住，其他任何线程都不可以访问被保护的资源</li>
</ul>
</li>
<li>互斥量的加锁和解锁必须由同一线程分别对应使用，信号量可以由一个线程释放，另一个线程得到。</li>
<li>作用域<ul>
<li>信号量: 进程间或线程间(linux仅线程间的无名信号量pthread semaphore)</li>
<li>互斥量: 线程间</li>
</ul>
</li>
</ol>
<h2 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h2><p>自旋锁也可以说成锁自旋，锁自旋是一种锁竞争机制，锁是一种状态</p>
<p>自旋锁与互斥量功能一样，唯一一点不同的就是互斥量阻塞后休眠让出cpu，而自旋锁阻塞后不会让出cpu，会一直忙等待，直到得到锁。</p>
<p>自旋锁在用户态使用的比较少，在内核使用的比较多！自旋锁的使用场景：锁的持有时间比较短，或者说小于2次上下文切换的时间（这一条件根据不同场景可以适当放宽）。</p>
<p>自旋锁在用户态的函数接口和互斥量一样，把pthread_mutex_xxx()中mutex换成spin，如：pthread_spin_init()。</p>
<p>过程可以简化为如下几步：</p>
<ul>
<li>当前线程竞争锁失败时，打算阻塞自己</li>
<li>不直接阻塞自己，而是自旋（空等待，比如一个空的有限for循环）一会</li>
<li>在自旋的同时重新竞争锁</li>
<li>如果自旋结束前获得了锁，那么锁获取成功；否则，自旋结束后阻塞自己，<strong>此时与互斥量一致</strong></li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>单核处理器上，不存在实际的并行，当前线程不阻塞自己的话，旧owner就不能执行（原因：自旋占用cpu，而cpu是单核），锁永远不会释放，此时不管自旋多久都是浪费；进而，如果线程多而处理器少，自旋也会造成不少无谓的浪费。</li>
<li>自旋锁要占用CPU，如果是计算密集型任务，这一优化通常得不偿失，减少锁的使用是更好的选择。</li>
<li>如果锁竞争的时间比较长，那么自旋通常不能获得锁，白白浪费了自旋占用的CPU时间。这通常发生在锁持有时间长，且竞争激烈的场景中，此时应主动禁用自旋锁。</li>
</ul>
<h2 id="自适应自旋锁"><a href="#自适应自旋锁" class="headerlink" title="自适应自旋锁"></a>自适应自旋锁</h2><p>自旋锁在JDK1.4.2中引入，使用-XX:+UseSpinning来开启。JDK 6中变为默认开启，并且引入了自适应的自旋锁（适应性自旋锁）。</p>
<p>自适应意味着自旋的时间（次数）不再固定，而是由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定。</p>
<p>如果在同一个锁对象上，自旋等待刚刚成功获得过锁，并且持有锁的线程正在运行中，那么虚拟机就会认为这次自旋也是很有可能再次成功，进而它将允许自旋等待持续相对更长的时间。</p>
<p>如果对于某个锁，自旋很少成功获得过，那在以后尝试获取这个锁时将可能省略掉自旋过程，直接阻塞线程，避免浪费处理器资源。</p>
<h2 id="重量级锁"><a href="#重量级锁" class="headerlink" title="重量级锁"></a>重量级锁</h2><p>内置锁在Java中被抽象为监视器锁（monitor）。在JDK 1.6之前，监视器锁可以认为直接对应底层操作系统中的互斥量（mutex）。这种同步方式的成本非常高，包括系统调用引起的内核态与用户态切换、线程阻塞造成的线程切换等。因此，后来称这种锁为“重量级锁”。</p>
<p>java中锁升级为重量级锁时，锁标志的状态值变为“10”，此时Mark Word中存储的是指向重量级锁的指针，此时等待锁的线程都会进入阻塞状态。</p>
<p>整体的锁状态升级流程如下：</p>
<pre class="mermaid">graph LR
    A(无锁) --> B(偏向锁) --> C(轻量锁) --> D(重量锁)</pre>

<h2 id="轻量锁"><a href="#轻量锁" class="headerlink" title="轻量锁"></a>轻量锁</h2><p>轻量锁加锁过程：</p>
<ol>
<li>竞争锁，尝试通过 CAS 设置对象头轻量级锁标志</li>
<li>失败后通过 <strong>自旋锁</strong> 来尝试获取锁</li>
<li>再次失败，升级为重量级锁</li>
</ol>
<p>java中的处理流程：</p>
<ol>
<li><p>在代码进入同步块的时候，如果同步对象锁状态为无锁状态（锁标志位为“01”状态，是否为偏向锁为“0”），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录（Lock Record）的空间，用于存储锁对象目前的Mark Word的拷贝，然后拷贝对象头中的Mark Word复制到锁记录中。</p>
</li>
<li><p>拷贝成功后，虚拟机将使用CAS操作尝试将对象的Mark Word更新为指向Lock Record的指针，并将Lock Record里的owner指针指向对象的Mark Word。</p>
</li>
<li><p>如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象Mark Word的锁标志位设置为“00”，表示此对象处于轻量级锁定状态。</p>
</li>
<li><p>如果轻量级锁的更新操作失败了，虚拟机首先会检查对象的Mark Word是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，那就可以直接进入同步块继续执行，否则说明多个线程竞争锁。</p>
</li>
<li><p>若当前只有一个等待线程，则该线程通过自旋进行等待。但是当自旋超过一定的次数，或者一个线程在持有锁，一个在自旋，又有第三个来访时，<strong>轻量级锁升级为重量级锁</strong>。</p>
</li>
</ol>
<h2 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h2><p><strong>偏向锁的目标是，减少无竞争且只有一个线程使用锁的情况下，使用轻量级锁产生的性能消耗。轻量级锁每次申请、释放锁都 至少 需要一次CAS，但偏向锁只有初始化时需要一次CAS。</strong></p>
<p>偏向锁是指一段同步代码一直被一个线程所访问，那么该线程会自动获取锁，降低获取锁的代价。</p>
<p>在大多数情况下，锁总是由同一线程多次获得，不存在多线程竞争，所以出现了偏向锁。其目标就是在只有一个线程执行同步代码块时能够提高性能。</p>
<p>当一个线程访问同步代码块并获取锁时，会在Mark Word里存储锁偏向的线程ID。在线程进入和退出同步块时不再通过CAS操作来加锁和解锁，而是检测Mark Word里是否存储着指向当前线程的偏向锁。引入偏向锁是为了在无多线程竞争的情况下尽量减少不必要的轻量级锁执行路径，因为轻量级锁的获取及释放依赖多次CAS原子指令，而偏向锁只需要在置换ThreadID的时候依赖一次CAS原子指令即可。</p>
<p>偏向锁只有遇到其他线程尝试竞争偏向锁时，持有偏向锁的线程才会释放锁，<strong>线程不会主动释放偏向锁</strong>。偏向锁的撤销，需要等待全局安全点（在这个时间点上没有字节码正在执行），它会首先暂停拥有偏向锁的线程，判断锁对象是否处于被锁定状态。撤销偏向锁后恢复到无锁（标志位为“01”）或轻量级锁（标志位为“00”）的状态。</p>
<p>偏向锁在JDK 6及以后的JVM里是默认启用的。可以通过JVM参数关闭偏向锁：-XX:-UseBiasedLocking=false，关闭之后程序默认会进入轻量级锁状态。</p>
<p><strong>当锁是偏向锁的时候，被另外的线程所访问，偏向锁就会升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，从而提高性能。</strong></p>
<h2 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h2><p>CAS全称 Compare And Swap（比较与交换），是一种无锁算法。在不使用锁（没有线程被阻塞）的情况下实现多线程之间的变量同步。java.util.concurrent包中的原子类就是通过CAS来实现了乐观锁。</p>
<p>CAS算法涉及到三个操作数：</p>
<ol>
<li>需要读写的内存值 V。</li>
<li>进行比较的值 A。</li>
<li>要写入的新值 B。<br>当且仅当 V 的值等于 A 时，CAS通过原子方式用新值B来更新V的值（“比较+更新”整体是一个原子操作），否则不会执行任何操作。一般情况下，“更新”是一个不断重试的操作。</li>
</ol>
<p>CAS虽然很高效，但是它也存在三大问题：</p>
<ol>
<li>ABA问题。CAS需要在操作值的时候检查内存值是否发生变化，没有发生变化才会更新内存值。但是如果内存值原来是A，后来变成了B，然后又变成了A，那么CAS进行检查时会发现值没有发生变化，但是实际上是有变化的。ABA问题的解决思路就是在变量前面添加版本号，每次变量更新的时候都把版本号加一，这样变化过程就从“A－B－A”变成了“1A－2B－3A”。<ul>
<li>JDK从1.5开始提供了AtomicStampedReference类来解决ABA问题，具体操作封装在compareAndSet()中。compareAndSet()首先检查当前引用和当前标志与预期引用和预期标志是否相等，如果都相等，则以原子方式将引用值和标志的值设置为给定的更新值。</li>
</ul>
</li>
<li>循环时间长开销大。CAS操作如果长时间不成功，会导致其一直自旋，给CPU带来非常大的开销。</li>
<li>只能保证一个共享变量的原子操作。对一个共享变量执行操作时，CAS能够保证原子操作，但是对多个共享变量操作时，CAS是无法保证操作的原子性的。<ul>
<li>Java从1.5开始JDK提供了AtomicReference类来保证引用对象之间的原子性，可以把多个变量放在一个对象里来进行CAS操作。</li>
</ul>
</li>
</ol>
<h2 id="公平锁-VS-非公平锁"><a href="#公平锁-VS-非公平锁" class="headerlink" title="公平锁 VS 非公平锁"></a>公平锁 VS 非公平锁</h2><p>公平锁是指多个线程按照申请锁的顺序来获取锁，线程直接进入队列中排队，队列中的第一个线程才能获得锁。公平锁的优点是等待锁的线程不会饿死。缺点是整体吞吐效率相对非公平锁要低，等待队列中除第一个线程以外的所有线程都会阻塞，CPU唤醒阻塞线程的开销比非公平锁大。</p>
<p>非公平锁是多个线程加锁时直接尝试获取锁，获取不到才会到等待队列的队尾等待。但如果此时锁刚好可用，那么这个线程可以无需阻塞直接获取到锁，所以非公平锁有可能出现后申请锁的线程先获取锁的场景。非公平锁的优点是可以减少唤起线程的开销，整体的吞吐效率高，因为线程有几率不阻塞直接获得锁，CPU不必唤醒所有线程。缺点是处于等待队列中的线程可能会饿死，或者等很久才会获得锁。</p>
<p>可以查看 ReentrantLock 中 FairSync 和 NonfairSync 里获取锁的 tryAcquire() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FairSync</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Fair version of tryAcquire.  Don&#x27;t grant access unless</span></span><br><span class="line"><span class="comment">  * recursive call or no waiters or is first.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">            compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NonfairSync</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Performs non-fair tryLock.  tryAcquire is implemented in</span></span><br><span class="line"><span class="comment">  * subclasses, but both need nonfair try for trylock method.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上图中的源代码对比，我们可以明显的看出公平锁与非公平锁的lock()方法唯一的区别就在于公平锁在获取同步状态时多了一个限制条件：hasQueuedPredecessors()。</p>
<p>hasQueuedPredecessors源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The correctness of this depends on head being initialized</span></span><br><span class="line">    <span class="comment">// before tail and on head.next being accurate if the current</span></span><br><span class="line">    <span class="comment">// thread is first in queue.</span></span><br><span class="line">    Node t = tail; <span class="comment">// Read fields in reverse initialization order</span></span><br><span class="line">    Node h = head;</span><br><span class="line">    Node s;</span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">        ((s = h.next) == <span class="keyword">null</span> || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到该方法主要做一件事情：主要是判断当前线程是否位于同步队列中的第一个。返回true代表有别的线程在CHL队列（CHL队列就是AQS使用的同步队列）中排了当前线程之前；返回false代表当前线程处于CHL队列的第一个线程。</p>
<ol>
<li>分析h != t返回false的情况。此时hasQueuedPredecessors返回false。<ul>
<li>当h和t都为null，返回false。此时说明队列为空，还从来没有Node入过队。</li>
<li>当h和t都指向同一个Node，也返回false。此时说明队列中只有一个dummy node，那说明没有线程在队列中。</li>
</ul>
</li>
<li>分析h != t返回true，且(s = h.next) == null返回true，直接短路后面。此时hasQueuedPredecessors返回true。<ul>
<li>既然h != t返回true，说明h和t不相等，先考虑特殊情况（“head不为null，tail为null”的情况，此时head是空node，next成员肯定为null），那么说明有一个线程正在执行enq，且它正好执行到if (compareAndSetHead(new Node()))到tail = head;的间隙。但这个线程肯定不是当前线程，所以不用判断后面短路的s.thread != Thread.currentThread()了，因为当前线程连enq都没开始执行，但另一个线程都开始执行enq了，那不就是说明当前线程排在别人后面了，别的线程马上就要入队了。</li>
<li>既然h != t返回true，说明h和t不相等，再考虑二者都不为null。那此时队列中已经至少有一个等待中的线程了，那说明当前线程肯定排在别人后面了。</li>
</ul>
</li>
<li>分析h != t返回true，且(s = h.next) == null返回false，且s.thread != Thread.currentThread()返回true。此时hasQueuedPredecessors返回true。如果s.thread != Thread.currentThread()返回false。此时hasQueuedPredecessors返回false。<ul>
<li>现在知道head不为null，而且head.next也不为null了（(s = h.next) == null返回false）。我们也知道队列中第一个等待的线程存放在head.next里（注意，head为dummy node，不存放线程），那么如果head.next的线程不是当前线程，那即说明当前线程已经排在别人线程后面了。</li>
</ul>
</li>
</ol>
<h2 id="可重入锁-VS-非可重入锁"><a href="#可重入锁-VS-非可重入锁" class="headerlink" title="可重入锁 VS 非可重入锁"></a>可重入锁 VS 非可重入锁</h2><p>可重入锁又名递归锁，是指在同一个线程在外层方法获取锁的时候，再进入该线程的内层方法会自动获取锁（前提锁对象得是同一个对象或者class），不会因为之前已经获取过还没释放而阻塞。Java中ReentrantLock和synchronized都是可重入锁，可重入锁的一个优点是可一定程度避免死锁。下面用示例代码来进行分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Widget</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;方法1执行...&quot;</span>);</span><br><span class="line">        doOthers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doOthers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;方法2执行...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，类中的两个方法都是被内置锁synchronized修饰的，doSomething()方法中调用doOthers()方法。因为内置锁是可重入的，所以同一个线程在调用doOthers()时可以直接获得当前对象的锁，进入doOthers()进行操作。</p>
<p>如果是一个不可重入锁，那么当前线程在调用doOthers()之前需要将执行doSomething()时获取当前对象的锁释放掉，实际上该对象锁已被当前线程所持有，且无法释放。所以此时会出现死锁。</p>
<p>ReentrantLock和synchronized都是重入锁，那么我们通过重入锁ReentrantLock以及非可重入锁NonReentrantLock的源码来对比分析一下为什么非可重入锁在重复调用同步资源时会出现死锁。</p>
<p>首先ReentrantLock和NonReentrantLock都继承父类AQS，其父类AQS中维护了一个同步状态status来计数重入次数，status初始值为0。</p>
<p>当线程尝试获取锁时:</p>
<ol>
<li>可重入锁先尝试获取并更新status值，如果status == 0表示没有其他线程在执行同步代码，则把status置为1，当前线程开始执行。如果status != 0，则判断当前线程是否是获取到这个锁的线程，如果是的话执行status+1，且当前线程可以再次获取锁。</li>
<li>非可重入锁是直接去获取并尝试更新当前status的值，如果status != 0的话会导致其获取锁失败，当前线程阻塞。</li>
</ol>
<p>释放锁时:</p>
<ol>
<li>可重入锁同样先获取当前status的值，在当前线程是持有锁的线程的前提下。如果status-1 == 0，则表示当前线程所有重复获取锁的操作都已经执行完毕，然后该线程才会真正释放锁。</li>
<li>非可重入锁则是在确定当前线程是持有锁的线程之后，直接将status置为0，将锁释放。</li>
</ol>
<p>可以简单理解为<strong>针对同一线程</strong>，可重入锁用信号量计数，非可重入锁用互斥量计数。</p>
<h2 id="独享锁-VS-共享锁"><a href="#独享锁-VS-共享锁" class="headerlink" title="独享锁 VS 共享锁"></a>独享锁 VS 共享锁</h2><p>独享锁和共享锁同样是一种概念。</p>
<p>独享锁也叫排他锁，是指该锁一次只能被一个线程所持有。如果线程T对数据A加上排它锁后，则其他线程不能再对A加任何类型的锁。获得排它锁的线程即能读数据又能修改数据。JDK中的synchronized和JUC中Lock的实现类就是互斥锁。</p>
<p>共享锁是指该锁可被多个线程所持有。如果线程T对数据A加上共享锁后，则其他线程只能对A再加共享锁，不能加排它锁。获得共享锁的线程只能读数据，不能修改数据。</p>
<p>独享锁与共享锁也是通过AQS来实现的，通过实现不同的方法，来实现独享或者共享。</p>
<p>接下来通过ReentrantLock和ReentrantReadWriteLock的源码来看独享锁和共享锁：</p>
<p>ReentrantReadWriteLock有两把锁：ReadLock和WriteLock，由词知意，一个读锁一个写锁，合称“读写锁”。再进一步观察可以发现ReadLock和WriteLock是靠内部类Sync实现的锁。Sync是AQS的一个子类，这种结构在CountDownLatch、ReentrantLock、Semaphore里面也都存在。</p>
<p>在ReentrantReadWriteLock里面，读锁和写锁的锁主体都是Sync，但读锁和写锁的加锁方式不一样。读锁是共享锁，写锁是独享锁。读锁的共享锁可保证并发读非常高效，而读写、写读、写写的过程互斥，因为读锁和写锁是分离的。所以ReentrantReadWriteLock的并发性相比一般的互斥锁有了很大提升。</p>
<p>AQS有一个 state 字段（int类型，32位），该字段用来描述有多少线程获持有锁。在独享锁中这个值通常是0或者1（如果是重入锁的话state值就是重入的次数），在共享锁中state就是持有锁的数量。</p>
<p>但是在ReentrantReadWriteLock中有读、写两把锁，所以需要在一个整型变量state上分别描述读锁和写锁的数量（或者也可以叫状态）。于是将state变量“按位切割”切分成了两个部分，<strong>高16位表示读锁状态（读锁个数），低16位表示写锁状态（写锁个数）</strong>。</p>
<p>写锁的加锁源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * Walkthrough:</span></span><br><span class="line"><span class="comment">      * 1. If read count nonzero or write count nonzero</span></span><br><span class="line"><span class="comment">      *    and owner is a different thread, fail.</span></span><br><span class="line"><span class="comment">      * 2. If count would saturate, fail. (This can only</span></span><br><span class="line"><span class="comment">      *    happen if count is already nonzero.)</span></span><br><span class="line"><span class="comment">      * 3. Otherwise, this thread is eligible for lock if</span></span><br><span class="line"><span class="comment">      *    it is either a reentrant acquire or</span></span><br><span class="line"><span class="comment">      *    queue policy allows it. If so, update state</span></span><br><span class="line"><span class="comment">      *    and set owner.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">// 取到当前锁的个数</span></span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// 取写锁的个数w</span></span><br><span class="line">    <span class="keyword">int</span> w = exclusiveCount(c);</span><br><span class="line">    <span class="comment">// 如果已经有线程持有了锁(c!=0)</span></span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span></span><br><span class="line">        <span class="comment">// 如果写线程数（w）为0（换言之存在读锁） 或者持有锁的线程不是当前线程就返回失败</span></span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 如果写入锁的数量大于最大数（65535，2的16次方-1）就抛出一个Error。</span></span><br><span class="line">        <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// Reentrant acquire</span></span><br><span class="line">        setState(c + acquires);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果当且写线程数为0，并且当前线程需要阻塞那么就返回失败；或者如果通过CAS增加写线程数失败也返回失败。</span></span><br><span class="line">    <span class="keyword">if</span> (writerShouldBlock() ||</span><br><span class="line">        !compareAndSetState(c, c + acquires))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 如果c=0，w=0或者c&gt;0，w&gt;0（重入），则设置当前线程或锁的拥有者</span></span><br><span class="line">    setExclusiveOwnerThread(current);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这段代码首先取到当前锁的个数c，然后再通过c来获取写锁的个数w。因为写锁是低16位，所以取低16位的最大值与当前的c做与运算（ int w = exclusiveCount(c); ），高16位和0与运算后是0，剩下的就是低位运算的值，同时也是持有写锁的线程数目。</li>
<li>在取到写锁线程的数目后，首先判断是否已经有线程持有了锁。如果已经有线程持有了锁(c!=0)，则查看当前写锁线程的数目，如果写线程数为0（即此时存在读锁）或者持有锁的线程不是当前线程就返回失败（涉及到公平锁和非公平锁的实现）。</li>
<li>如果写入锁的数量大于最大数（65535，2的16次方-1）就抛出一个Error。</li>
<li>如果当且写线程数为0（那么读线程也应该为0，因为上面已经处理c!=0的情况），并且当前线程需要阻塞那么就返回失败；如果通过CAS增加写线程数失败也返回失败。</li>
<li>如果c=0,w=0或者c&gt;0,w&gt;0（重入），则设置当前线程或锁的拥有者，返回成功！</li>
</ul>
<p>接着是读锁的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * Walkthrough:</span></span><br><span class="line"><span class="comment">      * 1. If write lock held by another thread, fail.</span></span><br><span class="line"><span class="comment">      * 2. Otherwise, this thread is eligible for</span></span><br><span class="line"><span class="comment">      *    lock wrt state, so ask if it should block</span></span><br><span class="line"><span class="comment">      *    because of queue policy. If not, try</span></span><br><span class="line"><span class="comment">      *    to grant by CASing state and updating count.</span></span><br><span class="line"><span class="comment">      *    Note that step does not check for reentrant</span></span><br><span class="line"><span class="comment">      *    acquires, which is postponed to full version</span></span><br><span class="line"><span class="comment">      *    to avoid having to check hold count in</span></span><br><span class="line"><span class="comment">      *    the more typical non-reentrant case.</span></span><br><span class="line"><span class="comment">      * 3. If step 2 fails either because thread</span></span><br><span class="line"><span class="comment">      *    apparently not eligible or CAS fails or count</span></span><br><span class="line"><span class="comment">      *    saturated, chain to version with full retry loop.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// 如果其他线程已经获取了写锁，则当前线程获取读锁失败，进入等待状态</span></span><br><span class="line">    <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">        getExclusiveOwnerThread() != current)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> r = sharedCount(c);</span><br><span class="line">    <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp;</span><br><span class="line">        r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">        compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">            firstReader = current;</span><br><span class="line">            firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">            firstReaderHoldCount++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            HoldCounter rh = cachedHoldCounter;</span><br><span class="line">            <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                readHolds.set(rh);</span><br><span class="line">            rh.count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在tryAcquireShared(int unused)方法中，如果其他线程已经获取了写锁，则当前线程获取读锁失败，进入等待状态。如果当前线程获取了写锁或者写锁未被获取，则当前线程（线程安全，依靠CAS保证）增加读状态，成功获取读锁。读锁的每次释放（线程安全的，可能有多个读线程同时释放读锁）均减少读状态，减少的值是“1&lt;&lt;16”。所以读写锁才能实现读读的过程共享，而读写、写读、写写的过程互斥。</p>
<p>参考资料:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/11/15/java-lock.html">https://tech.meituan.com/2018/11/15/java-lock.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/lkforce/article/details/81128115">https://blog.csdn.net/lkforce/article/details/81128115</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3d38cba67f8b">https://www.jianshu.com/p/3d38cba67f8b</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cangqinglang/p/13328217.html">https://www.cnblogs.com/cangqinglang/p/13328217.html</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903550586191885">https://juejin.cn/post/6844903550586191885</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/anlian523/article/details/106173860">https://blog.csdn.net/anlian523/article/details/106173860</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2022/01/09/netty%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2022/01/09/netty%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">netty笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-09 00:00:00" itemprop="dateCreated datePublished" datetime="2022-01-09T00:00:00+08:00">2022-01-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/posts/2022/01/09/netty%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="netty笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="netty-简介"><a href="#netty-简介" class="headerlink" title="netty 简介"></a>netty 简介</h2><p>Netty 是一个高性能、异步事件驱动的 NIO 网络应用框架，它提供了对TCP、UDP和文件传输的支持。基于 Netty，可以快速的开发和部署高性能、 高可用的网络服务端和客户端应用。</p>
<h2 id="netty-优点"><a href="#netty-优点" class="headerlink" title="netty 优点"></a>netty 优点</h2><ol>
<li>API使用简单，开发门槛低；</li>
<li>功能强大，预置了多种编解码功能，支持多种主流协议；</li>
<li>定制能力强，可以通过ChannelHandler对通信框架进行灵活地扩展；</li>
<li>性能高，通过与其他业界主流的NIO框架对比，Netty的综合性能最优；</li>
<li>成熟、稳定，Netty修复了已经发现的所有JDK NIO BUG，业务开发人员不需要再为NIO的BUG而烦恼；</li>
<li>社区活跃，版本迭代周期短，发现的BUG可以被及时修复，同时，更多的新功能会加入；</li>
<li>经历了大规模的商业应用考验，质量得到验证。在互联网、大数据、网络游戏、企业应用、电信软件等众多行业得到成功商用，证明了它已经完全能够满足不同行业的商业应用了。</li>
</ol>
<h3 id="与-mina-对比"><a href="#与-mina-对比" class="headerlink" title="与 mina 对比"></a>与 mina 对比</h3><ol>
<li>都是Trustin Lee的作品，Netty更晚，也更成熟；</li>
<li>Mina将内核和一些特性的联系过于紧密，使得用户在不需要这些特性的时候无法脱离，相比下性能会有所下降，Netty解决了这个设计问题；</li>
<li>Netty的文档更清晰，很多Mina的特性在Netty里都有；</li>
<li>Netty更新周期更短，新版本的发布比较快；</li>
<li>它们的架构差别不大，Mina靠apache生存，而Netty靠jboss，和jboss的结合度非常高，Netty有对google protocal buf的支持，有更完整的ioc容器支持(spring,guice,jbossmc和osgi)；</li>
<li>Netty和Mina在处理UDP时有一些不同，Netty将UDP无连接的特性暴露出来；而Mina对UDP进行了高级层次的抽象，可以把UDP当成”面向连接”的协议，而要Netty做到这一点比较困难。</li>
</ol>
<h2 id="NIO简介"><a href="#NIO简介" class="headerlink" title="NIO简介"></a>NIO简介</h2><p>NIO 主要有三大核心部分：Channel(通道)，Buffer(缓冲区), Selector。</p>
<p>传统 IO 基于字节流和字符流进行操作，而 NIO 基于 Channel 和 Buffer(缓冲区)进行操作，数据总是从通道读取到缓冲区中，或者从缓冲区写入到通道中。</p>
<p>Selector(选择区)用于监听多个通道的事件（比如：连接打开，数据到达）。因此，单个线程可以监听多个数据通道</p>
<p>NIO详细介绍参考：<a href="/posts/2022/01/09/IO%E6%B5%81/" title="[io流]">[io流]</a></p>
<h3 id="NIO-与-IO-的区别"><a href="#NIO-与-IO-的区别" class="headerlink" title="NIO 与 IO 的区别"></a>NIO 与 IO 的区别</h3><ul>
<li>IO 是面向流的，NIO 是面向缓冲区的</li>
<li>IO 流是阻塞的，NIO 流是不阻塞的</li>
<li>NIO 有选择器，而 IO 没有</li>
</ul>
<h2 id="Netty-的零拷贝技术"><a href="#Netty-的零拷贝技术" class="headerlink" title="Netty 的零拷贝技术"></a>Netty 的零拷贝技术</h2><p>介绍完传统 Linux 的零拷贝技术之后，我们再来学习下 Netty 中的零拷贝如何实现。Netty 中的零拷贝和传统 Linux 的零拷贝不太一样。Netty 中的零拷贝技术除了操作系统级别的功能封装，更多的是面向用户态的数据操作优化，主要体现在以下 5 个方面：</p>
<ol>
<li>堆外内存，避免 JVM 堆内存到堆外内存的数据拷贝。</li>
<li>CompositeByteBuf 类，可以组合多个 Buffer 对象合并成一个逻辑上的对象，避免通过传统内存拷贝的方式将几个 Buffer 合并成一个大的 Buffer。</li>
<li>通过 Unpooled.wrappedBuffer 可以将 byte 数组包装成 ByteBuf 对象，包装过程中不会产生内存拷贝。</li>
<li>ByteBuf.slice 操作与 Unpooled.wrappedBuffer 相反，slice 操作可以将一个 ByteBuf 对象切分成多个 ByteBuf 对象，切分过程中不会产生内存拷贝，底层共享一个 byte 数组的存储空间。</li>
<li>Netty 使用 FileRegion 实现文件传输，FileRegion 底层封装了 FileChannel#transferTo() 方法，可以将文件缓冲区的数据直接传输到目标 Channel，避免内核缓冲区和用户态缓冲区之间的数据拷贝，这属于操作系统级别的零拷贝。</li>
</ol>
<h2 id="netty-核心组件"><a href="#netty-核心组件" class="headerlink" title="netty 核心组件"></a>netty 核心组件</h2><p>一个 netty 应用的核心组件：</p>
<ul>
<li>Bootstrap or ServerBootstrap</li>
<li>EventLoop</li>
<li>EventLoopGroup</li>
<li>ChannelPipeline</li>
<li>Channel</li>
<li>Future or ChannelFuture</li>
</ul>
<h3 id="Bootstrap-or-ServerBootstrap"><a href="#Bootstrap-or-ServerBootstrap" class="headerlink" title="Bootstrap or ServerBootstrap"></a>Bootstrap or ServerBootstrap</h3><h3 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h3><h3 id="EventLoopGroup"><a href="#EventLoopGroup" class="headerlink" title="EventLoopGroup"></a>EventLoopGroup</h3><h3 id="ChannelPipeline"><a href="#ChannelPipeline" class="headerlink" title="ChannelPipeline"></a>ChannelPipeline</h3><h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><h3 id="Future-or-ChannelFuture"><a href="#Future-or-ChannelFuture" class="headerlink" title="Future or ChannelFuture"></a>Future or ChannelFuture</h3><p>参考资料:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904146550652941">https://juejin.cn/post/6844904146550652941</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/16%20%20IO%20%E5%8A%A0%E9%80%9F%EF%BC%9A%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84%20Netty%20%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF.md">https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/16%20%20IO%20%E5%8A%A0%E9%80%9F%EF%BC%9A%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84%20Netty%20%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF.md</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2022/01/09/IO%E6%B5%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2022/01/09/IO%E6%B5%81/" class="post-title-link" itemprop="url">IO流</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-09 00:00:00" itemprop="dateCreated datePublished" datetime="2022-01-09T00:00:00+08:00">2022-01-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/posts/2022/01/09/IO%E6%B5%81/" class="post-meta-item leancloud_visitors" data-flag-title="IO流" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="IO-简介"><a href="#IO-简介" class="headerlink" title="IO 简介"></a>IO 简介</h2><p>操作系统分为两种I/O：</p>
<ul>
<li>网络IO：本质是socket读取</li>
<li>磁盘IO：DMA操作读取</li>
</ul>
<h2 id="I-O-过程"><a href="#I-O-过程" class="headerlink" title="I/O 过程"></a>I/O 过程</h2><ol>
<li>DMA(Direct Memory Access, 直接存储器访问) 将数据从磁盘文件先加载至内核内存空间(缓冲区)，等待数据准备完成，时间较长</li>
<li>CPU(Central Processing Unit, 中央处理器) 将数据从内核缓冲区复制到用户空间的进程的内存中，时间较短</li>
</ol>
<h2 id="I-O-模型"><a href="#I-O-模型" class="headerlink" title="I/O 模型"></a>I/O 模型</h2><p>同步/异步（线程间调用）：关注的是消息通信机制<br>同步与异步是对应于调用者与被调用者，它们是线程之间的关系，两个线程之间要么是同步的，要么是异步的</p>
<ul>
<li>同步：synchronous，调用者等待被调用者返回消息，才能继续执行</li>
<li>异步：asynchronous，被调用者通过状态、通知或回调机制主动通知调用者被调用者的运行状态</li>
</ul>
<p>阻塞/非阻塞（线程内调用）：关注调用者在等待结果返回之前所处的状态<br>阻塞与非阻塞是对同一个线程来说的，在某个时刻，线程要么处于阻塞，要么处于非阻塞</p>
<ul>
<li><p>阻塞：blocking，指IO操作需要彻底完成后才返回到用户空间，调用结果返回之前，调用者被挂起</p>
</li>
<li><p>非阻塞：nonblocking，指IO操作被调用后立即返回给用户一个状态值，无需等到IO操作彻底完成，最终的调用结果返回之前，调用者不会被挂起</p>
</li>
<li><p>同步阻塞：你到饭馆点餐，然后在那等着，还要一边问：好了没啊！</p>
</li>
<li><p>同步非阻塞：在饭馆点完餐，就去遛狗了，不过溜一会儿，就回饭馆问一下：好了没啊！</p>
</li>
<li><p>异步阻塞：你到饭馆点餐，然后在那等着，饭做好了，服务员会叫号，不需要你问。</p>
</li>
<li><p>异步非阻塞：在饭馆点完餐，就去遛狗了，饭做好了，服务员会打电话通知，不需要你到饭店问。</p>
</li>
</ul>
<h2 id="五种I-O模型（操作系统）"><a href="#五种I-O模型（操作系统）" class="headerlink" title="五种I/O模型（操作系统）"></a>五种I/O模型（操作系统）</h2><p>阻塞IO模型、非阻塞IO模型、IO复用模型、信号驱动IO模型、异步IO模型</p>
<h3 id="阻塞IO模型"><a href="#阻塞IO模型" class="headerlink" title="阻塞IO模型"></a>阻塞IO模型</h3><p>阻塞 I/O 是最简单的 I/O 模型，一般表现为进程或线程等待某个条件，如果条件不满足，则一直等下去。条件满足，则进行下一步操作。</p>
<p>应用进程通过系统调用 recvfrom 接收数据，但由于内核还未准备好数据报，应用进程就会阻塞住，直到内核准备好数据报，recvfrom 完成数据报复制工作，应用进程才能结束阻塞状态。</p>
<p><img src="/imgs/io%E6%B5%81/%E9%98%BB%E5%A1%9Eio%E6%A8%A1%E5%9E%8B.png" alt="阻塞io模型"></p>
<h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><p>我们钓鱼的时候，有一种方式比较惬意，比较轻松，那就是我们坐在鱼竿面前，这个过程中我们什么也不做，双手一直把着鱼竿，就静静的等着鱼儿咬钩。一旦手上感受到鱼的力道，就把鱼钓起来放入鱼篓中。然后再钓下一条鱼。</p>
<p>这种钓鱼方式相对来说比较简单，对于钓鱼的人来说，不需要什么特制的鱼竿，拿一根够长的木棍就可以悠闲的开始钓鱼了（实现简单）。缺点就是比较耗费时间，比较适合那种对鱼的需求量小的情况（并发低，时效性要求低）。</p>
<h3 id="非阻塞IO模型"><a href="#非阻塞IO模型" class="headerlink" title="非阻塞IO模型"></a>非阻塞IO模型</h3><p>应用进程与内核交互，目的未达到之前，不再一味的等着，而是直接返回。然后通过轮询的方式，不停的去问内核数据准备有没有准备好。如果某一次轮询发现数据已经准备好了，那就把数据拷贝到用户空间中。</p>
<p>应用进程通过 recvfrom 调用不停的去和内核交互，直到内核准备好数据。如果没有准备好，内核会返回error，应用进程在得到error后，过一段时间再发送recvfrom请求。在两次发送请求的时间段，进程可以先做别的事情。</p>
<p><img src="/imgs/io%E6%B5%81/%E9%9D%9E%E9%98%BB%E5%A1%9Eio%E6%A8%A1%E5%9E%8B.png" alt="非阻塞io模型"></p>
<h4 id="举例-1"><a href="#举例-1" class="headerlink" title="举例"></a>举例</h4><p>我们钓鱼的时候，在等待鱼儿咬钩的过程中，我们可以做点别的事情，比如玩一把王者荣耀、看一集《延禧攻略》等等。但是，我们要时不时的去看一下鱼竿，一旦发现有鱼儿上钩了，就把鱼钓上来。</p>
<p>这种方式钓鱼，和阻塞IO比，所使用的工具没有什么变化，但是钓鱼的时候可以做些其他事情，增加时间的利用率。</p>
<h3 id="IO复用模型"><a href="#IO复用模型" class="headerlink" title="IO复用模型"></a>IO复用模型</h3><p>多个进程的IO可以注册到同一个管道上，这个管道会统一和内核进行交互。当管道中的某一个请求需要的数据准备好之后，进程再把对应的数据拷贝到用户空间中。</p>
<p>IO多路转接是多了一个select函数，多个进程的IO可以注册到同一个select上，当用户进程调用该select，select会监听所有注册好的IO，如果所有被监听的IO需要的数据都没有准备好时，select调用进程会阻塞。当任意一个IO所需的数据准备好之后，select调用就会返回，然后进程在通过recvfrom来进行数据拷贝。</p>
<p><strong>这里的IO复用模型，并没有向内核注册信号处理函数，所以，它并不是非阻塞的。</strong>进程在发出select后，要等到select监听的所有IO操作中至少有一个需要的数据准备好，才会有返回，并且也需要再次发送请求去进行文件的拷贝。</p>
<p><img src="/imgs/io%E6%B5%81/io%E5%A4%8D%E7%94%A8%E6%A8%A1%E5%9E%8B.png" alt="io复用模型"></p>
<h4 id="举例-2"><a href="#举例-2" class="headerlink" title="举例"></a>举例</h4><p>我们钓鱼的时候，为了保证可以最短的时间钓到最多的鱼，我们同一时间摆放多个鱼竿，同时钓鱼。然后哪个鱼竿有鱼儿咬钩了，我们就把哪个鱼竿上面的鱼钓起来。</p>
<p>这种方式的钓鱼，通过增加鱼竿的方式，可以有效的提升效率。</p>
<h3 id="信号驱动IO模型"><a href="#信号驱动IO模型" class="headerlink" title="信号驱动IO模型"></a>信号驱动IO模型</h3><p>应用进程在读取文件时通知内核，如果某个 socket 的某个事件发生时，请向我发一个信号。在收到信号后，信号对应的处理函数会进行后续处理。</p>
<p>应用进程预先向内核注册一个信号处理函数，然后用户进程返回，并且不阻塞，当内核数据准备就绪时会发送一个信号给进程，用户进程便在信号处理函数中开始把数据拷贝的用户空间中。</p>
<p><img src="/imgs/io%E6%B5%81/%E4%BF%A1%E5%8F%B7%E9%A9%B1%E5%8A%A8io%E6%A8%A1%E5%9E%8B.png" alt="信号驱动io模型"></p>
<h4 id="举例-3"><a href="#举例-3" class="headerlink" title="举例"></a>举例</h4><p>我们钓鱼的时候，为了避免自己一遍一遍的去查看鱼竿，我们可以给鱼竿安装一个报警器。当有鱼儿咬钩的时候立刻报警。然后我们再收到报警后，去把鱼钓起来。</p>
<p>这种方式钓鱼，和前几种相比，所使用的工具有了一些变化，需要有一些定制（实现复杂）。但是钓鱼的人就可以在鱼儿咬钩之前彻底做别的事儿去了。等着报警器响就行了。</p>
<h3 id="异步IO模型"><a href="#异步IO模型" class="headerlink" title="异步IO模型"></a>异步IO模型</h3><p>应用进程把IO请求传给内核后，完全由内核去操作文件拷贝。内核完成相关操作后，会发信号告诉应用进程本次IO已经完成。</p>
<p>用户进程发起aio_read操作之后，给内核传递描述符、缓冲区指针、缓冲区大小等，告诉内核当整个操作完成时，如何通知进程，然后就立刻去做其他事情了。当内核收到aio_read后，会立刻返回，然后内核开始等待数据准备，数据准备好以后，直接把数据拷贝到用户控件，然后再通知进程本次IO已经完成。</p>
<p><img src="/imgs/io%E6%B5%81/%E5%BC%82%E6%AD%A5io%E6%A8%A1%E5%9E%8B.png" alt="异步io模型"></p>
<h4 id="举例-4"><a href="#举例-4" class="headerlink" title="举例"></a>举例</h4><p>我们钓鱼的时候，采用一种高科技钓鱼竿，即全自动钓鱼竿。可以自动感应鱼上钩，自动收竿，更厉害的可以自动把鱼放进鱼篓里。然后，通知我们鱼已经钓到了，他就继续去钓下一条鱼去了。</p>
<p>这种方式的钓鱼，无疑是最省事儿的。啥都不需要管，只需要交给鱼竿就可以了。</p>
<h3 id="5种IO模型对比"><a href="#5种IO模型对比" class="headerlink" title="5种IO模型对比"></a>5种IO模型对比</h3><p>阻塞IO模型、非阻塞IO模型、IO复用模型和信号驱动IO模型都是同步的IO模型。原因是无论以上哪种模型，真正的数据拷贝过程，都是同步进行的。</p>
<p><strong>信号驱动难道不是异步的么？</strong> </p>
<p>信号驱动，内核是在数据准备好之后通知进程，然后进程再通过recvfrom操作进行数据拷贝。我们可以认为数据准备阶段是异步的，但是，数据拷贝操作是同步的。所以，整个IO过程也不能认为是异步的。</p>
<h4 id="举例-5"><a href="#举例-5" class="headerlink" title="举例"></a>举例</h4><p>我们把钓鱼过程，可以拆分为两个步骤：1、鱼咬钩（数据准备）。2、把鱼钓起来放进鱼篓里（数据拷贝）。无论以上提到的哪种钓鱼方式，在第二步，都是需要人主动去做的，并不是鱼竿自己完成的。所以，这个钓鱼过程其实还是同步进行的。</p>
<p><img src="/imgs/io%E6%B5%81/5%E7%A7%8Dio%E6%A8%A1%E5%9E%8B%E5%AF%B9%E6%AF%94.png" alt="5种io模型对比"></p>
<h2 id="select、poll、epoll-对比"><a href="#select、poll、epoll-对比" class="headerlink" title="select、poll、epoll 对比"></a>select、poll、epoll 对比</h2><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000003063859">https://segmentfault.com/a/1190000003063859</a></p>
<h2 id="java-网络编程模型"><a href="#java-网络编程模型" class="headerlink" title="java 网络编程模型"></a>java 网络编程模型</h2><p>java 支持 3 种网络编程模型：BIO、NIO、AIO。</p>
<h3 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h3><p><strong>同步并阻塞</strong>（传统阻塞型），服务器实现模式为一个连接一个线程，即客户端有连接请求时服务器端就需要启动一个线程进行处理，如果这个连接不作任何事情会造成不必要的线程开销，可以通过线程池机制改善。</p>
<h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h3><p><strong>同步非阻塞</strong>，服务器实现模式为一个线程处理多个请求(连接)，即客户端发送的连接请求会被注册到多路复用器上，多路复用器轮询到有 I/O 请求就会进行处理。</p>
<h4 id="NIO-特性"><a href="#NIO-特性" class="headerlink" title="NIO 特性"></a>NIO 特性</h4><p>NIO 主要有三大核心部分：Channel(通道)，Buffer(缓冲区), Selector。</p>
<p>传统 IO 基于字节流和字符流进行操作，而 NIO 基于 Channel 和 Buffer(缓冲区)进行操作，数据总是从通道读取到缓冲区中，或者从缓冲区写入到通道中。</p>
<p>Selector(选择区)用于监听多个通道的事件（比如：连接打开，数据到达）。因此，单个线程可以监听多个数据通道</p>
<!-- NIO详细介绍参考：[]() -->

<h4 id="NIO-与-BIO-的区别"><a href="#NIO-与-BIO-的区别" class="headerlink" title="NIO 与 BIO 的区别"></a>NIO 与 BIO 的区别</h4><ul>
<li>BIO 是面向流的，NIO 是面向缓冲区的。</li>
<li>BIO 流是阻塞的，NIO 流是非阻塞的。</li>
<li>BIO 基于字节流和字符流进行操作，而 NIO 基于 Channel（通道）和 Buffer（缓冲区）进行操作，数据总是从通道读取到缓冲区中，或者从缓冲区写入到通道中。</li>
<li>NIO 有Selector（选择器），而 BIO 没有。选择器用于监听多个通道事件（比如连接请求，数据到达等），因此使用单个线程就可以监听多个客户端通道。</li>
</ul>
<h5 id="文件读取示例"><a href="#文件读取示例" class="headerlink" title="文件读取示例"></a>文件读取示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IoTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(IoTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String filePath = ApplicationConfig.getInstance().getFilePath();</span><br><span class="line">        StringBuilder stringBuilder1 = readIo(filePath);</span><br><span class="line">        writeIo(filePath, stringBuilder1);</span><br><span class="line">        StringBuilder stringBuilder2 = readNio(filePath);</span><br><span class="line">        writeNio(filePath, stringBuilder2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> StringBuilder <span class="title">readIo</span><span class="params">(String prePath)</span> </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">int</span> mark = -<span class="number">1</span>;</span><br><span class="line">        String fileName = <span class="string">&quot;io.txt&quot;</span>;</span><br><span class="line">        String filePath = prePath + fileName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            is = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(filePath));</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> readLength;</span><br><span class="line">            ByteArrayOutputStream  byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">while</span> ((readLength = is.read(buffer)) != mark) &#123;</span><br><span class="line">                byteArrayOutputStream.write(buffer, <span class="number">0</span>, readLength);</span><br><span class="line">            &#125;</span><br><span class="line">            stringBuilder.append(byteArrayOutputStream.toString(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            logger.info(<span class="string">&quot;文件 &#123;&#125; 的内容是: &#123;&#125;&quot;</span>, fileName, stringBuilder);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuilder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeIo</span><span class="params">(String prePath, StringBuilder stringBuilder)</span> </span>&#123;</span><br><span class="line">        String fileName = <span class="string">&quot;io-io-out.txt&quot;</span>;</span><br><span class="line">        String filePath = prePath + fileName;</span><br><span class="line">        OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = stringBuilder.toString().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">            logger.info(<span class="string">&quot;bytes长度: &#123;&#125;&quot;</span>, bytes.length);</span><br><span class="line">            os = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(filePath));</span><br><span class="line">            os.write(bytes);</span><br><span class="line">            logger.info(<span class="string">&quot;写入文件: &#123;&#125;&quot;</span>, bytes.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    os.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> StringBuilder <span class="title">readNio</span><span class="params">(String prePath)</span> </span>&#123;</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">int</span> mark = -<span class="number">1</span>;</span><br><span class="line">        String fileName = <span class="string">&quot;io.txt&quot;</span>;</span><br><span class="line">        String filePath = prePath + fileName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(filePath);</span><br><span class="line">            FileChannel channel = fis.getChannel();</span><br><span class="line">            <span class="comment">// 分配空间</span></span><br><span class="line">            ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从channel中读取数据到buffer</span></span><br><span class="line">            <span class="keyword">int</span> read;</span><br><span class="line">            ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">while</span> ((read = channel.read(byteBuffer)) != mark) &#123;</span><br><span class="line">                <span class="comment">// 翻转缓冲区，position设置为0，limit设置为之前position的值</span></span><br><span class="line">                byteBuffer.flip();</span><br><span class="line">                <span class="keyword">byte</span>[] temp = <span class="keyword">new</span> <span class="keyword">byte</span>[read];</span><br><span class="line"><span class="comment">//                byte[] temp = new byte[byteBuffer.remaining()];</span></span><br><span class="line">                byteBuffer.get(temp);</span><br><span class="line">                byteArrayOutputStream.write(temp);</span><br><span class="line"></span><br><span class="line">                byteBuffer.compact();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            stringBuilder.append(byteArrayOutputStream.toString(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            logger.info(<span class="string">&quot;文件 &#123;&#125; 的内容是: &#123;&#125;&quot;</span>, fileName, stringBuilder);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuilder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FileChannel不可以设置为非阻塞模式，他只能在阻塞模式下运行。</span></span><br><span class="line"><span class="comment">     * 原因：磁盘io相对于网络io，获取io状态是很快的，拿到文件描述符就知道了文件是否可读写</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeNio</span><span class="params">(String prePath, StringBuilder stringBuilder)</span> </span>&#123;</span><br><span class="line">        String fileName = <span class="string">&quot;io-nio-out.txt&quot;</span>;</span><br><span class="line">        String filePath = prePath + fileName;</span><br><span class="line">        FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ByteBuffer byteBuffer = ByteBuffer.wrap(stringBuilder.toString().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">// 字节缓冲的容量和limit会随着数据长度变化，不是固定不变的</span></span><br><span class="line">            logger.info(<span class="string">&quot;初始化容量: &#123;&#125;, limit：&#123;&#125;&quot;</span>, byteBuffer.capacity(), byteBuffer.limit());</span><br><span class="line">            fos = <span class="keyword">new</span> FileOutputStream(filePath);</span><br><span class="line">            FileChannel channel = fos.getChannel();</span><br><span class="line">            channel.write(byteBuffer);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((length = channel.write(byteBuffer)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 注意，这里不需要clear，将缓冲中的数据写入到通道中后 第二次接着上一次的顺序往下读</span></span><br><span class="line">                logger.info(<span class="string">&quot;写入长度: &#123;&#125;&quot;</span>, length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="NIO-三大核心关系"><a href="#NIO-三大核心关系" class="headerlink" title="NIO 三大核心关系"></a>NIO 三大核心关系</h4><p><img src="/imgs/io%E6%B5%81/nio%E4%B8%89%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%85%B3%E7%B3%BB.png" alt="nio三大组件关系"></p>
<h4 id="NIO-三大核心理解"><a href="#NIO-三大核心理解" class="headerlink" title="NIO 三大核心理解"></a>NIO 三大核心理解</h4><p><img src="/imgs/io%E6%B5%81/nio%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E7%90%86%E8%A7%A3.png" alt="nio三大核心理解"></p>
<h4 id="Buffer-缓冲区"><a href="#Buffer-缓冲区" class="headerlink" title="Buffer 缓冲区"></a>Buffer 缓冲区</h4><p>缓冲区本质上是一个可以读写数据的内存块，可以理解为是一个容器对象（含数组），该对象提供了一组方法，可以更轻松地使用内存块，缓冲区对象内置了一些机制，能够跟踪和记录缓冲区的状态变化情况。</p>
<p>Channel 提供从文件、网络读取数据的渠道，但是读取或者都必须经过 Buffer。</p>
<h5 id="Buffer-数据存储结构"><a href="#Buffer-数据存储结构" class="headerlink" title="Buffer 数据存储结构"></a>Buffer 数据存储结构</h5><p>在 Buffer 子类中维护着一个对应类型的数组，用来存放数据</p>
<p><strong>源码片段</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteBuffer</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">Buffer</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">ByteBuffer</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// These fields are declared here rather than in Heap-X-Buffer in order to</span></span><br><span class="line">    <span class="comment">// reduce the number of virtual method invocations needed to access these</span></span><br><span class="line">    <span class="comment">// values, which is especially costly when coding small buffers.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] hb;                  <span class="comment">// Non-null only for heap buffers</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> offset;</span><br><span class="line">    <span class="keyword">boolean</span> isReadOnly;                 <span class="comment">// Valid only for heap buffers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Creates a new buffer with the given mark, position, limit, capacity,</span></span><br><span class="line">    <span class="comment">// backing array, and array offset</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    ByteBuffer(<span class="keyword">int</span> mark, <span class="keyword">int</span> pos, <span class="keyword">int</span> lim, <span class="keyword">int</span> cap,   <span class="comment">// package-private</span></span><br><span class="line">                 <span class="keyword">byte</span>[] hb, <span class="keyword">int</span> offset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">super</span>(mark, pos, lim, cap);</span><br><span class="line">        <span class="keyword">this</span>.hb = hb;</span><br><span class="line">        <span class="keyword">this</span>.offset = offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Creates a new buffer with the given mark, position, limit, and capacity</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    ByteBuffer(<span class="keyword">int</span> mark, <span class="keyword">int</span> pos, <span class="keyword">int</span> lim, <span class="keyword">int</span> cap) &#123; <span class="comment">// package-private</span></span><br><span class="line">        <span class="keyword">this</span>(mark, pos, lim, cap, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Buffer-位置变量"><a href="#Buffer-位置变量" class="headerlink" title="Buffer 位置变量"></a>Buffer 位置变量</h5><p>Buffer 通过几个变量来保存这个数据的当前位置状态</p>
<table>
<thead>
<tr>
<th align="center">capacity</th>
<th align="center">容量，即可以容纳的最大数据量；在缓冲区被创建时候就被指定，无法修改</th>
</tr>
</thead>
<tbody><tr>
<td align="center">limit</td>
<td align="center">表示缓冲区的当前终点，不能对缓冲区超过极限的位置进行读写操作，但极限是可以修改的</td>
</tr>
<tr>
<td align="center">position</td>
<td align="center">当前位置，下一个要被读或者写的索引，每次读写缓冲区数据都会改变该值，为下次读写做准备</td>
</tr>
<tr>
<td align="center">Mark</td>
<td align="center">标记当前 position 位置，当 reset 后回到标记位置。</td>
</tr>
</tbody></table>
<p><strong>源码片段</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Spliterator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Buffer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The characteristics of Spliterators that traverse and split elements</span></span><br><span class="line"><span class="comment">     * maintained in Buffers.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SPLITERATOR_CHARACTERISTICS =</span><br><span class="line">        Spliterator.SIZED | Spliterator.SUBSIZED | Spliterator.ORDERED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invariants: mark &lt;= position &lt;= limit &lt;= capacity</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mark = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> limit;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used only by direct buffers</span></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> hoisted here for speed in JNI GetDirectBufferAddress</span></span><br><span class="line">    <span class="keyword">long</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Creates a new buffer with the given mark, position, limit, and capacity,</span></span><br><span class="line">    <span class="comment">// after checking invariants.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    Buffer(<span class="keyword">int</span> mark, <span class="keyword">int</span> pos, <span class="keyword">int</span> lim, <span class="keyword">int</span> cap) &#123;       <span class="comment">// package-private</span></span><br><span class="line">        <span class="keyword">if</span> (cap &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Negative capacity: &quot;</span> + cap);</span><br><span class="line">        <span class="keyword">this</span>.capacity = cap;</span><br><span class="line">        limit(lim);</span><br><span class="line">        position(pos);</span><br><span class="line">        <span class="keyword">if</span> (mark &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mark &gt; pos)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;mark &gt; position: (&quot;</span></span><br><span class="line">                                                   + mark + <span class="string">&quot; &gt; &quot;</span> + pos + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.mark = mark;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets this buffer&#x27;s position.  If the mark is defined and larger than the</span></span><br><span class="line"><span class="comment">     * new position then it is discarded.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  newPosition</span></span><br><span class="line"><span class="comment">     *         The new position value; must be non-negative</span></span><br><span class="line"><span class="comment">     *         and no larger than the current limit</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  This buffer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span>  IllegalArgumentException</span></span><br><span class="line"><span class="comment">     *          If the preconditions on &lt;tt&gt;newPosition&lt;/tt&gt; do not hold</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">position</span><span class="params">(<span class="keyword">int</span> newPosition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((newPosition &gt; limit) || (newPosition &lt; <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        position = newPosition;</span><br><span class="line">        <span class="keyword">if</span> (mark &gt; position) mark = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets this buffer&#x27;s limit.  If the position is larger than the new limit</span></span><br><span class="line"><span class="comment">     * then it is set to the new limit.  If the mark is defined and larger than</span></span><br><span class="line"><span class="comment">     * the new limit then it is discarded.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  newLimit</span></span><br><span class="line"><span class="comment">     *         The new limit value; must be non-negative</span></span><br><span class="line"><span class="comment">     *         and no larger than this buffer&#x27;s capacity</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  This buffer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span>  IllegalArgumentException</span></span><br><span class="line"><span class="comment">     *          If the preconditions on &lt;tt&gt;newLimit&lt;/tt&gt; do not hold</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">limit</span><span class="params">(<span class="keyword">int</span> newLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((newLimit &gt; capacity) || (newLimit &lt; <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        limit = newLimit;</span><br><span class="line">        <span class="keyword">if</span> (position &gt; limit) position = limit;</span><br><span class="line">        <span class="keyword">if</span> (mark &gt; limit) mark = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Buffer-关键子类"><a href="#Buffer-关键子类" class="headerlink" title="Buffer 关键子类"></a>Buffer 关键子类</h5><table>
<thead>
<tr>
<th>Buffer</th>
<th>数据类型</th>
</tr>
</thead>
<tbody><tr>
<td>ByteBuffer</td>
<td>byte</td>
</tr>
<tr>
<td>CharBuffer</td>
<td>char</td>
</tr>
<tr>
<td>DoubleBuffer</td>
<td>double</td>
</tr>
<tr>
<td>FloatBuffer</td>
<td>float</td>
</tr>
<tr>
<td>IntBuffer</td>
<td>int</td>
</tr>
<tr>
<td>LongBuffer</td>
<td>long</td>
</tr>
<tr>
<td>ShortBuffer</td>
<td>short</td>
</tr>
<tr>
<td>MappedByteBuffer</td>
<td>-</td>
</tr>
<tr>
<td>HeapByteBuffer</td>
<td>-</td>
</tr>
<tr>
<td>DirectByteBuffer</td>
<td>-</td>
</tr>
</tbody></table>
<h5 id="Buffer-方法"><a href="#Buffer-方法" class="headerlink" title="Buffer 方法"></a>Buffer 方法</h5><table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>allocate(int capacity)</td>
<td>从堆空间中分配一个容量大小为capacity的byte数组作为缓冲区的byte数据存储器</td>
</tr>
<tr>
<td>allocateDirect(int capacity)</td>
<td>是不使用JVM堆栈而是通过操作系统来创建内存块用作缓冲区，它与当前操作系统能够更好的耦合，因此能进一步提高I/O操作速度。但是分配直接缓冲区的系统开销很大，因此只有在缓冲区较大并长期存在，或者需要经常重用时，才使用这种缓冲区</td>
</tr>
<tr>
<td>wrap(byte[] array)</td>
<td>这个缓冲区的数据会存放在byte数组中，bytes数组或buff缓冲区任何一方中数据的改动都会影响另一方。其实ByteBuffer底层本来就有一个bytes数组负责来保存buffer缓冲区中的数据，通过allocate方法系统会帮你构造一个byte数组</td>
</tr>
<tr>
<td>wrap(byte[] array, int offset, int length)</td>
<td>在上一个方法的基础上可以指定偏移量和长度，这个offset也就是包装后byteBuffer的position，而length呢就是limit-position的大小，从而我们可以得到limit的位置为length+position(offset)</td>
</tr>
<tr>
<td>limit(), limit(10)等</td>
<td>其中读取和设置这4个属性的方法的命名和jQuery中的val(),val(10)类似，一个负责get，一个负责set</td>
</tr>
<tr>
<td>reset()</td>
<td>把position设置成mark的值，相当于之前做过一个标记，现在要退回到之前标记的地方</td>
</tr>
<tr>
<td>clear()</td>
<td>position = 0;limit = capacity;mark = -1;  有点初始化的味道，但是并不影响底层byte数组的内容</td>
</tr>
<tr>
<td>flip()</td>
<td>limit = position;position = 0;mark = -1;  翻转，也就是让flip之后的position到limit这块区域变成之前的0到position这块，翻转就是将一个处于存数据状态的缓冲区变为一个处于准备取数据的状态</td>
</tr>
<tr>
<td>rewind()</td>
<td>把position设为0，mark设为-1，不改变limit的值</td>
</tr>
<tr>
<td>remaining()</td>
<td>return limit - position; 返回limit和position之间相对位置差</td>
</tr>
<tr>
<td>hasRemaining()</td>
<td>return position &lt; limit返回是否还有未读内容</td>
</tr>
<tr>
<td>compact()</td>
<td>把从position到limit中的内容移到0到limit-position的区域内，position和limit的取值也分别变成limit-position、capacity。如果先将positon设置到limit，再compact，那么相当于clear()</td>
</tr>
<tr>
<td>get()</td>
<td>相对读，从position位置读取一个byte，并将position+1，为下次读写作准备</td>
</tr>
<tr>
<td>get(int index)</td>
<td>绝对读，读取byteBuffer底层的bytes中下标为index的byte，不改变position</td>
</tr>
<tr>
<td>get(byte[] dst, int offset, int length)</td>
<td>从position位置开始相对读，读length个byte，并写入dst下标从offset到offset+length的区域</td>
</tr>
<tr>
<td>put(byte b)</td>
<td>相对写，向position的位置写入一个byte，并将postion+1，为下次读写作准备</td>
</tr>
<tr>
<td>put(int index, byte b)</td>
<td>绝对写，向byteBuffer底层的bytes中下标为index的位置插入byte b，不改变position</td>
</tr>
<tr>
<td>put(ByteBuffer src)</td>
<td>用相对写，把src中可读的部分（也就是position到limit）写入此byteBuffer</td>
</tr>
<tr>
<td>put(byte[] src, int offset, int length)</td>
<td>从src数组中的offset到offset+length区域读取数据并使用相对写写入此byteBuffer</td>
</tr>
</tbody></table>
<h4 id="Channel-通道"><a href="#Channel-通道" class="headerlink" title="Channel 通道"></a>Channel 通道</h4><p>Channel和IO中的Stream(流)类似，但有如下区别：</p>
<ol>
<li>通道是双向的可以进行读写，而流是单向的只能读，或者写。</li>
<li>通道可以实现异步读写数据。</li>
<li>通道可以从缓冲区读取数据，也可以写入数据到缓冲区。</li>
</ol>
<h5 id="主要-Channel"><a href="#主要-Channel" class="headerlink" title="主要 Channel"></a>主要 Channel</h5><table>
<thead>
<tr>
<th>Channel</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>FileChannel</td>
<td>IO</td>
</tr>
<tr>
<td>DatagramChannel</td>
<td>UDP</td>
</tr>
<tr>
<td>SocketChannel</td>
<td>TCP(client)</td>
</tr>
<tr>
<td>ServerSocketChannel</td>
<td>TCP(server)</td>
</tr>
</tbody></table>
<h5 id="FileChannel-示例"><a href="#FileChannel-示例" class="headerlink" title="FileChannel 示例"></a>FileChannel 示例</h5><p>FileChannel 主要用来对本地文件进行 IO 操作，常见的方法有：</p>
<ol>
<li>public int read(ByteBuffer dst) ：从通道中读取数据到缓冲区中。</li>
<li>public int write(ByteBuffer src)：把缓冲区中的数据写入到通道中。</li>
<li>public long transferFrom(ReadableByteChannel src, long position, long count)：从目标通道中复制数据到当前通道。</li>
<li>public long transferTo(long position, long count, WriteableByteChannel target)：把数据从当前通道复制给目标通道。</li>
</ol>
<h6 id="文件读写-stream-和-channel-示例"><a href="#文件读写-stream-和-channel-示例" class="headerlink" title="文件读写 stream 和 channel 示例"></a>文件读写 stream 和 channel 示例</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> test.ApplicationConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IoTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(IoTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String filePath = ApplicationConfig.getInstance().getFilePath();</span><br><span class="line">        StringBuilder stringBuilder1 = readIo(filePath);</span><br><span class="line">        writeIo(filePath, stringBuilder1);</span><br><span class="line">        StringBuilder stringBuilder2 = readNio(filePath);</span><br><span class="line">        writeNio(filePath, stringBuilder2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> StringBuilder <span class="title">readIo</span><span class="params">(String prePath)</span> </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">int</span> mark = -<span class="number">1</span>;</span><br><span class="line">        String fileName = <span class="string">&quot;io.txt&quot;</span>;</span><br><span class="line">        String filePath = prePath + fileName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            is = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(filePath));</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> readLength;</span><br><span class="line">            ByteArrayOutputStream  byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">while</span> ((readLength = is.read(buffer)) != mark) &#123;</span><br><span class="line">                byteArrayOutputStream.write(buffer, <span class="number">0</span>, readLength);</span><br><span class="line">            &#125;</span><br><span class="line">            stringBuilder.append(byteArrayOutputStream.toString(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            logger.info(<span class="string">&quot;文件 &#123;&#125; 的内容是: &#123;&#125;&quot;</span>, fileName, stringBuilder);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuilder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeIo</span><span class="params">(String prePath, StringBuilder stringBuilder)</span> </span>&#123;</span><br><span class="line">        String fileName = <span class="string">&quot;io-io-out.txt&quot;</span>;</span><br><span class="line">        String filePath = prePath + fileName;</span><br><span class="line">        OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = stringBuilder.toString().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">            logger.info(<span class="string">&quot;bytes长度: &#123;&#125;&quot;</span>, bytes.length);</span><br><span class="line">            os = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(filePath));</span><br><span class="line">            os.write(bytes);</span><br><span class="line">            logger.info(<span class="string">&quot;写入文件: &#123;&#125;&quot;</span>, bytes.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    os.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> StringBuilder <span class="title">readNio</span><span class="params">(String prePath)</span> </span>&#123;</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">int</span> mark = -<span class="number">1</span>;</span><br><span class="line">        String fileName = <span class="string">&quot;io.txt&quot;</span>;</span><br><span class="line">        String filePath = prePath + fileName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(filePath);</span><br><span class="line">            FileChannel channel = fis.getChannel();</span><br><span class="line">            <span class="comment">// 分配空间</span></span><br><span class="line">            ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从channel中读取数据到buffer</span></span><br><span class="line">            <span class="keyword">int</span> read;</span><br><span class="line">            ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">while</span> ((read = channel.read(byteBuffer)) != mark) &#123;</span><br><span class="line">                <span class="comment">// 翻转缓冲区，position设置为0，limit设置为之前position的值</span></span><br><span class="line">                byteBuffer.flip();</span><br><span class="line">                <span class="keyword">byte</span>[] temp = <span class="keyword">new</span> <span class="keyword">byte</span>[read];</span><br><span class="line"><span class="comment">//                byte[] temp = new byte[byteBuffer.remaining()];</span></span><br><span class="line">                byteBuffer.get(temp);</span><br><span class="line">                byteArrayOutputStream.write(temp);</span><br><span class="line"></span><br><span class="line">                byteBuffer.compact();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            stringBuilder.append(byteArrayOutputStream.toString(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            logger.info(<span class="string">&quot;文件 &#123;&#125; 的内容是: &#123;&#125;&quot;</span>, fileName, stringBuilder);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuilder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FileChannel不可以设置为非阻塞模式，他只能在阻塞模式下运行。</span></span><br><span class="line"><span class="comment">     * 原因：磁盘io相对于网络io，获取io状态是很快的，拿到文件描述符就知道了文件是否可读写</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeNio</span><span class="params">(String prePath, StringBuilder stringBuilder)</span> </span>&#123;</span><br><span class="line">        String fileName = <span class="string">&quot;io-nio-out.txt&quot;</span>;</span><br><span class="line">        String filePath = prePath + fileName;</span><br><span class="line">        FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ByteBuffer byteBuffer = ByteBuffer.wrap(stringBuilder.toString().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">// 字节缓冲的容量和limit会随着数据长度变化，不是固定不变的</span></span><br><span class="line">            logger.info(<span class="string">&quot;初始化容量: &#123;&#125;, limit：&#123;&#125;&quot;</span>, byteBuffer.capacity(), byteBuffer.limit());</span><br><span class="line">            fos = <span class="keyword">new</span> FileOutputStream(filePath);</span><br><span class="line">            FileChannel channel = fos.getChannel();</span><br><span class="line">            channel.write(byteBuffer);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((length = channel.write(byteBuffer)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 注意，这里不需要clear，将缓冲中的数据写入到通道中后 第二次接着上一次的顺序往下读</span></span><br><span class="line">                logger.info(<span class="string">&quot;写入长度: &#123;&#125;&quot;</span>, length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="通道间数据复制"><a href="#通道间数据复制" class="headerlink" title="通道间数据复制"></a>通道间数据复制</h6><ol>
<li>直接复制</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">channelCopy</span><span class="params">(String prePath)</span> </span>&#123;</span><br><span class="line">    String inFileName = <span class="string">&quot;io.txt&quot;</span>;</span><br><span class="line">    String outFileName = <span class="string">&quot;io-channel-copy.txt&quot;</span>;</span><br><span class="line">    String inFilePath = prePath + inFileName;</span><br><span class="line">    String outFilePath = prePath + outFileName;</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fis= <span class="keyword">new</span> FileInputStream(inFilePath);</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(outFilePath);</span><br><span class="line">        FileChannel inChannel = fis.getChannel();</span><br><span class="line">        FileChannel outChannel = fos.getChannel();</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span> (inChannel.read(byteBuffer) != -<span class="number">1</span>) &#123;</span><br><span class="line">            byteBuffer.flip();</span><br><span class="line">            outChannel.write(byteBuffer);</span><br><span class="line">            <span class="comment">//清空重置</span></span><br><span class="line">            byteBuffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fis.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fos.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用transferFrom或transferTo复制</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">transferFromOrTo</span><span class="params">(String prePath)</span> </span>&#123;</span><br><span class="line">    String inFileName = <span class="string">&quot;io.txt&quot;</span>;</span><br><span class="line">    String outFileName1 = <span class="string">&quot;io-transfer-from.txt&quot;</span>;</span><br><span class="line">    String outFileName2 = <span class="string">&quot;io-transfer-to.txt&quot;</span>;</span><br><span class="line">    String inFilePath = prePath + inFileName;</span><br><span class="line">    String outFilePath1 = prePath + outFileName1;</span><br><span class="line">    String outFilePath2 = prePath + outFileName2;</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos1 = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fis= <span class="keyword">new</span> FileInputStream(inFilePath);</span><br><span class="line">        fos1 = <span class="keyword">new</span> FileOutputStream(outFilePath1);</span><br><span class="line">        fos2 = <span class="keyword">new</span> FileOutputStream(outFilePath2);</span><br><span class="line">        FileChannel inChannel = fis.getChannel();</span><br><span class="line">        FileChannel outChannel1 = fos1.getChannel();</span><br><span class="line">        FileChannel outChannel2 = fos2.getChannel();</span><br><span class="line">        <span class="comment">// transferFrom方法，从哪拷贝，从哪个位置开始拷贝多长</span></span><br><span class="line">        outChannel1.transferFrom(inChannel, <span class="number">0</span>, inChannel.size());</span><br><span class="line">        <span class="comment">// transferTo方法，拷贝到哪儿，从哪个位置开始拷贝多长</span></span><br><span class="line">        inChannel.transferTo(<span class="number">0</span>, inChannel.size(), outChannel2);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fis.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fos1 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fos1.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fos2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fos2.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Channel-和-Buffer-的注意事项"><a href="#Channel-和-Buffer-的注意事项" class="headerlink" title="Channel 和 Buffer 的注意事项"></a>Channel 和 Buffer 的注意事项</h5><ol>
<li>ByteBuffer 支持类型化的 put 和 get，put 放入什么数据类型，get 就应该使用相应的数据类型来取出，否则可能会产生 ByteUnderflowException 异常。</li>
<li>可以将一个普通的 Buffer 转换为只读的 Buffer：asReadOnlyBuffer()方法。</li>
<li>NIO 提供了 MapperByteBuffer，可以让文件直接在内存（堆外内存）中进行修改，而如何同步到文件由 NIO 来完成。</li>
<li>NIO 还支持通过多个 Buffer(即 Buffer 数组)完成读写操作，即Scattering（分散）和 Gathering（聚集）。<ul>
<li>Scattering(分散)：在向缓冲区写入数据时，可以使用 Buffer 数组依次写入，一个 Buffer 数组写满后，继续写入下一个 Buffer 数组。</li>
<li>Gathering(聚集)：从缓冲区读取数据时，可以依次读取，读完一个 Buffer 再按顺序读取下一个。</li>
</ul>
</li>
</ol>
<h4 id="Selector-选择器"><a href="#Selector-选择器" class="headerlink" title="Selector 选择器"></a>Selector 选择器</h4><p>选择器是NIO的核心，它是channel的管理者，通过执行select()阻塞方法，监听是否有channel准备好，一旦有数据可读，此方法的返回值是SelectionKey的数量</p>
<p>所以服务端通常会死循环执行select()方法，直到有channl准备就绪，然后开始工作，每个channel都会和Selector绑定一个事件，然后生成一个SelectionKey的对象</p>
<p>SelectionKey 一共有四种事件：</p>
<p>SelectionKey.OP_CONNECT：连接事件<br>SelectionKey.OP_ACCEPT：接收事件<br>SelectionKey.OP_READ：读事件<br>SelectionKey.OP_WRITE：写事件</p>
<p><strong>注意</strong></p>
<p>channel和Selector绑定时，channel必须是非阻塞模式，而FileChannel不能切换到非阻塞模式，因为它不是套接字通道，所以FileChannel不能和Selector绑定事件</p>
<h5 id="Selector-常用方法"><a href="#Selector-常用方法" class="headerlink" title="Selector 常用方法"></a>Selector 常用方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Selector</span> <span class="title">implement</span> <span class="title">Closeable</span></span>&#123;</span><br><span class="line">    <span class="comment">// 得到一个选择器对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Selector <span class="title">open</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监控所有注册的通道，当其中的IO操作可以进行时，将对应的SelectionKey加入内部集合并返回，参数设置超时时间</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">long</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若未监听到注册管道中有事件，则持续阻塞</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">select</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不阻塞，立即返回</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">selectNow</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 唤醒selector</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Selector <span class="title">wakeup</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从内部集合中得到所有的SelectionKey</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Set&lt;SelectionKey&gt; <span class="title">selectionKeys</span><span class="params">()</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SelectionKey"><a href="#SelectionKey" class="headerlink" title="SelectionKey"></a>SelectionKey</h5><p>当向Selector注册Channel时，register()方法会返回一个SelectionKey对象。这个对象包含以下的属性：</p>
<ol>
<li>interest集合</li>
<li>ready集合</li>
<li>Channel</li>
<li>Selector</li>
<li>附加的对象（可选）</li>
</ol>
<p>interest集合: 是你所选择的感兴趣的事件集合。可以通过SelectionKey读写interest集合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> interestSet = selectionKey.interestOps();</span><br></pre></td></tr></table></figure>

<p>ready集合: 是通道已经准备就绪的操作的集合。在一次选择(Selection)之后，你会首先访问这个ready set。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> readySet = selectionKey.readyOps();</span><br></pre></td></tr></table></figure>

<p>检测channel中什么事件或操作已经就绪的方法：</p>
<ul>
<li>selectionKey.isAcceptable();</li>
<li>selectionKey.isConnectable();</li>
<li>selectionKey.isReadable();</li>
<li>selectionKey.isWritable();</li>
</ul>
<p>从SelectionKey访问Channel和Selector:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Channel  channel  = selectionKey.channel();</span><br><span class="line">Selector selector = selectionKey.selector();</span><br></pre></td></tr></table></figure>

<p>可以将一个对象或者更多信息附着到SelectionKey上，这样就能方便的识别某个给定的通道。例如，可以附加与通道一起使用的Buffer或是包含聚集数据的某个对象。使用方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">selectionKey.attach(theObject);</span><br><span class="line">Object attachedObj = selectionKey.attachment();</span><br></pre></td></tr></table></figure>

<p>还可以在用register()方法向Selector注册Channel的时候附加对象。如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SelectionKey key = channel.register(selector, SelectionKey.OP_READ, theObject);</span><br></pre></td></tr></table></figure>

<p>需要注意的是如果附加的对象不再使用，一定要人为清除，因为垃圾回收器不会回收该对象，若不清除的话会成内存泄漏。</p>
<p>一个单独的通道可被注册到多个选择器中，有些时候我们需要通过isRegistered（）方法来检查一个通道是否已经被注册到任何一个选择器上。 通常来说，我们并不会这么做。</p>
<h4 id="NIO-事件"><a href="#NIO-事件" class="headerlink" title="NIO 事件"></a>NIO 事件</h4><ul>
<li>客户端的SocketChannel支持 OP_CONNECT, OP_READ, OP_WRITE三个操作</li>
<li>服务端ServerSocketChannel只支持OP_ACCEPT操作</li>
<li>在服务端由ServerSocketChannel的accept()方法产生的SocketChannel只支持OP_READ, OP_WRITE操作</li>
</ul>
<table>
<thead>
<tr>
<th align="center">client/Server</th>
<th align="center">SocketChannel/ServerSocketChannel</th>
<th align="center">OP_ACCEPT</th>
<th align="center">OP_CONNECT</th>
<th align="center">OP_WRITE</th>
<th align="center">OP_READ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">client</td>
<td align="center">SocketChannel</td>
<td align="center"></td>
<td align="center">Y</td>
<td align="center">Y</td>
<td align="center">Y</td>
</tr>
<tr>
<td align="center">server</td>
<td align="center">ServerSocketChannel</td>
<td align="center">Y</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">server</td>
<td align="center">SocketChannel</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">Y</td>
<td align="center">Y</td>
</tr>
</tbody></table>
<h4 id="NIO-实现群聊"><a href="#NIO-实现群聊" class="headerlink" title="NIO 实现群聊"></a>NIO 实现群聊</h4><h5 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/5/4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioServerTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(NioServerTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NioServerTest nioServerTest = <span class="keyword">new</span> NioServerTest();</span><br><span class="line">        nioServerTest.init();</span><br><span class="line">        nioServerTest.listen();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line">    <span class="keyword">private</span> ServerSocketChannel listenChannel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> port = <span class="number">8888</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建通道管理对象Selector</span></span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            <span class="comment">// 创建通道对象Channel</span></span><br><span class="line">            listenChannel = ServerSocketChannel.open();</span><br><span class="line">            <span class="comment">// 将通道设置为非阻塞</span></span><br><span class="line">            listenChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 绑定端口</span></span><br><span class="line">            InetSocketAddress inetSocketAddress = <span class="keyword">new</span> InetSocketAddress(<span class="keyword">this</span>.port);</span><br><span class="line">            listenChannel.socket().bind(inetSocketAddress);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将通道与通道管理器绑定，并为通道注册 OP_ACCEPT 事件（接收事件）</span></span><br><span class="line">            <span class="comment">// 注册事件后，当事件到达时，selector.select()会返回一个key，如果该事件没有到达selector.select()会一直阻塞</span></span><br><span class="line">            listenChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 等待读取数据</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selector.select();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将通道中的数据放入集合中</span></span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                SelectionKey key = iterator.next();</span><br><span class="line">                <span class="comment">// 已经拿到数据，将迭代器中的数据删除，避免出错</span></span><br><span class="line">                iterator.remove();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.accept(key);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.read(key);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isWritable() &amp;&amp; key.isValid()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.write(key);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        key.channel().close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                        logger.warn(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    logger.info(<span class="string">&quot;客户端断开了连接...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;等待client连接...&quot;</span>);</span><br><span class="line">        <span class="comment">// ServerSocketChannel只支持OP_ACCEPT操作</span></span><br><span class="line">        ServerSocketChannel serverSocketChannel = (ServerSocketChannel) key.channel();</span><br><span class="line">        <span class="comment">// accept()方法产生的SocketChannel只支持OP_READ, OP_WRITE操作</span></span><br><span class="line">        SocketChannel socketChannel = serverSocketChannel.accept();</span><br><span class="line">        socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        SelectionKey rwKey = socketChannel.register(key.selector(), SelectionKey.OP_READ);</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        rwKey.attach(byteBuffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel socketChannel = (SocketChannel) key.channel();</span><br><span class="line">        ByteBuffer byteBuffer = (ByteBuffer) key.attachment();</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">int</span> read = socketChannel.read(byteBuffer);</span><br><span class="line">        <span class="keyword">while</span> (read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            byteBuffer.flip();</span><br><span class="line">            <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[read];</span><br><span class="line">            byteBuffer.get(data, <span class="number">0</span>, read);</span><br><span class="line">            byteArrayOutputStream.write(data);</span><br><span class="line">            byteBuffer.compact();</span><br><span class="line">            read = socketChannel.read(byteBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;</span><br><span class="line">            socketChannel.close();</span><br><span class="line">        &#125;</span><br><span class="line">        String msg = <span class="keyword">new</span> String(byteArrayOutputStream.toByteArray(), StandardCharsets.UTF_8);</span><br><span class="line">        logger.info(<span class="string">&quot;client &#123;&#125; msg is: &#123;&#125;&quot;</span>, socketChannel.getRemoteAddress(), msg);</span><br><span class="line">        <span class="comment">// 转发消息给其它客户端(排除自己)</span></span><br><span class="line">        transferInfo(msg, socketChannel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">transferInfo</span><span class="params">(String msg, SocketChannel selfChannel)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 服务器转发消息</span></span><br><span class="line">        logger.info(<span class="string">&quot;服务器转发消息中...&quot;</span>);</span><br><span class="line">        <span class="comment">// 遍历所有注册到selector的socketChannel并排除自身</span></span><br><span class="line">        <span class="keyword">for</span> (SelectionKey key : selector.keys()) &#123;</span><br><span class="line">            <span class="comment">// 获取通道</span></span><br><span class="line">            Channel targetChannel = key.channel();</span><br><span class="line">            <span class="comment">// 排除自身</span></span><br><span class="line">            <span class="keyword">if</span> (targetChannel <span class="keyword">instanceof</span> SocketChannel &amp;&amp; targetChannel != selfChannel) &#123;</span><br><span class="line">                <span class="comment">// 将msg存储到buffer中</span></span><br><span class="line">                ByteBuffer byteBuffer = (ByteBuffer) key.attachment();</span><br><span class="line">                <span class="keyword">byte</span>[] data = msg.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">                <span class="comment">// 判断剩余空间是否足够，不够则扩容</span></span><br><span class="line">                <span class="keyword">if</span> (byteBuffer.remaining() &lt; data.length) &#123;</span><br><span class="line">                    byteBuffer = reCapacity(byteBuffer, data.length);</span><br><span class="line">                &#125;</span><br><span class="line">                byteBuffer.put(data);</span><br><span class="line">                <span class="comment">// 注册写事件</span></span><br><span class="line">                key.interestOps(key.interestOps() | SelectionKey.OP_WRITE);</span><br><span class="line">                <span class="comment">// 绑定Buffer</span></span><br><span class="line">                key.attach(byteBuffer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel socketChannel = (SocketChannel) key.channel();</span><br><span class="line">        ByteBuffer byteBuffer = (ByteBuffer) key.attachment();</span><br><span class="line">        <span class="comment">// 转换为读模式</span></span><br><span class="line">        byteBuffer.flip();</span><br><span class="line">        <span class="comment">// 如果通道中还有数据就把它写进ByteBuffer中</span></span><br><span class="line">        <span class="keyword">while</span> (byteBuffer.hasRemaining()) &#123;</span><br><span class="line">            socketChannel.write(byteBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 转换为写模式</span></span><br><span class="line">        byteBuffer.compact();</span><br><span class="line">        <span class="comment">// 发送完了就取消写事件，否则下次还会进入该分支</span></span><br><span class="line">        key.interestOps(key.interestOps() &amp; ~SelectionKey.OP_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ByteBuffer <span class="title">reCapacity</span><span class="params">(ByteBuffer byteBuffer, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> position = byteBuffer.position();</span><br><span class="line">        <span class="keyword">int</span> destCapacity = byteBuffer.capacity();</span><br><span class="line">        <span class="comment">// 每次扩大两倍</span></span><br><span class="line">        <span class="comment">// 进阶：可以设置阈值，超过阈值只扩大指定大小（步进方式），并判断是否达到Integer.MAX_VALUE</span></span><br><span class="line">        <span class="keyword">while</span> (destCapacity - position &lt; length) &#123;</span><br><span class="line">            destCapacity &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ByteBuffer destByteBuffer = ByteBuffer.allocate(destCapacity);</span><br><span class="line">        byteBuffer.flip();</span><br><span class="line"><span class="comment">//        // 调用本方法后 destByteBuffer 会写入整个 byteBuffer 的长度</span></span><br><span class="line"><span class="comment">//        byteBuffer.rewind();</span></span><br><span class="line">        destByteBuffer.put(byteBuffer);</span><br><span class="line">        byteBuffer.clear();</span><br><span class="line">        <span class="keyword">return</span> destByteBuffer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.java.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> C</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/5/4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioClientTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(NioClientTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NioClientTest nioServerTest = <span class="keyword">new</span> NioClientTest();</span><br><span class="line">        nioServerTest.init();</span><br><span class="line">        nioServerTest.listen();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line">    <span class="keyword">private</span> SelectionKey key;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String host = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> port = <span class="number">8888</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建通道管理对象Selector</span></span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            <span class="comment">// 创建通道对象Channel</span></span><br><span class="line">            SocketChannel socketChannel = SocketChannel.open();</span><br><span class="line">            <span class="comment">// 将通道设置为非阻塞</span></span><br><span class="line">            socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 连接服务端</span></span><br><span class="line"><span class="comment">//            InetSocketAddress inetSocketAddress = new InetSocketAddress(port);</span></span><br><span class="line">            InetSocketAddress inetSocketAddress = <span class="keyword">new</span> InetSocketAddress(host, port);</span><br><span class="line">            socketChannel.connect(inetSocketAddress);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 不能在这里使用socketChannel.finishConnect()方法判断是否连接成功，应该放在select()的循环里</span></span><br><span class="line"><span class="comment">             * 原因：finishConnect在连接成功时会消耗一次OP_CONNECT事件，select阻塞了一下后，只有返回0了，导致循环直接退出</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将通道与通道管理器绑定，并为通道注册 OP_CONNECT 事件（连接事件）</span></span><br><span class="line">            <span class="comment">// 注册事件后，当事件到达时，selector.select()会返回一个key，如果该事件没有到达selector.select()会一直阻塞</span></span><br><span class="line">            key = socketChannel.register(selector, SelectionKey.OP_CONNECT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 等待输入</span></span><br><span class="line">        Executors.newSingleThreadExecutor().execute(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 发送数据给服务器</span></span><br><span class="line">            Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">                ByteBuffer byteBuffer = (ByteBuffer) key.attachment();</span><br><span class="line">                <span class="keyword">byte</span>[] data = scanner.nextLine().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">                <span class="comment">// 判断剩余空间是否足够，不够则扩容</span></span><br><span class="line">                <span class="keyword">if</span> (byteBuffer.remaining() &lt; data.length) &#123;</span><br><span class="line">                    byteBuffer = reCapacity(byteBuffer, data.length);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果没有经过上面的扩容，要写入的数据大于剩余可用空间，会报错</span></span><br><span class="line">                byteBuffer.put(data);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 注册写事件</span></span><br><span class="line">                key.interestOps(key.interestOps() | SelectionKey.OP_WRITE);</span><br><span class="line">                <span class="comment">// 绑定Buffer</span></span><br><span class="line">                key.attach(byteBuffer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 等待读取数据</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selector.select();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将通道中的数据放入集合中</span></span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                SelectionKey key = iterator.next();</span><br><span class="line">                <span class="comment">// 已经拿到数据，将迭代器中的数据删除，避免出错</span></span><br><span class="line">                iterator.remove();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (key.isConnectable()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.connect(key);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.read(key);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isWritable() &amp;&amp; key.isValid()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.write(key);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        key.channel().close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                        logger.warn(<span class="string">&quot;exception=&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    logger.info(<span class="string">&quot;服务器出现异常！！！&quot;</span>);</span><br><span class="line">                    <span class="comment">// 直接退出，也可以写重连逻辑</span></span><br><span class="line">                    System.exit(-<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel socketChannel = (SocketChannel) key.channel();</span><br><span class="line">        <span class="keyword">if</span> (socketChannel.isConnectionPending()) &#123;</span><br><span class="line">            socketChannel.finishConnect();</span><br><span class="line">        &#125;</span><br><span class="line">        socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        String info = <span class="string">&quot;this is connect message from client.&quot;</span>;</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        byteBuffer.clear();</span><br><span class="line">        byteBuffer.put(info.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">// 注册读和写事件</span></span><br><span class="line">        key.interestOps(key.interestOps() | SelectionKey.OP_READ | SelectionKey.OP_WRITE);</span><br><span class="line">        <span class="comment">// 绑定Buffer</span></span><br><span class="line">        key.attach(byteBuffer);</span><br><span class="line"><span class="comment">//        // 直接写</span></span><br><span class="line"><span class="comment">//        socketChannel.write(byteBuffer);</span></span><br><span class="line"><span class="comment">//        socketChannel.close();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel socketChannel = (SocketChannel) key.channel();</span><br><span class="line">        ByteBuffer byteBuffer = (ByteBuffer) key.attachment();</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">int</span> read = socketChannel.read(byteBuffer);</span><br><span class="line">        <span class="keyword">while</span> (read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            byteBuffer.flip();</span><br><span class="line">            <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[read];</span><br><span class="line">            byteBuffer.get(data, <span class="number">0</span>, read);</span><br><span class="line">            byteArrayOutputStream.write(data);</span><br><span class="line">            byteBuffer.compact();</span><br><span class="line">            read = socketChannel.read(byteBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;</span><br><span class="line">            socketChannel.close();</span><br><span class="line">        &#125;</span><br><span class="line">        String msg = <span class="keyword">new</span> String(byteArrayOutputStream.toByteArray(), StandardCharsets.UTF_8);</span><br><span class="line">        logger.info(<span class="string">&quot;server &#123;&#125; msg is: &#123;&#125;&quot;</span>, socketChannel.getRemoteAddress(), msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel socketChannel = (SocketChannel) key.channel();</span><br><span class="line">        ByteBuffer byteBuffer = (ByteBuffer) key.attachment();</span><br><span class="line">        <span class="comment">// 转换为读模式</span></span><br><span class="line">        byteBuffer.flip();</span><br><span class="line">        <span class="comment">// 如果通道中还有数据就把它写进ByteBuffer中</span></span><br><span class="line">        <span class="keyword">while</span> (byteBuffer.hasRemaining()) &#123;</span><br><span class="line">            socketChannel.write(byteBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 转换为写模式</span></span><br><span class="line">        byteBuffer.compact();</span><br><span class="line">        <span class="comment">// 发送完了就取消写事件，否则下次还会进入该分支</span></span><br><span class="line">        key.interestOps(key.interestOps() &amp; ~SelectionKey.OP_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ByteBuffer <span class="title">reCapacity</span><span class="params">(ByteBuffer byteBuffer, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> position = byteBuffer.position();</span><br><span class="line">        <span class="keyword">int</span> destCapacity = byteBuffer.capacity();</span><br><span class="line">        <span class="comment">// 每次扩大两倍</span></span><br><span class="line">        <span class="comment">// 进阶：可以设置阈值，超过阈值只扩大指定大小（步进方式），并判断是否达到Integer.MAX_VALUE</span></span><br><span class="line">        <span class="keyword">while</span> (destCapacity - position &lt; length) &#123;</span><br><span class="line">            destCapacity &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ByteBuffer destByteBuffer = ByteBuffer.allocate(destCapacity);</span><br><span class="line">        byteBuffer.flip();</span><br><span class="line"><span class="comment">//        // 调用本方法后 destByteBuffer 会写入整个 byteBuffer 的长度</span></span><br><span class="line"><span class="comment">//        byteBuffer.rewind();</span></span><br><span class="line">        destByteBuffer.put(byteBuffer);</span><br><span class="line">        byteBuffer.clear();</span><br><span class="line">        <span class="keyword">return</span> destByteBuffer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AIO"><a href="#AIO" class="headerlink" title="AIO"></a>AIO</h3><p><strong>异步非阻塞</strong>，AIO 引入了异步通道的概念，采用了 Proactor 模式，简化了程序编写，有效的请求才启动线程，它的特点是先由操作系统完成后才通知服务端程序启动线程去处理，一般适用于连接数较多且连接时间较长的应用。</p>
<h3 id="BIO、NIO、AIO-使用场景分析"><a href="#BIO、NIO、AIO-使用场景分析" class="headerlink" title="BIO、NIO、AIO 使用场景分析"></a>BIO、NIO、AIO 使用场景分析</h3><ul>
<li>BIO 方式适用于连接数比较小且固定的架构，这种方式对服务器资源要求比较高，并发局限于应用中，JDK1.4 之前唯一的选择，程序较为简单容易理解。</li>
<li>NIO 方式适用于连接数目多且连接比较短的架构，比如聊天服务器，弹幕系统，服务器间通讯等，编程比较复杂，JDK1.4 开始支持。</li>
<li>AIO 方式适用于连接数目多且连接比较长的架构，比如相册服务器，充分调用 OS 参与并发操作，变成比较复杂，JDK7 开始支持。</li>
</ul>
<p>参考资料:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg3MjA4MTExMw==&mid=2247484746&idx=1&sn=c0a7f9129d780786cabfcac0a8aa6bb7&source=41#wechat_redirect">漫话：如何给女朋友解释什么是Linux的五种IO模型</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Otiger/p/14748569.html">https://www.cnblogs.com/Otiger/p/14748569.html</a></li>
<li><a target="_blank" rel="noopener" href="https://sowhatbigfatloser.com/shi-yao-shi-zu-sai-fei-zu-sai-tong-bu-yi-bu/">https://sowhatbigfatloser.com/shi-yao-shi-zu-sai-fei-zu-sai-tong-bu-yi-bu/</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000037714804">https://segmentfault.com/a/1190000037714804</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904146550652941">https://juejin.cn/post/6844904146550652941</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012345283/article/details/38357851">https://blog.csdn.net/u012345283/article/details/38357851</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2021/08/13/Github%20Page%20%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2021/08/13/Github%20Page%20%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">Github Page 部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-13 00:00:00" itemprop="dateCreated datePublished" datetime="2021-08-13T00:00:00+08:00">2021-08-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index"><span itemprop="name">blog</span></a>
                </span>
            </span>

          
            <span id="/posts/2021/08/13/Github%20Page%20%E9%83%A8%E7%BD%B2/" class="post-meta-item leancloud_visitors" data-flag-title="Github Page 部署" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="创建-github-仓库"><a href="#创建-github-仓库" class="headerlink" title="创建 github 仓库"></a>创建 github 仓库</h2><p>直接参考<a target="_blank" rel="noopener" href="https://docs.github.com/cn/pages/getting-started-with-github-pages/creating-a-github-pages-site">官方网站</a>的创建要求</p>
<p><strong>注意</strong></p>
<ol>
<li><p>如果创建的是用户或组织站点, 仓库名称必须为 &lt;user&gt;.github.io 或 &lt;organization&gt;.github.io</p>
<p>这样的话能直接访问: <em>http(s)://&lt;username&gt;.github.io</em> 或 <em>http(s)://&lt;organization&gt;.github.io</em></p>
<p>如果是 &lt;other&gt;.github.io, 则只能访问: <em>http(s)://&lt;username&gt;.github.io/&lt;other&gt;</em> 或 <em>http(s)://&lt;organization&gt;.github.io/&lt;other&gt;</em></p>
</li>
<li><p>仓库需要是 public 的, private 目前还只有付费才能使用, 原文章可以存在另一个私有的仓库里, 这个只用来部署生成的页面</p>
</li>
</ol>
<h2 id="安装-hexo"><a href="#安装-hexo" class="headerlink" title="安装 hexo"></a>安装 hexo</h2><h3 id="安装-node-js"><a href="#安装-node-js" class="headerlink" title="安装 node.js"></a>安装 node.js</h3><p><a target="_blank" rel="noopener" href="https://nodejs.org/">nodejs 官网</a>下载对应的 lts 版本</p>
<p><strong>注意</strong></p>
<p>hexo 版本需要用对应的 nodejs 版本</p>
<h3 id="安装-git"><a href="#安装-git" class="headerlink" title="安装 git"></a>安装 git</h3><p><a target="_blank" rel="noopener" href="https://git-scm.com/">git 官网</a>下载最新版本安装即可</p>
<h3 id="安装-hexo-1"><a href="#安装-hexo-1" class="headerlink" title="安装 hexo"></a>安装 hexo</h3><ol>
<li><p>全局安装 hexo-cli</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure></li>
<li><p>创建一个文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// folder是博客文件夹名</span><br><span class="line">hexo init &lt;folder&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>进入文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> &lt;folder&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>局部安装 hexo 包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure></li>
<li><p>新建完成后，指定文件夹的目录如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── _config.yml</span><br><span class="line">├── package.json</span><br><span class="line">├── scaffolds</span><br><span class="line">├── source</span><br><span class="line">|   ├── _drafts</span><br><span class="line">|   └── _posts</span><br><span class="line">└── themes</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>_config.yml</strong> 文件是网站的配置信息, 可以在此配置大部分的参数</p>
<h2 id="安装-NexT-主题"><a href="#安装-NexT-主题" class="headerlink" title="安装 NexT 主题"></a>安装 NexT 主题</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 进入博客文件夹</span><br><span class="line"><span class="built_in">cd</span> &lt;folder&gt;</span><br><span class="line">// 下载最新 next 主题</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>

<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> &lt;folder&gt;</span><br><span class="line">git pull</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong></p>
<p>更新要慎重, 主题对 nodejs 和 hexo 的版本都有要求, 另外不同版本的主题配置可能有所不同, 建议不能用或功能相差比较大的时候更新版本</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="必看的注意事项"><a href="#必看的注意事项" class="headerlink" title="必看的注意事项!!!"></a>必看的注意事项!!!</h3><p>说多都是泪, 都是比较容易忽视并且很难查出来的坑</p>
<ol>
<li><p>一定要把 localhost 和自己的博客网站域名加入到浏览器的广告屏蔽白名单中, 万万没想到这两年广告屏蔽把统计都屏蔽了~~~</p>
</li>
<li><p>博客 _config.yml 中的 url 域名一定要与自己绑定的域名一致</p>
</li>
<li><p>所以配置好的插件, 如果有 enable 的, 记得改成 true, 其他地方默认配置好 enable 就一定是 true</p>
</li>
</ol>
<h3 id="博客-config-yml-详解"><a href="#博客-config-yml-详解" class="headerlink" title="博客 _config.yml 详解"></a>博客 _config.yml 详解</h3><h4 id="url"><a href="#url" class="headerlink" title="url"></a>url</h4><p>博客页面根目录网址</p>
<p>博客页面 CONFIG 中的 hostname 字段值会用到配置的域名, 如:</p>
<p><a href="https://apomelo.cc/posts/">https://apomelo.cc/posts/</a>, hostname 值为 apomelo.cc</p>
<p><a target="_blank" rel="noopener" href="https://www.apomelo.cc/posts/">https://www.apomelo.cc/posts/</a>, hostname 值为 <a target="_blank" rel="noopener" href="http://www.apomelo.cc/">www.apomelo.cc</a></p>
<p><strong>注意</strong></p>
<p>配置的域名一定要与 source 目录下增加 CNAME 文件中配置的一致, 如果文件中配置的是 apomelo.cc, 则 url 一定<strong>不能</strong>配置成 <a target="_blank" rel="noopener" href="http://www.apomelo.cc/">www.apomelo.cc</a></p>
<p>原因: 很多地方会有 CONFIG.hostname 和 location.hostname 的对比, 根据是否相等执行一些语句</p>
<h4 id="permalink"><a href="#permalink" class="headerlink" title="permalink"></a>permalink</h4><p>文章的目录结构, 个人比较推荐: posts/:year/:month/:day/:urlname/</p>
<p>推荐用 urlname，不直接用 title</p>
<p><strong>注意</strong></p>
<p>需要在文章头加上 urlname 字段，如：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Github Page 部署</span><br><span class="line">urlname: Github Page 部署</span><br></pre></td></tr></table></figure>

<h4 id="theme"><a href="#theme" class="headerlink" title="theme"></a>theme</h4><p>配置主题</p>
<h3 id="NexT-主题-config-yml-详解"><a href="#NexT-主题-config-yml-详解" class="headerlink" title="NexT 主题 _config.yml 详解"></a>NexT 主题 _config.yml 详解</h3><h4 id="favicon"><a href="#favicon" class="headerlink" title="favicon"></a>favicon</h4><p>可以使用自定义页面标签图标</p>
<h4 id="menu"><a href="#menu" class="headerlink" title="menu"></a>menu</h4><p>可以开启相关页面</p>
<h4 id="social"><a href="#social" class="headerlink" title="social"></a>social</h4><p>联系方式相关</p>
<h4 id="toc"><a href="#toc" class="headerlink" title="toc"></a>toc</h4><p>开启文章目录</p>
<h4 id="baidu-push"><a href="#baidu-push" class="headerlink" title="baidu_push"></a>baidu_push</h4><p>自动向百度推送, 让百度收录自己的域名</p>
<p><strong>注</strong></p>
<p>github 屏蔽了百度爬虫, 所以用这种方式推送不过去</p>
<h4 id="google-analytics"><a href="#google-analytics" class="headerlink" title="google_analytics"></a>google_analytics</h4><p>谷歌分析</p>
<h4 id="baidu-analytics"><a href="#baidu-analytics" class="headerlink" title="baidu_analytics"></a>baidu_analytics</h4><p>百度分析</p>
<h4 id="cnzz-siteid"><a href="#cnzz-siteid" class="headerlink" title="cnzz_siteid"></a>cnzz_siteid</h4><p>cnzz 友盟统计</p>
<p>申请好 id 之后, 注意一下统计代码的网址是什么, 有些是 s4, 有些是 s5, 还有很多其他的网址</p>
<p>next 主题中相关文件是 themes\next\layout_third-party\statistics\cnzz-analytics.swig</p>
<p>对比该文件中的网址是否和统计代码的网址一致, 如果不一致, 则修改为统计代码中的网址</p>
<h4 id="leancloud-visitors"><a href="#leancloud-visitors" class="headerlink" title="leancloud_visitors"></a>leancloud_visitors</h4><p>leancloud 统计每个文章的阅读量</p>
<p>这个略麻烦, 所以步骤如下:</p>
<ol>
<li><p>申请账户, 不想实名认证的可以用国际版, 目前使用下来没有区别</p>
</li>
<li><p>点击创建应用, 输入应用的名称(随便起都行), 选择开发版, 点击创建</p>
</li>
<li><p>选中该应用, 点击左边菜单里的 <em>数据存储 —&gt; 结构化数据</em></p>
</li>
<li><p>点创建 class, class <strong>名称一定要是 Counter</strong>, class 访问权限选择<strong>add_fields</strong>, 用户选择<strong>所有用户</strong>, acl 权限选择<strong>无限制</strong>, 用户选择<strong>所有用户</strong></p>
</li>
<li><p>点击左边菜单里的 <em>设置 —&gt; 应用凭证</em> 可以看到 app_id 和 app_key</p>
</li>
<li><p>点击左边菜单里的 <em>设置 —&gt; 安全中心</em> 设置安全域名, 安全域名的协议、域名和端口号都需严格一致</p>
</li>
<li><p>博客配置中的 security 配置为 false, 如果配置为 true, 需要进阶的安全配置, 这里不做讲解, 可以参考<a target="_blank" rel="noopener" href="https://github.com/theme-next/hexo-theme-next/blob/master/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md">该文档</a></p>
</li>
<li><p>文件 themes\next\layout_third-party\statistics\lean-analytics.swig 中有一句 <code>if (CONFIG.hostname !== location.hostname) return;</code>, 用双斜杠注释掉, 注释掉即可本地调试自己 leancloud 是否注释成功</p>
</li>
</ol>
<h4 id="busuanzi-count"><a href="#busuanzi-count" class="headerlink" title="busuanzi_count"></a>busuanzi_count</h4><p>卜算子统计, 最喜欢的统计, 因为最方便快捷, 直接打开开关就能用</p>
<p>有了 leancloud 可以只开启卜算子总的统计功能</p>
<h4 id="algolia-search"><a href="#algolia-search" class="headerlink" title="algolia_search"></a>algolia_search</h4><p>站内搜索功能, 挺好用的</p>
<ol>
<li><p>首先注册 Algolia 账户</p>
</li>
<li><p>创建一个新的 Index，这个 index name 之后会用到</p>
</li>
<li><p>博客_config.yml 末尾添加以下代码</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Algolia Search</span></span><br><span class="line"></span><br><span class="line"><span class="section">## Docs: https://theme-next.org/docs/third-party-services/search-services</span></span><br><span class="line"></span><br><span class="line">algolia:</span><br><span class="line">applicationID: &#x27;你的 Application ID&#x27;</span><br><span class="line">apiKey: &#x27;你的 Search-Only API Key&#x27;</span><br><span class="line">indexName: &#x27;输入刚才创建 index name&#x27;</span><br><span class="line">chunkSize: 5000</span><br></pre></td></tr></table></figure></li>
<li><p>测试 algolia, 如果不生效, 安装 Hexo Algolia 扩展 (我最新版本没有安装该插件, 功能可以正常使用)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-algolia --save</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="配置博客域名"><a href="#配置博客域名" class="headerlink" title="配置博客域名"></a>配置博客域名</h3><p>在 source 目录下增加 CNAME 文件, 该文件中填写要配置的域名, 如: apomelo.cc</p>
<p>并在域名购买网站或相关网站把域名解析解析到博客地址, 如: apomelo.github.io</p>
<h3 id="tags-启用"><a href="#tags-启用" class="headerlink" title="tags 启用"></a>tags 启用</h3><ol>
<li><p>source 文件夹下新建 tags 文件夹</p>
</li>
<li><p>tags 文件夹下新建 index.md 文件</p>
<p>快捷命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page <span class="string">&quot;tags&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>index.md 文件中输入:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 标签</span><br><span class="line">date: 2017-06-01 00:00:00</span><br><span class="line"><span class="section">type: tags</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li>
<li><p>修改主题目录下 _config.yml 文件配置, 如下:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">tags: /tags/</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>注意</strong></p>
<p>如果有启用评论, 默认页面也会带有评论, 需要关闭的话, 添加字段 comments 并将值设置为 false, 如:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 标签</span><br><span class="line">date: 2017-06-01 00:00:00</span><br><span class="line">type: tags</span><br><span class="line"><span class="section">comments: false</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<h3 id="categories-启用"><a href="#categories-启用" class="headerlink" title="categories 启用"></a>categories 启用</h3><ol>
<li><p>source 文件夹下新建 categories 文件夹</p>
</li>
<li><p>categories 文件夹下新建 index.md 文件</p>
<p>快捷命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page <span class="string">&quot;categories&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>index.md 文件中输入:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 分类</span><br><span class="line">date: 2017-06-01 00:00:00</span><br><span class="line"><span class="section">type: categories</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li>
<li><p>修改主题目录下 _config.yml 文件配置, 如下:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">categories: /categories/</span><br></pre></td></tr></table></figure></li>
</ol>
<p>禁用评论同上</p>
<h3 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h3><p>建议在 source 目录下新建一个文件夹用来放置图片</p>
<h2 id="隐藏文章"><a href="#隐藏文章" class="headerlink" title="隐藏文章"></a>隐藏文章</h2><h3 id="安装-hexo-hide-posts-插件"><a href="#安装-hexo-hide-posts-插件" class="headerlink" title="安装 hexo-hide-posts 插件"></a>安装 hexo-hide-posts 插件</h3><p>在博客根目录下安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-hide-posts --save</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><ol>
<li>在博客根目录下 _config.yml 文件末尾加上以下内容 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hexo-hide-posts</span></span><br><span class="line"><span class="attr">hide_posts:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 可以改成其他你喜欢的名字</span></span><br><span class="line">  <span class="attr">filter:</span> <span class="string">hidden</span></span><br><span class="line">  <span class="comment"># 指定你想要传递隐藏文章的 generator，比如让所有隐藏文章在存档页面可见</span></span><br><span class="line">  <span class="comment"># 常见的 generators 有：index, tag, category, archive, sitemap, feed, etc.</span></span><br><span class="line">  <span class="attr">public_generators:</span> []</span><br><span class="line">  <span class="comment"># 为隐藏的文章添加 noindex meta 标签，阻止搜索引擎收录</span></span><br><span class="line">  <span class="attr">noindex:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li>在文章头加上 hidden 字段 <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Github Page 部署</span><br><span class="line"><span class="section">hidden: true</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="添加-mermaid-画图模块"><a href="#添加-mermaid-画图模块" class="headerlink" title="添加 mermaid 画图模块"></a>添加 mermaid 画图模块</h2><h3 id="安装-hexo-filter-mermaid-diagrams-插件"><a href="#安装-hexo-filter-mermaid-diagrams-插件" class="headerlink" title="安装 hexo-filter-mermaid-diagrams 插件"></a>安装 hexo-filter-mermaid-diagrams 插件</h3><p>在博客根目录下安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-filter-mermaid-diagrams --save</span><br></pre></td></tr></table></figure>

<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><ol>
<li><p>在博客根目录下 _config.yml 中 “highlight” 下面排除掉 mermaid:</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">highlight:</span></span><br><span class="line">  <span class="attr">exclude_languages:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mermaid</span></span><br></pre></td></tr></table></figure></li>
<li><p>在next主题下面 _config.yml 文件配置，开启 mermaid:</p>
 <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Mermaid tag</span></span><br><span class="line">mermaid:</span><br><span class="line">  enable: true</span><br><span class="line">  # Available themes: default | dark | forest | neutral</span><br><span class="line">  theme: </span><br><span class="line"><span class="code">    light: default</span></span><br><span class="line"><span class="code">    dark: dark</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><h5 id="方向"><a href="#方向" class="headerlink" title="方向"></a>方向</h5><table>
<thead>
<tr>
<th>方向</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>TB</td>
<td>从上到下</td>
</tr>
<tr>
<td>BT</td>
<td>从下到上</td>
</tr>
<tr>
<td>RL</td>
<td>从右到左</td>
</tr>
<tr>
<td>LR</td>
<td>从左到右</td>
</tr>
<tr>
<td>TD</td>
<td>与TB相同</td>
</tr>
</tbody></table>
<h5 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h5><p>语法结构如下：<code>A[名称] --&gt; B(名称)</code> 其中，A、B均代表形状名称， <code>--&gt;</code>表示箭头指向，形状样式用后面的括号来表示，括号里面的内容是形状中要显示的文本内容。其中有以下几种形状：</p>
<table>
<thead>
<tr>
<th>括号形式</th>
<th>形状样式</th>
</tr>
</thead>
<tbody><tr>
<td>[ ]</td>
<td>矩形框</td>
</tr>
<tr>
<td>( )</td>
<td>圆角矩形框</td>
</tr>
<tr>
<td>{ }</td>
<td>菱形</td>
</tr>
<tr>
<td>(( ))</td>
<td>圆形</td>
</tr>
</tbody></table>
<h5 id="连接线"><a href="#连接线" class="headerlink" title="连接线"></a>连接线</h5><table>
<thead>
<tr>
<th>符号</th>
<th>箭头</th>
</tr>
</thead>
<tbody><tr>
<td><code>--&gt;</code></td>
<td>箭头</td>
</tr>
<tr>
<td><code>---</code></td>
<td>没有箭头</td>
</tr>
<tr>
<td>`– 文字 — / —</td>
<td>文字</td>
</tr>
<tr>
<td>`–&gt;</td>
<td>文字</td>
</tr>
<tr>
<td><code>-.-&gt;</code></td>
<td>虚线</td>
</tr>
<tr>
<td><code>-. 文字 .-&gt;</code></td>
<td>带文字的虚线连接</td>
</tr>
<tr>
<td><code>==&gt;</code></td>
<td>粗连接线</td>
</tr>
<tr>
<td><code>== 文本 ==&gt;</code></td>
<td>带文本的粗连接</td>
</tr>
</tbody></table>
<h5 id="子图"><a href="#子图" class="headerlink" title="子图"></a>子图</h5><p>语法：</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subgraph title</span><br><span class="line"><span class="code">    graph definition</span></span><br><span class="line"><span class="code">end</span></span><br></pre></td></tr></table></figure>

<p><strong>示例</strong></p>
<pre class="mermaid">graph TB
    subgraph one
    a1-->a2
    end
    subgraph two
    b1-->b2
    end
    subgraph three
    c1-->c2
    end
    c1-->a2</pre>

<h5 id="样式链接"><a href="#样式链接" class="headerlink" title="样式链接"></a>样式链接</h5><p><strong>示例</strong></p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line"><span class="code">    id1(Start)--&gt;id2(Stop)</span></span><br><span class="line"><span class="code">    style id1 fill:#f9f,stroke:#333,stroke-width:4px</span></span><br><span class="line"><span class="code">    style id2 fill:#ccf,stroke:#f66,stroke-width:2px,stroke-dasharray: 5, 5</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid">graph LR
    id1(Start)-->id2(Stop)
    style id1 fill:#f9f,stroke:#333,stroke-width:4px
    style id2 fill:#ccf,stroke:#f66,stroke-width:2px,stroke-dasharray: 5, 5</pre>

<h5 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h5><p>mermaid注释为 <code>%%</code></p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><h5 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h5><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line"><span class="code">    A(1) --&gt; B(2) --&gt; C(3) --&gt; D(4)</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid">graph LR
    A(1) --> B(2) --> C(3) --> D(4)</pre>

<h5 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h5><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line"><span class="code">    A((开始)) -- 语句 --&gt; B(预处理)</span></span><br><span class="line"><span class="code">    B --&gt; C&#123;判断&#125;</span></span><br><span class="line"><span class="code">    C -- a=1 --&gt; D[执行语句 1]</span></span><br><span class="line"><span class="code">    C -- a=2 --&gt; E[执行语句 2]</span></span><br><span class="line"><span class="code">    C -- a=3 --&gt; F[执行语句 3]</span></span><br><span class="line"><span class="code">    C -- a=4 --&gt; F[执行语句 3]</span></span><br><span class="line"><span class="code">    D --&gt; AA((结束))</span></span><br><span class="line"><span class="code">    E --&gt; AA</span></span><br><span class="line"><span class="code">    F --&gt; AA</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid">graph TD
    A((开始)) -- 语句 --> B(预处理)
    B --> C{判断}
    C -- a=1 --> D[执行语句 1]
    C -- a=2 --> E[执行语句 2]
    C -- a=3 --> F[执行语句 3]
    C -- a=4 --> F[执行语句 3]
    D --> AA((结束))
    E --> AA
    F --> AA</pre>

<h5 id="示例3"><a href="#示例3" class="headerlink" title="示例3"></a>示例3</h5><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line"><span class="code">    A((开始)) --&gt; |语句| B(预处理)</span></span><br><span class="line"><span class="code">    B --&gt; C&#123;判断&#125;</span></span><br><span class="line"><span class="code">    C --&gt; |a=1| D[执行语句 1]</span></span><br><span class="line"><span class="code">    C --&gt; |a=2| E[执行语句 2]</span></span><br><span class="line"><span class="code">    C --&gt; |a=3| F[执行语句 3]</span></span><br><span class="line"><span class="code">    C --&gt; |a=4| F[执行语句 3]</span></span><br><span class="line"><span class="code">    D --&gt; AA((结束))</span></span><br><span class="line"><span class="code">    E --&gt; AA</span></span><br><span class="line"><span class="code">    F --&gt; AA</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid">graph TD
    A((开始)) --> |语句| B(预处理)
    B --> C{判断}
    C --> |a=1| D[执行语句 1]
    C --> |a=2| E[执行语句 2]
    C --> |a=3| F[执行语句 3]
    C --> |a=4| F[执行语句 3]
    D --> AA((结束))
    E --> AA
    F --> AA</pre>

<h5 id="综合应用"><a href="#综合应用" class="headerlink" title="综合应用"></a>综合应用</h5><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"><span class="code">    id1(圆角矩形)--普通线--&gt;id2[矩形]</span></span><br><span class="line"><span class="code">    subgraph 子图表</span></span><br><span class="line"><span class="code">        id2==粗线==&gt;id3&#123;菱形&#125;</span></span><br><span class="line"><span class="code">        id3-.虚线.-&gt;id4&gt;右向旗帜]</span></span><br><span class="line"><span class="code">        id3--无箭头---id5((圆形))</span></span><br><span class="line"><span class="code">    end</span></span><br><span class="line"><span class="code">    style id1 fill:#f9f,stroke:#333,stroke-width:4px</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid">graph TB
    id1(圆角矩形)--普通线-->id2[矩形]
    subgraph 子图表
        id2==粗线==>id3{菱形}
        id3-.虚线.->id4>右向旗帜]
        id3--无箭头---id5((圆形))
    end
    style id1 fill:#f9f,stroke:#333,stroke-width:4px</pre>

<h3 id="甘特图"><a href="#甘特图" class="headerlink" title="甘特图"></a>甘特图</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gantt</span><br><span class="line">section Section</span><br><span class="line">Completed :done,    des1, 2014-01-06,2014-01-08</span><br><span class="line">Active        :active,  des2, 2014-01-07, 3d</span><br><span class="line">Parallel 1   :         des3, after des1, 1d</span><br><span class="line">Parallel 2   :         des4, after des1, 1d</span><br><span class="line">Parallel 3   :         des5, after des3, 1d</span><br><span class="line">Parallel 4   :         des6, after des4, 1d</span><br></pre></td></tr></table></figure>
<pre class="mermaid">gantt
section Section
Completed :done,    des1, 2014-01-06,2014-01-08
Active        :active,  des2, 2014-01-07, 3d
Parallel 1   :         des3, after des1, 1d
Parallel 2   :         des4, after des1, 1d
Parallel 3   :         des5, after des3, 1d
Parallel 4   :         des6, after des4, 1d</pre>

<h3 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">classDiagram</span><br><span class="line">Class01 &lt;|-- AveryLongClass : Cool</span><br><span class="line">&lt;<span class="xml"><span class="tag">&lt;<span class="name">interface</span>&gt;</span></span>&gt; Class01</span><br><span class="line">Class09 --&gt; C2 : Where am i?</span><br><span class="line">Class09 --<span class="emphasis">* C3</span></span><br><span class="line"><span class="emphasis">Class09 --|&gt; Class07</span></span><br><span class="line"><span class="emphasis">Class07 : equals()</span></span><br><span class="line"><span class="emphasis">Class07 : Object[] elementData</span></span><br><span class="line"><span class="emphasis">Class01 : size()</span></span><br><span class="line"><span class="emphasis">Class01 : int chimp</span></span><br><span class="line"><span class="emphasis">Class01 : int gorilla</span></span><br><span class="line"><span class="emphasis">class Class10 &#123;</span></span><br><span class="line"><span class="emphasis">  &lt;<span class="xml"><span class="tag">&lt;<span class="name">service</span>&gt;</span></span>&gt;</span></span><br><span class="line"><span class="emphasis">  int id</span></span><br><span class="line"><span class="emphasis">  size()</span></span><br><span class="line"><span class="emphasis">&#125;</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid">classDiagram
Class01 <|-- AveryLongClass : Cool
<<interface>> Class01
Class09 --> C2 : Where am i?
Class09 --* C3
Class09 --|> Class07
Class07 : equals()
Class07 : Object[] elementData
Class01 : size()
Class01 : int chimp
Class01 : int gorilla
class Class10 {
  <<service>>
  int id
  size()
}</pre>

<h3 id="状态图"><a href="#状态图" class="headerlink" title="状态图"></a>状态图</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stateDiagram-v2</span><br><span class="line">[<span class="emphasis">*] --&gt; Still</span></span><br><span class="line"><span class="emphasis">Still --&gt; [*</span>]</span><br><span class="line">Still --&gt; Moving</span><br><span class="line">Moving --&gt; Still</span><br><span class="line">Moving --&gt; Crash</span><br><span class="line">Crash --&gt; [<span class="emphasis">*]</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid">stateDiagram-v2
[*] --> Still
Still --> [*]
Still --> Moving
Moving --> Still
Moving --> Crash
Crash --> [*]</pre>

<h3 id="饼图"><a href="#饼图" class="headerlink" title="饼图"></a>饼图</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pie</span><br><span class="line">&quot;Dogs&quot; : 386</span><br><span class="line">&quot;Cats&quot; : 85</span><br><span class="line">&quot;Rats&quot; : 15</span><br></pre></td></tr></table></figure>
<pre class="mermaid">pie
"Dogs" : 386
"Cats" : 85
"Rats" : 15</pre>

<h3 id="旅程图"><a href="#旅程图" class="headerlink" title="旅程图"></a>旅程图</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">journey</span><br><span class="line">  title My working day</span><br><span class="line">  section Go to work</span><br><span class="line"><span class="code">    Make tea: 5: Me</span></span><br><span class="line"><span class="code">    Go upstairs: 3: Me</span></span><br><span class="line"><span class="code">    Do work: 1: Me, Cat</span></span><br><span class="line"><span class="code">  section Go home</span></span><br><span class="line"><span class="code">    Go downstairs: 5: Me</span></span><br><span class="line"><span class="code">    Sit down: 3: Me</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid">journey
  title My working day
  section Go to work
    Make tea: 5: Me
    Go upstairs: 3: Me
    Do work: 1: Me, Cat
  section Go home
    Go downstairs: 5: Me
    Sit down: 3: Me</pre>

<h3 id="序列图"><a href="#序列图" class="headerlink" title="序列图"></a>序列图</h3><h4 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h4><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line"><span class="code">    [参与者1][消息线][参与者2]:消息体</span></span><br><span class="line"><span class="code">    ...</span></span><br></pre></td></tr></table></figure>

<h5 id="参与者"><a href="#参与者" class="headerlink" title="参与者"></a>参与者</h5><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line"><span class="code">    participant 参与者 1</span></span><br><span class="line"><span class="code">    participant 参与者 2</span></span><br><span class="line"><span class="code">    ...</span></span><br><span class="line"><span class="code">    participant 简称 as 参与者 3 #该语法可以在接下来的描述中使用简称来代替参与者 312345</span></span><br></pre></td></tr></table></figure>

<h5 id="消息线"><a href="#消息线" class="headerlink" title="消息线"></a>消息线</h5><table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>-&gt;</code></td>
<td>无箭头的实线</td>
</tr>
<tr>
<td><code>--&gt;</code></td>
<td>无箭头的虚线</td>
</tr>
<tr>
<td><code>-&gt;&gt;</code></td>
<td>有箭头的实线</td>
</tr>
<tr>
<td><code>--&gt;&gt;</code></td>
<td>有箭头的虚线</td>
</tr>
<tr>
<td><code>-x</code></td>
<td>末端为叉的实线（表示异步）</td>
</tr>
<tr>
<td><code>--x</code></td>
<td>末端为叉的虚线（表示异步）</td>
</tr>
</tbody></table>
<h5 id="处理中"><a href="#处理中" class="headerlink" title="处理中"></a>处理中</h5><p>在消息线末尾增加 + ，则消息接收者进入当前消息的“处理中”状态； 在消息线末尾增加 - ，则消息接收者离开当前消息的“处理中”状态。</p>
<p>或者使用以下语法直接说明某个参与者进入“处理中”状态:</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">activate 参与者1</span><br></pre></td></tr></table></figure>

<h5 id="标注"><a href="#标注" class="headerlink" title="标注"></a>标注</h5><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Note 位置表述 参与者: 标注文字1</span><br></pre></td></tr></table></figure>

<p>其中位置表述可以为:</p>
<table>
<thead>
<tr>
<th>表述</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>right of</td>
<td>右侧</td>
</tr>
<tr>
<td>left of</td>
<td>左侧</td>
</tr>
<tr>
<td>over</td>
<td>在当中，可以横跨多个参与者</td>
</tr>
</tbody></table>
<h5 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h5><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loop 循环的条件</span><br><span class="line"><span class="code">    循环体描述语句</span></span><br><span class="line"><span class="code">end123</span></span><br></pre></td></tr></table></figure>

<h5 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h5><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">alt 条件 1 描述</span><br><span class="line"><span class="code">    分支 1 描述语句</span></span><br><span class="line"><span class="code">else 条件 2 描述 # else 分支可选</span></span><br><span class="line"><span class="code">    分支 2 描述语句</span></span><br><span class="line"><span class="code">else ...</span></span><br><span class="line"><span class="code">    ...</span></span><br><span class="line"><span class="code">end1234567</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">// 如果遇到可选的情况，即没有 else 分支的情况，使用如下语法：</span><br><span class="line">opt 条件描述</span><br><span class="line"><span class="code">    分支描述语句</span></span><br><span class="line"><span class="code">end</span></span><br></pre></td></tr></table></figure>

<h4 id="综合应用-1"><a href="#综合应用-1" class="headerlink" title="综合应用"></a>综合应用</h4><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line"><span class="code">    participant z as 张三</span></span><br><span class="line"><span class="code">    participant l as 李四</span></span><br><span class="line"><span class="code">    loop 日复一日</span></span><br><span class="line"><span class="code">        z-&gt;&gt;l: 吃了吗您呐？</span></span><br><span class="line"><span class="code">        l--&gt;&gt;z: 吃了，您呢？</span></span><br><span class="line"><span class="code">        activate z</span></span><br><span class="line"><span class="code">        Note left of z: 想了一下</span></span><br><span class="line"><span class="code">        alt 还没吃</span></span><br><span class="line"><span class="code">            z-xl: 还没呢，正准备回去吃</span></span><br><span class="line"><span class="code">        else 已经吃了</span></span><br><span class="line"><span class="code">            z-xl: 我也吃过了，哈哈</span></span><br><span class="line"><span class="code">        end</span></span><br><span class="line"><span class="code">        opt 大过年的</span></span><br><span class="line"><span class="code">            l--&gt;z: 祝您新年好啊</span></span><br><span class="line"><span class="code">        end</span></span><br><span class="line"><span class="code">    end</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid">sequenceDiagram
    participant z as 张三
    participant l as 李四
    loop 日复一日
        z->>l: 吃了吗您呐？
        l-->>z: 吃了，您呢？
        activate z
        Note left of z: 想了一下
        alt 还没吃
            z-xl: 还没呢，正准备回去吃
        else 已经吃了
            z-xl: 我也吃过了，哈哈
        end
        opt 大过年的
            l-->z: 祝您新年好啊
        end
    end</pre>

<h2 id="Hexo引用站内文章"><a href="#Hexo引用站内文章" class="headerlink" title="Hexo引用站内文章"></a>Hexo引用站内文章</h2><p>写文章的时候，经常需要引用站内的其他文章，此时可以使用Hexo内置的标签插件（Tag Plugins）中的post_link来实现。</p>
<p>用法:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% post<span class="emphasis">_link slug [title] %&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>slug: _posts文件夹下需要引用的文章的markdown文件的名字（不带文件扩展名）</li>
<li>title: 指定引用的文章需要显示的名字</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7030074642559664135#heading-22">Hexo -14- 利用 Markdown 语法画 mermaid 流程图</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2019/11/21/MySQL%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2019/11/21/MySQL%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">MySQL笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-21 00:00:00" itemprop="dateCreated datePublished" datetime="2019-11-21T00:00:00+08:00">2019-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-01 00:00:00" itemprop="dateModified" datetime="2021-07-01T00:00:00+08:00">2021-07-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          
            <span id="/posts/2019/11/21/MySQL%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="MySQL笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>ubuntu 或者 centos, 更新过仓库之后, 直接用 apt 或者 yum 进行安装即可</p>
<p>安装<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/linux-installation.html">官方文档</a></p>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><ol>
<li><p>数据库备份, 备份所有数据库配置、系统数据库、自建数据库</p>
</li>
<li><p>确保更新路径是正确的</p>
</li>
<li><p>只能在 GA 版本之间升级</p>
</li>
<li><p>不能夸版本升级, 如: 5.5 —&gt; 5.7 是不支持的, 5.6 —&gt; 5.7 是可以的</p>
</li>
<li><p>跨版本升级最好先把当前版本升级到最新版本, 如 5.6 —&gt; 5.7, 需要先升级到最新的 5.6 版本, 然后再升级到 5.7</p>
</li>
<li><p>同一个大版本可以跨小版本升级, 如 5.7.x —&gt; 5.7.y</p>
</li>
<li><p>升级之前需要对比要升级的版本和当前版本之间的差异, 配置、系统表、server、innodb、sql</p>
</li>
<li><p>其他详细的信息参见 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/upgrading.html">MySQL 官网</a></p>
</li>
</ol>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><p>问题: 安装完之后怎么更改 root 用户密码都可以直接登录</p>
<p>版本: 5.7.26</p>
<p>原因:</p>
<ol>
<li><p>root 用户的认证插件默认是: auth_socket, 不是 mysql_native_password,</p>
</li>
<li><p>而 auth_socket 插件不关心, 也不需要密码, 它只检查用户是否使用 UNIX 套接字进行连接, 然后比较用户名</p>
</li>
<li><p><strong>如果要配置密码, 需要在同一命令中同时更改插件并设置密码</strong>, 首先更改插件然后设置密码将不起作用, 它将再次回退到 auth_socket</p>
</li>
</ol>
<p>修改密码命令:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line">USE mysql;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">quit;</span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 修改密码还可以用下面两条, 推荐第一个, 第二个会有 warning, 但是认证插件是 auth_socket 的时候必须用上面那个指定认证插件的修改语句</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> <span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;密码&#x27;</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> UPDATE <span class="keyword">USER</span> <span class="keyword">SET</span> authentication_string<span class="operator">=</span>PASSWORD(<span class="string">&#x27;密码&#x27;</span>) <span class="keyword">WHERE</span> <span class="keyword">USER</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 还可以修改 <span class="operator">/</span>etc<span class="operator">/</span>my.cnf 文件, 添加 <span class="keyword">skip</span><span class="operator">-</span><span class="keyword">grant</span><span class="operator">-</span>tables 或 <span class="keyword">skip</span><span class="operator">-</span><span class="keyword">grant</span><span class="operator">-</span>tables<span class="operator">=</span><span class="number">1</span>,</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 或者直接以 mysqld  <span class="comment">--skip-grant-tables &amp; 方式启动</span></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 当时没有以这样忽略密码验证的方式启动, 仍然能修改成功</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 该参数一般的使用情况是当 root 用户密码丢失时以此参数作为启动项</span><br></pre></td></tr></table></figure>

<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><h3 id="用户相关命令"><a href="#用户相关命令" class="headerlink" title="用户相关命令"></a>用户相关命令</h3><h4 id="查看用户"><a href="#查看用户" class="headerlink" title="查看用户"></a>查看用户</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> concat(<span class="string">&#x27;User: &#x27;&#x27;&#x27;</span>,<span class="keyword">user</span>,<span class="string">&#x27;&#x27;&#x27;@&#x27;&#x27;&#x27;</span>,host,<span class="string">&#x27;&#x27;&#x27;;&#x27;</span>) <span class="keyword">as</span> query <span class="keyword">from</span> mysql.user;</span><br></pre></td></tr></table></figure>

<h4 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> `test`.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;test&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="显示权限"><a href="#显示权限" class="headerlink" title="显示权限"></a>显示权限</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;user&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="授予权限"><a href="#授予权限" class="headerlink" title="授予权限"></a>授予权限</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> `test`.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="回收权限"><a href="#回收权限" class="headerlink" title="回收权限"></a>回收权限</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> <span class="keyword">create</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">from</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">revoke</span> <span class="keyword">drop</span> <span class="keyword">on</span> <span class="string">&#x27;test&#x27;</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="刷新权限"><a href="#刷新权限" class="headerlink" title="刷新权限"></a>刷新权限</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<h3 id="SHOW-DATABASES"><a href="#SHOW-DATABASES" class="headerlink" title="SHOW DATABASES"></a>SHOW DATABASES</h3><p>查看所有的数据库, 等同于 SELECT schema_name FROM information_schema.schemata\G 用 \G 替换 “;” 以纵向报表的形式输出结果, 有利于阅读</p>
<h3 id="STATUS"><a href="#STATUS" class="headerlink" title="STATUS"></a>STATUS</h3><p>查看 mysql 数据库的运行状态</p>
<h3 id="USE"><a href="#USE" class="headerlink" title="USE"></a>USE</h3><p>命令选择数据库 例如 USE information_schema, 当使用此命令后<br>SELECT schema_name FROM information_schema.schemata\G, 可以更改为<br>SELECT schema_name FROM schemata\G</p>
<h3 id="SHOW-TABLES"><a href="#SHOW-TABLES" class="headerlink" title="SHOW TABLES"></a>SHOW TABLES</h3><p>查看数据库中的表<br>同样也可以在 information_schema 中查看, SHOW 命令是方便使用的简短模式<br>SELECT table_name FROM tables WHERE table_schema=’jblog’;</p>
<h3 id="DESC-table-name"><a href="#DESC-table-name" class="headerlink" title="DESC table_name"></a>DESC table_name</h3><p>查看表结构</p>
<h3 id="查看表状态"><a href="#查看表状态" class="headerlink" title="查看表状态"></a>查看表状态</h3><p>SHOW 条件 或</p>
<p>SHOW STATUS like ‘%条件%’ 或</p>
<p>SHOW VARIABLES LIKE “%条件%” 等</p>
<p>可以查看 engine 数据库引擎, version, row, index 等信息</p>
<p>查询数据库连接:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> PROCESSLIST;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;%Max_used_connections%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;%Threads_connected%&#x27;</span>; #当前连接数</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;%table_lock%&#x27;</span>; #表锁定</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_row_lock%&#x27;</span>; #行锁定</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;%qcache%&#x27;</span>; #查询缓存情况</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Qcache%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Aborted_clients&#x27;</span>; #由于客户没有正确关闭连接已经死掉, 已经放弃的连接数量</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> &quot;%query_cache%&quot;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> &quot;%binlog%&quot;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%max_connections%&#x27;</span>; <span class="operator">/</span><span class="operator">/</span>查看最大连接数量</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%timeout%&#x27;</span>; #查看超时时间</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_%&#x27;</span>; #查看日志是否启动</span><br></pre></td></tr></table></figure>

<h3 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h3><p>当多行命令输入, 发现错误后, 用\c 结束</p>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><p>事务具有 ACID 特性, A: 原子性（atomicity, 或称不可分割性）、C: 一致性（consistency）、I: 隔离性（isolation, 又称独立性）、D: 持久性（durability）</p>
<h4 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h4><p>一个事务必须被视为一个不可分割的最小工作单元</p>
<h4 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h4><p>数据库总是从一个一致性的状态转换到另一个一致性的状态</p>
<h4 id="隔离性"><a href="#隔离性" class="headerlink" title="隔离性"></a>隔离性</h4><p>通常来说, 一个事务所做的修改在最终提交之前, 对其他事务是不可见的</p>
<h4 id="持久性"><a href="#持久性" class="headerlink" title="持久性"></a>持久性</h4><p>一旦事务提交, 其所做的修改就会永久保存到数据库中</p>
<h3 id="数据读取问题"><a href="#数据读取问题" class="headerlink" title="数据读取问题"></a>数据读取问题</h3><h4 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a>脏读</h4><p>读取未提交数据</p>
<h4 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h4><p>前后多次读取, 数据内容不一致</p>
<h4 id="幻读"><a href="#幻读" class="headerlink" title="幻读"></a>幻读</h4><p>前后多次读取, 数据总量不一致</p>
<p>当某个事务在读取某个范围内的记录时, 另外一个事务又在该范围内插入新的记录, 当之前的事务再次读取该范围的记录时, 会产生幻行</p>
<h4 id="不可重复读和幻读的区别"><a href="#不可重复读和幻读的区别" class="headerlink" title="不可重复读和幻读的区别"></a>不可重复读和幻读的区别</h4><ol>
<li>不可重复读是读取了其他事务更改的数据, 针对 update 操作</li>
<li>幻读是读取了其他事务新增的数据, 针对 insert 和 delete 操作</li>
</ol>
<h3 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h3><p>数据库事务的隔离级别有 4 种, 由低到高分别为 Read uncommitted 、Read committed 、Repeatable read 、Serializable</p>
<h4 id="Read-uncommitted"><a href="#Read-uncommitted" class="headerlink" title="Read uncommitted"></a>Read uncommitted</h4><p>读未提交, 顾名思义, 就是一个事务可以读取另一个未提交事务的数据</p>
<p>从性能上来说, 该级别不会比其他的级别好太多, 但是缺乏其他级别的很多好处, 所以除非真的有非常必要的理由, 在实际应用中一般很少使用</p>
<h4 id="Read-committed"><a href="#Read-committed" class="headerlink" title="Read committed"></a>Read committed</h4><p>读提交, 顾名思义, 就是一个事务要等另一个事务提交后才能读取数据</p>
<p>大多数数据库系统的默认隔离级别都是 Read committed（但 MySQL 不是）</p>
<h4 id="Repeatable-read"><a href="#Repeatable-read" class="headerlink" title="Repeatable read"></a>Repeatable read</h4><p>重复读, 就是在开始读取数据（事务开启）时, 不再允许修改操作, 保证了在同一个事务中多次读取同样记录的结果是一致的</p>
<p>Repeatable read 是 MySQL 的默认事务隔离级别</p>
<p>InnoDB 通过多版本并发控制（MVCC, Multiversion Concurrency Control）<strong>基本</strong>解决了幻读的问题, MVCC 以乐观锁为理论基础, MVCC 的实现没有固定的规范, 每个数据库都会有不同的实现方式</p>
<h4 id="Serializable"><a href="#Serializable" class="headerlink" title="Serializable"></a>Serializable</h4><p>Serializable 是最高的事务隔离级别, 在该级别下, 事务串行化顺序执行, 可以避免脏读、不可重复读与幻读</p>
<h2 id="数据库构架设计中-Shared-Everything-和-share-nothing-区别"><a href="#数据库构架设计中-Shared-Everything-和-share-nothing-区别" class="headerlink" title="数据库构架设计中 Shared Everything 和 share-nothing 区别"></a>数据库构架设计中 Shared Everything 和 share-nothing 区别</h2><h3 id="Shared-Everthting"><a href="#Shared-Everthting" class="headerlink" title="Shared Everthting"></a>Shared Everthting</h3><p>一般是针对单个主机, 完全透明共享 CPU/MEMORY/IO, 并行处理能力是最差的, 典型的代表 SQLServer</p>
<h3 id="Shared-Disk"><a href="#Shared-Disk" class="headerlink" title="Shared Disk"></a>Shared Disk</h3><p>各个处理单元使用自己的私有 CPU 和 Memory, 共享磁盘系统</p>
<p>典型的代表 Oracle Rac, 它是数据共享, 可通过增加节点来提高并行处理的能力, 扩展能力较好</p>
<p>其类似于 SMP（对称多处理）模式, 但是当存储器接口达到饱和的时候, 增加节点并不能获得更高的性能</p>
<h3 id="Shared-Nothing"><a href="#Shared-Nothing" class="headerlink" title="Shared Nothing"></a>Shared Nothing</h3><p>各个处理单元都有自己私有的 CPU/内存/硬盘等, 不存在共享资源, 类似于 MPP（大规模并行处理）模式, 各处理单元之间通过协议通信, 并行处理和扩展能力更好</p>
<p>典型代表 DB2 DPF 和 hadoop, 各节点相互独立, 各自处理自己的数据, 处理后的结果可能向上层汇总或在节点间流转</p>
<p>我们常说的 Sharding 其实就是 Share Nothing 架构, 它是把某个表从物理存储上被水平分割, 并分配给多台服务器（或多个实例）, 每台服务器可以独立工作, 具备共同的 schema, 比如 MySQL Proxy 和 Google 的各种架构, 只需增加服务器数就可以增加处理能力和容量</p>
<h2 id="mysql日志：redo-log、binlog、undo-log-区别与作用"><a href="#mysql日志：redo-log、binlog、undo-log-区别与作用" class="headerlink" title="mysql日志：redo log、binlog、undo log 区别与作用"></a>mysql日志：redo log、binlog、undo log 区别与作用</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1888595">https://cloud.tencent.com/developer/article/1888595</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li>mysql 查看数据库、表的基本命令 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/onsuccessway/p/3552524.html">https://www.cnblogs.com/onsuccessway/p/3552524.html</a></li>
<li>使用“plugin: auth_socket”更改 MySQL 5.7 中的用户密码 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41918841/article/details/82997651">https://blog.csdn.net/weixin_41918841/article/details/82997651</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2021/06/06/xray%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2021/06/06/xray%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">xray部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-06 00:00:00" itemprop="dateCreated datePublished" datetime="2021-06-06T00:00:00+08:00">2021-06-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
                </span>
            </span>

          
            <span id="/posts/2021/06/06/xray%E9%83%A8%E7%BD%B2/" class="post-meta-item leancloud_visitors" data-flag-title="xray部署" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文详细介绍 xray 部署步骤, 用到的服务器是 Ubuntu 20.04 LTS</p>
<h2 id="安装-nginx"><a href="#安装-nginx" class="headerlink" title="安装 nginx"></a>安装 nginx</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>执行以下命令, 通过下面 ppa 方式安装 nginx 能安装到最新稳定版本的 nginx:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt install software-properties-common</span><br><span class="line">add-apt-repository ppa:nginx/stable</span><br><span class="line">apt update</span><br><span class="line">apt list nginx</span><br><span class="line">apt install nginx</span><br></pre></td></tr></table></figure>

<h3 id="配置-nginx"><a href="#配置-nginx" class="headerlink" title="配置 nginx"></a>配置 nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rm /etc/nginx/sites-available/default</span><br><span class="line">rm /etc/nginx/sites-enabled/default</span><br><span class="line">touch /etc/nginx/sites-available/xray</span><br><span class="line">ln -s /etc/nginx/sites-available/xray /etc/nginx/sites-enabled/xray</span><br><span class="line"><span class="comment"># 配置 nginx</span></span><br><span class="line">vim /etc/nginx/sites-enabled/xray</span><br><span class="line"><span class="comment"># 启动 nginx</span></span><br><span class="line">service nginx restart</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong></p>
<p>配置购买的服务器防火墙, 让端口能够被外网访问</p>
<p><strong>nginx 配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># You should look at the following URL&#x27;s in order to grasp a solid understanding</span></span><br><span class="line"><span class="comment"># of Nginx configuration files in order to fully unleash the power of Nginx.</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/</span></span><br><span class="line"><span class="comment"># https://wiki.debian.org/Nginx/DirectoryStructure</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In most cases, administrators will remove this file from sites-enabled/ and</span></span><br><span class="line"><span class="comment"># leave it as reference inside of sites-available where it will continue to be</span></span><br><span class="line"><span class="comment"># updated by the nginx packaging team.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file will automatically load configuration files provided by other</span></span><br><span class="line"><span class="comment"># applications, such as Drupal or Wordpress. These applications will be made</span></span><br><span class="line"><span class="comment"># available underneath a path with that package name, such as /drupal8.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default server configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line">    listen [::]:80 default_server;</span><br><span class="line"></span><br><span class="line">    server_name 你的域名;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 注意 最后不能加/</span></span><br><span class="line">    root /home/www-data/你的域名;</span><br><span class="line">    index index.html index.htm index.nginx-debian.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="申请域名证书"><a href="#申请域名证书" class="headerlink" title="申请域名证书"></a>申请域名证书</h2><p>通过 acme 实现证书的自动颁发、部署</p>
<h3 id="安装-acme"><a href="#安装-acme" class="headerlink" title="安装 acme"></a>安装 acme</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/</span><br><span class="line">wget -O -  https://get.acme.sh | sh</span><br><span class="line"><span class="comment"># 让 acme.sh 命令生效</span></span><br><span class="line">. .bashrc</span><br></pre></td></tr></table></figure>

<h3 id="设置-acme-自动更新"><a href="#设置-acme-自动更新" class="headerlink" title="设置 acme 自动更新"></a>设置 acme 自动更新</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启自动更新</span></span><br><span class="line">acme.sh --upgrade --auto-upgrade</span><br><span class="line"><span class="comment"># 设置获取证书的默认服务器为letsencrypt</span></span><br><span class="line">acme.sh --set-default-ca --server letsencrypt</span><br></pre></td></tr></table></figure>

<h3 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h3><p><strong>注意</strong></p>
<p>一定要先运行<strong>测试</strong>签发命令, 并且成功之后再运行正式签发命令, 因为正式签发服务器有次数限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/www-data</span><br><span class="line">mkdir /home/www-data/xray_cert</span><br><span class="line">mkdir /home/www-data/xray_log</span><br><span class="line">chown -R www-data:www-data /home/www-data/</span><br><span class="line"><span class="comment"># 运行测试签发命令</span></span><br><span class="line"><span class="comment"># 下面这段过程将会往 /home/www-data/你的域名 创建一个 .well-known 的文件夹,</span></span><br><span class="line"><span class="comment"># 同时 Let’s Encrypt 将会通过你要注册的域名去访问那个文件来确定权限, 它可能会去访问</span></span><br><span class="line"><span class="comment"># http://你的域名/.well-known/ 这个路径。所以需要确保/home/www-data/你的域名</span></span><br><span class="line"><span class="comment"># 在 nginx 上配置成 root 目录, 里面任意文件可以直接域名访问的(由于通过 nginx 反向代理</span></span><br><span class="line"><span class="comment"># 后访问隐藏文件夹(.well-known)会得到 HTTP 4.3 Forbidden 的结果, 故前面选择先配置 nginx)</span></span><br><span class="line">acme.sh --issue --<span class="built_in">test</span> -d 你的域名 -w /home/www-data/你的域名 --keylength ec-256</span><br><span class="line"><span class="comment"># 运行正式签发命令</span></span><br><span class="line">acme.sh --issue -d 你的域名 -w /home/www-data/你的域名 --keylength ec-256 --force</span><br></pre></td></tr></table></figure>

<h3 id="部署证书"><a href="#部署证书" class="headerlink" title="部署证书"></a>部署证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d 你的域名 --ecc \</span><br><span class="line">            --fullchain-file /home/www-data/xray_cert/xray.crt \</span><br><span class="line">            --key-file /home/www-data/xray_cert/xray.key</span><br><span class="line">chmod +r /home/www-data/xray_cert/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置定时部署脚本（代码在下面）</span></span><br><span class="line">vim /home/www-data/xray_cert/xray-cert-renew.sh</span><br><span class="line"><span class="comment"># 添加可执行</span></span><br><span class="line">chmod +x /home/www-data/xray_cert/xray-cert-renew.sh</span><br><span class="line"><span class="comment"># 添加定时脚本</span></span><br><span class="line">crontab -e</span><br><span class="line"><span class="comment"># 把下面的内容增加在文件最后, 保存退出即可。</span></span><br><span class="line"><span class="comment"># 1:00am, 1st day each month, run `xray-cert-renew.sh`</span></span><br><span class="line">0 1 1 * *   bash /home/www-data/xray_cert/xray-cert-renew.sh</span><br></pre></td></tr></table></figure>

<p><strong>定时部署脚本代码</strong></p>
<p>把下面的内容复制进去, 记得替换你的真实域名, 然后保存退出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">/root/.acme.sh/acme.sh --install-cert -d 你的域名 --ecc --fullchain-file /home/www-data/xray_cert/xray.crt --key-file /home/www-data/xray_cert/xray.key</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Xray Certificates Renewed&quot;</span></span><br><span class="line"></span><br><span class="line">chmod +r /home/www-data/xray_cert/*</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Read Permission Granted for Private Key&quot;</span></span><br><span class="line"></span><br><span class="line">sudo systemctl restart xray</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Xray Restarted&quot;</span></span><br><span class="line"></span><br><span class="line">chown -R www-data:www-data /home/www-data/</span><br><span class="line">chmod +x /home/www-data/xray_cert/xray-cert-renew.sh</span><br></pre></td></tr></table></figure>

<h2 id="安装-xray"><a href="#安装-xray" class="headerlink" title="安装 xray"></a>安装 xray</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/</span><br><span class="line">wget https://github.com/XTLS/Xray-install/raw/main/install-release.sh</span><br><span class="line">bash install-release.sh</span><br><span class="line">rm ~/install-release.sh</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个合法的 UUID 替换下面配置中的 UUID</span></span><br><span class="line">xray uuid</span><br><span class="line"><span class="comment"># 代码在下面</span></span><br><span class="line">vim /usr/<span class="built_in">local</span>/etc/xray/config.json</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/XTLS/Xray-examples/blob/main/VLESS-TCP-XTLS-WHATEVER/config_server.json">查看服务器配置</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;log&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;loglevel&quot;</span>: <span class="string">&quot;warning&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;access&quot;</span>: <span class="string">&quot;/home/www-data/xray_log/access.log&quot;</span>, <span class="comment">// 访问记录</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;/home/www-data/xray_log/error.log&quot;</span> <span class="comment">// 错误记录</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;port&quot;</span>: 你的xray监听端口, <span class="comment">// 默认监听端口 443</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;vless&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;clients&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;你的UUID&quot;</span>, <span class="comment">// 填写你的 UUID</span></span><br><span class="line">            <span class="attr">&quot;flow&quot;</span>: <span class="string">&quot;xtls-rprx-direct&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;level&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;你的email&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;decryption&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;fallbacks&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;dest&quot;</span>: <span class="number">1310</span>, <span class="comment">// 默认回落到 Xray 的 Trojan 协议</span></span><br><span class="line">            <span class="attr">&quot;xver&quot;</span>: <span class="number">1</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/websocket&quot;</span>, <span class="comment">// 默认 websocket 必须换成自定义的 PATH</span></span><br><span class="line">            <span class="attr">&quot;dest&quot;</span>: <span class="number">1234</span>,</span><br><span class="line">            <span class="attr">&quot;xver&quot;</span>: <span class="number">1</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/vmesstcp&quot;</span>, <span class="comment">// 默认 vmesstcp 必须换成自定义的 PATH</span></span><br><span class="line">            <span class="attr">&quot;dest&quot;</span>: <span class="number">2345</span>,</span><br><span class="line">            <span class="attr">&quot;xver&quot;</span>: <span class="number">1</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/vmessws&quot;</span>, <span class="comment">// 默认 vmessws 必须换成自定义的 PATH</span></span><br><span class="line">            <span class="attr">&quot;dest&quot;</span>: <span class="number">3456</span>,</span><br><span class="line">            <span class="attr">&quot;xver&quot;</span>: <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;security&quot;</span>: <span class="string">&quot;xtls&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;xtlsSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;alpn&quot;</span>: [<span class="string">&quot;http/1.1&quot;</span>],</span><br><span class="line">          <span class="attr">&quot;certificates&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;certificateFile&quot;</span>: <span class="string">&quot;/home/www-data/xray_cert/xray.crt&quot;</span>, <span class="comment">// 换成你的证书, 绝对路径</span></span><br><span class="line">              <span class="attr">&quot;keyFile&quot;</span>: <span class="string">&quot;/home/www-data/xray_cert/xray.key&quot;</span> <span class="comment">// 换成你的私钥, 绝对路径</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;port&quot;</span>: <span class="number">1310</span>,</span><br><span class="line">      <span class="attr">&quot;listen&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;trojan&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;clients&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;你的密码&quot;</span>, <span class="comment">// 填写你的密码</span></span><br><span class="line">            <span class="attr">&quot;level&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;你的email&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;fallbacks&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;dest&quot;</span>: <span class="number">8080</span> <span class="comment">// 或者回落到其它也防探测的代理</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;security&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tcpSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;acceptProxyProtocol&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;port&quot;</span>: <span class="number">1234</span>,</span><br><span class="line">      <span class="attr">&quot;listen&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;vless&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;clients&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;你的UUID&quot;</span>, <span class="comment">// 填写你的 UUID</span></span><br><span class="line">            <span class="attr">&quot;level&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;你的email&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;decryption&quot;</span>: <span class="string">&quot;none&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;ws&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;security&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;acceptProxyProtocol&quot;</span>: <span class="literal">true</span>, <span class="comment">// 提醒: 若你用 Nginx/Caddy 等反代 WS, 需要删掉这行</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/websocket&quot;</span> <span class="comment">// 必须换成自定义的 PATH, 需要和分流的一致</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;port&quot;</span>: <span class="number">2345</span>,</span><br><span class="line">      <span class="attr">&quot;listen&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;clients&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;你的UUID&quot;</span>, <span class="comment">// 填写你的 UUID</span></span><br><span class="line">            <span class="attr">&quot;level&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;你的email&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;security&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tcpSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;acceptProxyProtocol&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;header&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/vmesstcp&quot;</span> <span class="comment">// 必须换成自定义的 PATH, 需要和分流的一致</span></span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;port&quot;</span>: <span class="number">3456</span>,</span><br><span class="line">      <span class="attr">&quot;listen&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;clients&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;你的UUID&quot;</span>, <span class="comment">// 填写你的 UUID</span></span><br><span class="line">            <span class="attr">&quot;level&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;你的email&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;ws&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;security&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;acceptProxyProtocol&quot;</span>: <span class="literal">true</span>, <span class="comment">// 提醒: 若你用 Nginx/Caddy 等反代 WS, 需要删掉这行</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/vmessws&quot;</span> <span class="comment">// 必须换成自定义的 PATH, 需要和分流的一致</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以 www-data 用户启动服务 (下面配置两个文件中的 User=nobody 改为 User=www-data)</span></span><br><span class="line">vim /etc/systemd/system/xray.service</span><br><span class="line">vim /etc/systemd/system/xray@.service</span><br><span class="line"><span class="comment"># 新添加 unit 配置文件时需要执行 daemon-reload 子命令</span></span><br><span class="line"><span class="comment"># 有 unit 配置文件发生变化时也需要执行 daemon-reload 子命令</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">service xray restart</span><br></pre></td></tr></table></figure>

<h3 id="重新配置-nginx-开启-HTTP-自动跳转-HTTPS"><a href="#重新配置-nginx-开启-HTTP-自动跳转-HTTPS" class="headerlink" title="重新配置 nginx: 开启 HTTP 自动跳转 HTTPS"></a>重新配置 nginx: 开启 HTTP 自动跳转 HTTPS</h3><p>如果不想开启 HTTP 自动跳转 HTTPS</p>
<p>需要修改 Xray 的回落设置, 将回落从 8080 端口改为 80 端口(找到 “dest”: 8080, 并改成 “dest”: 80)</p>
<p>原因: 上面的回落端口是 8080, 而之前配置的 nginx 只监听了 80 端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置nginx</span></span><br><span class="line">vim /etc/nginx/sites-enabled/xray</span><br><span class="line"><span class="comment"># 新建自定义 404 目录</span></span><br><span class="line">mkdir /home/www-data/404</span><br><span class="line"><span class="comment"># 上传自定义的 404 html 文件</span></span><br><span class="line"><span class="comment"># 更改文件夹所属</span></span><br><span class="line">chown -R www-data:www-data /home/www-data/</span><br><span class="line"><span class="comment"># 启动nginx</span></span><br><span class="line">service nginx restart</span><br></pre></td></tr></table></figure>

<p><strong>nginx 配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># You should look at the following URL&#x27;s in order to grasp a solid understanding</span></span><br><span class="line"><span class="comment"># of Nginx configuration files in order to fully unleash the power of Nginx.</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/</span></span><br><span class="line"><span class="comment"># https://wiki.debian.org/Nginx/DirectoryStructure</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In most cases, administrators will remove this file from sites-enabled/ and</span></span><br><span class="line"><span class="comment"># leave it as reference inside of sites-available where it will continue to be</span></span><br><span class="line"><span class="comment"># updated by the nginx packaging team.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file will automatically load configuration files provided by other</span></span><br><span class="line"><span class="comment"># applications, such as Drupal or Wordpress. These applications will be made</span></span><br><span class="line"><span class="comment"># available underneath a path with that package name, such as /drupal8.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default server configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改监听 80 端口的 server 如下:</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line">    listen [::]:80 default_server;</span><br><span class="line"></span><br><span class="line">    server_name 你的域名;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$http_host</span>:你的xray监听端口<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增监听本地 8080 端口的 server 如下:</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 127.0.0.1:8080;</span><br><span class="line">    listen [::1]:8080;</span><br><span class="line"></span><br><span class="line">    root /home/www-data/你的域名;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add index.php to the list if you are using PHP</span></span><br><span class="line">    index index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        <span class="comment"># First attempt to serve request as file, then</span></span><br><span class="line">        <span class="comment"># as directory, then fall back to displaying a 404.</span></span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义错误页面码, 如果出现相应的错误页面码, 转发到那里。</span></span><br><span class="line">    error_page  404 403 500 502 503 504  /404.html;</span><br><span class="line">    <span class="comment"># 承接上面的location。</span></span><br><span class="line">    location = /404.html &#123;</span><br><span class="line">        <span class="comment"># 放错误页面的目录路径。当然默认可以在网站目录下, 也可以定义放置错误页面的位置。</span></span><br><span class="line">        root   /home/www-data/404/;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 如果404是和根目录不一致, 并且有css、js等文件, 需要把404.html中的引用加上404前缀, 并定义下面404目录</span></span><br><span class="line">    <span class="comment"># location /404/ &#123;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">    location /404/ &#123;</span><br><span class="line">        <span class="comment"># 第一种方式, 访问路径需要在配置的路径后需要加入location路径</span></span><br><span class="line">        <span class="comment"># 若按照这种配置的话, 则访问/404/目录下的文件时, nginx会去/home/www-data/404/目录下找文件</span></span><br><span class="line">        <span class="comment"># root 响应的路径：配置的路径+完整访问路径(完整的 location 配置路径+静态文件)</span></span><br><span class="line">        root   /home/www-data/;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 第二种方式, 所见即所得, 访问路径从配置的路径直接访问</span></span><br><span class="line">        <span class="comment"># 若按照这种配置的话, 则访问/404/目录下的文件时, nginx会去/home/www-data/404/目录下找文件</span></span><br><span class="line">        <span class="comment"># 注意: 这里的路径后必须加入斜杠 &quot;/&quot;, 否则不能访问, 所以最好所有的路径都加上斜杠 &quot;/&quot;</span></span><br><span class="line">        <span class="comment"># alias 响应的路径：配置路径+静态文件(去除 location 中配置的路径)</span></span><br><span class="line">        <span class="comment"># alias   /home/www-data/404/;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">## HSTS 说明</span></span><br><span class="line">    <span class="comment"># HSTS 生效前, 第一次需要将 301 和 302 重定向到 HTTPS</span></span><br><span class="line">    <span class="comment"># HSTS 响应头在 HTTPS 访问的响应中有效, 在 HTTP 访问的响应中无效</span></span><br><span class="line">    <span class="comment"># 仅对 443 端口有效, 对其他端口无效</span></span><br><span class="line">    <span class="comment"># 仅对域名有效, 对 IP 无效</span></span><br><span class="line">    <span class="comment"># 所以 xray 监听端口不是 443 时, 不能添加下面语句</span></span><br><span class="line">    add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000&quot;</span> always;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="开启-BBR-加速"><a href="#开启-BBR-加速" class="headerlink" title="开启 BBR 加速"></a>开启 BBR 加速</h2><p>Linux 内核从 4.9 开始, 已经自带 BBR</p>
<p>查看内核命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r</span><br></pre></td></tr></table></figure>

<h3 id="开启-BBR"><a href="#开启-BBR" class="headerlink" title="开启 BBR"></a>开启 BBR</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 修改 kernel 参数配置文件 sysctl.conf 并指定开启 BBR</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 2. 把下面的内容添加进去</span></span><br><span class="line">net.core.default_qdisc=fq</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br><span class="line"><span class="comment"># 3. 重启VPS、使内核更新和BBR设置都生效</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="确认-BBR-开启"><a href="#确认-BBR-开启" class="headerlink" title="确认 BBR 开启"></a>确认 BBR 开启</h3><p>如果你想确认 BBR 是否正确开启, 可以使用下面的命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep bbr</span><br></pre></td></tr></table></figure>

<p>此时应该返回这样的结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp_bbr</span><br></pre></td></tr></table></figure>

<p>如果你想确认 fq 算法是否正确开启, 可以使用下面的命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep fq</span><br></pre></td></tr></table></figure>

<p>此时应该返回这样的结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sch_fq</span><br></pre></td></tr></table></figure>

<p>参考: <a target="_blank" rel="noopener" href="https://www.zybuluo.com/xiaoyixy/note/1055898#c1">https://www.zybuluo.com/xiaoyixy/note/1055898#c1</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2020/03/28/maven%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2020/03/28/maven%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">maven笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-28T00:00:00+08:00">2020-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-01 00:00:00" itemprop="dateModified" datetime="2021-04-01T00:00:00+08:00">2021-04-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/posts/2020/03/28/maven%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="maven笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="maven-打包"><a href="#maven-打包" class="headerlink" title="maven 打包"></a>maven 打包</h2><h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><ol>
<li><p>想要把本程序和所有的依赖包打进一个 jar 包, 里面是 class 文件</p>
</li>
<li><p>jar 包里面根目录是 “/“, 不是 “/程序名”</p>
</li>
<li><p>把不需要的资源文件排除出去</p>
</li>
<li><p>为了方便部署, 把编译好的 jar 包, 再打包成 tar.gz 格式, 并且把启动脚本、配置文件、jar 包打包到各自目录</p>
</li>
</ol>
<p>用的是 maven-assembly-plugin 3.0.0 插件</p>
<h3 id="实现目标-1-和-2"><a href="#实现目标-1-和-2" class="headerlink" title="实现目标 1 和 2"></a>实现目标 1 和 2</h3><p>用自带的模式: jar-with-dependencies 可以实现上面的 1、3, 如下:</p>
<p>pom 文件配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cc.apomelo.test.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;name&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="同时实现目标-3"><a href="#同时实现目标-3" class="headerlink" title="同时实现目标 3"></a>同时实现目标 3</h3><p>有两种方式可以同时实现目标 2</p>
<h4 id="第一种方法"><a href="#第一种方法" class="headerlink" title="第一种方法"></a>第一种方法</h4><ol>
<li><p>需要自己定义 Descriptor Format,</p>
</li>
<li><p>需要在 dependencySet/unpackOptions/excludes/exclude 中定义</p>
</li>
<li><p>不是在 dependencySet/excludes/exclude 中定义</p>
</li>
<li><p>dependencySet/unpackOptions/excludes/exclude 中定义的是<strong>在打包好之后的目录结构中</strong>需要排除内容</p>
</li>
<li><p>dependencySet/excludes/exclude 中定义的是需要排除的包, 如: <a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-assembly-plugin/examples/single/including-and-excluding-artifacts.html">http://maven.apache.org/plugins/maven-assembly-plugin/examples/single/including-and-excluding-artifacts.html</a></p>
</li>
</ol>
<p>例子: 排除 netty</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>io.netty:netty-all<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>例子如下:</p>
<p>pom 文件配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cc.apomelo.test.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">descriptors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptor</span>&gt;</span>src/main/resources/assembly.xml<span class="tag">&lt;/<span class="name">descriptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">descriptors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;name&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>assembly.xml 文件配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>deploy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">formats</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">formats</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        表示unpack出的class文件是根目录, 而不是pom文件中定义的工程名</span></span><br><span class="line"><span class="comment">        官方定义:</span></span><br><span class="line"><span class="comment">        Sets the base directory of the resulting assembly archive.</span></span><br><span class="line"><span class="comment">        If this is not set and includeBaseDirectory == true,</span></span><br><span class="line"><span class="comment">        $&#123;project.build.finalName&#125; will be used instead.</span></span><br><span class="line"><span class="comment">        (Since 2.2-beta-1)</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">baseDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">baseDirectory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>true<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">useProjectArtifact</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useProjectArtifact</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">                        排除src/main/resources/proto 目录及目录下所有内容,</span></span><br><span class="line"><span class="comment">                        最终exclude中如何写,</span></span><br><span class="line"><span class="comment">                        需要看打包里面基于baseDirectory的相对目录。</span></span><br><span class="line"><span class="comment">                    --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>proto/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencySets</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 用以下方式不能排除jar包中的proto文件 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;fileSets&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;fileSet&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;directory&gt;src/main/resources&lt;/directory&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;excludes&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                &lt;exclude&gt;proto/**&lt;/exclude&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;/excludes&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;/fileSet&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;/fileSets&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="第二种方法"><a href="#第二种方法" class="headerlink" title="第二种方法"></a>第二种方法</h4><p>pom 文件配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources/$&#123;profiles.active&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 把不想要打包进jar包的内容过滤 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>test/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>online/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>proto/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cc.apomelo.test.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptors</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">descriptor</span>&gt;</span>src/main/resources/assembly.xml<span class="tag">&lt;/<span class="name">descriptor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">descriptors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;name&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>assembly.xml 文件如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>deploy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">formats</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">formats</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">baseDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">baseDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>true<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">useProjectArtifact</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useProjectArtifact</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>proto/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencySets</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="同时实现目标-4"><a href="#同时实现目标-4" class="headerlink" title="同时实现目标 4"></a>同时实现目标 4</h3><p>pom 文件配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources/$&#123;profiles.active&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 把不想要打包进jar包的内容过滤 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>test/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>online/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>proto/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cc.apomelo.test.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptors</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">descriptor</span>&gt;</span>src/main/resources/assembly.xml<span class="tag">&lt;/<span class="name">descriptor</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">descriptor</span>&gt;</span>src/main/resources/assembly-gz.xml<span class="tag">&lt;/<span class="name">descriptor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">descriptors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;name&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>assembly.xml 文件如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>deploy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">formats</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">formats</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">baseDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">baseDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>true<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">useProjectArtifact</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useProjectArtifact</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>proto/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencySets</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>assembly-gz.xml 文件如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>deploy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">formats</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>tar.gz<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">formats</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">baseDirectory</span>&gt;</span>/$&#123;name&#125;<span class="tag">&lt;/<span class="name">baseDirectory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fileSets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fileSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources/bin<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>bin<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileMode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">fileMode</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">fileSet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fileSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources/$&#123;profiles.active&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>conf<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileMode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">fileMode</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">fileSet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fileSets</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">files</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">source</span>&gt;</span>target/$&#123;name&#125;-deploy.jar<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">destName</span>&gt;</span>$&#123;name&#125;.jar<span class="tag">&lt;/<span class="name">destName</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileMode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">fileMode</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">files</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="打入本地包"><a href="#打入本地包" class="headerlink" title="打入本地包"></a>打入本地包</h3><p>可能遇到的问题: Maven 项目中引用了本地的 jar 包, 打包发现打包不进去（已经可以编译通过）</p>
<p>解决方案: pom 文件中加入本地包依赖</p>
<p>pom 文件中增加:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.apomelo.test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>   <span class="comment">&lt;!-- 随便写, 但是尽量有规律 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>test-proto<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>   <span class="comment">&lt;!-- 随便写, 但是尽量有规律 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>   <span class="comment">&lt;!-- 随便写, 但是尽量有规律 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>   <span class="comment">&lt;!-- 一定是system --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;basedir&#125;/lib/battle.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span>   <span class="comment">&lt;!-- 包所在目录 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>assembly.xml 文件增加 scope 为 system 的依赖包:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>deploy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">formats</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">formats</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">baseDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">baseDirectory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 增加scope为system的依赖包 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>true<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">useProjectArtifact</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useProjectArtifact</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>proto/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>true<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">useProjectArtifact</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useProjectArtifact</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>proto/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">unpackOptions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencySets</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="maven-编译"><a href="#maven-编译" class="headerlink" title="maven 编译"></a>maven 编译</h2><h3 id="引用本地包后编译报错"><a href="#引用本地包后编译报错" class="headerlink" title="引用本地包后编译报错"></a>引用本地包后编译报错</h3><p>问题: Maven 项目中引用了本地的 jar 包, 编译时报错: compile (default-compile) on project xxx: Compilation failure: Compilation failure: 程序包*.*.*不存在</p>
<p>插件: maven-compiler-plugin</p>
<p>解决方案:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/old/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入外部包所在的目录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">extdirs</span>&gt;</span>lib<span class="tag">&lt;/<span class="name">extdirs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 3.1版本之后用下面</span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/old/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入外部包所在的目录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-extdirs<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>lib<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>参考资料:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-assembly-plugin/assembly.html">http://maven.apache.org/plugins/maven-assembly-plugin/assembly.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zqs305082800/article/details/80695675">https://blog.csdn.net/zqs305082800/article/details/80695675</a></li>
<li><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-compiler-plugin/compile-mojo.html">http://maven.apache.org/plugins/maven-compiler-plugin/compile-mojo.html</a></li>
<li><a target="_blank" rel="noopener" href="http://www.doc88.com/p-5174925783108.html">http://www.doc88.com/p-5174925783108.html</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2021/03/15/java-spring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2021/03/15/java-spring/" class="post-title-link" itemprop="url">Spring</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-15 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-15T00:00:00+08:00">2021-03-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/posts/2021/03/15/java-spring/" class="post-meta-item leancloud_visitors" data-flag-title="Spring" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Spring-简介"><a href="#Spring-简介" class="headerlink" title="Spring 简介"></a>Spring 简介</h2><ul>
<li>简化开发，解耦，集成其它框架。</li>
<li>低侵入式设计，代码污染级别较低。</li>
<li>Spring的DI机制降低了业务对象替换的复杂性，提高了软件之间的解耦。</li>
<li>Spring AOP支持将一些通用的任务进行集中式的管理，例如：安全，事务，日志等，从而使代码能更好的复用。</li>
</ul>
<h2 id="Spring-bean"><a href="#Spring-bean" class="headerlink" title="Spring bean"></a>Spring bean</h2><p>Spring 官方文档对 bean 的解释是：</p>
<p><strong>在 Spring 中，构成应用程序主干并由Spring IoC容器管理的对象称为bean。bean是一个由Spring IoC容器实例化、组装和管理的对象。</strong></p>
<p>可以这么理解，<strong>在spring中，一切东西都是bean</strong>。</p>
<h3 id="bean-的生命周期"><a href="#bean-的生命周期" class="headerlink" title="bean 的生命周期"></a>bean 的生命周期</h3><ol>
<li>读取class文件</li>
<li>实例化对象</li>
<li>属性填充（也是DI，依赖注入）</li>
<li>构造后初始化方法<ul>
<li>实现了 InitializingBean 接口会执行afterPropertiesSet方法</li>
<li>或者执行有注解 <code>@PostConstruct</code> 的方法</li>
</ul>
</li>
<li>AOP 生成代理对象</li>
<li>生成bean对象</li>
</ol>
<h3 id="单例bean"><a href="#单例bean" class="headerlink" title="单例bean"></a>单例bean</h3><p>spring中的单例bean，不等同于java中的单例模式。</p>
<p>spring单例bean，允许同一个类有多个名称不相同的实例。</p>
<h4 id="单例bean查找过程"><a href="#单例bean查找过程" class="headerlink" title="单例bean查找过程"></a>单例bean查找过程</h4><pre class="mermaid">graph TB
    A((开始查找)) --> B(byType, 根据type从spring容器里找到多个bean) 
    B -- 通过一系列筛选 --> C
    C -- true --> D
    C -- false --> A1((忽略掉false的bean))
    D -- 符合 --> AA((找到bean))
    D -- 不符合 --> E
    E -- 有 --> AA
    E -- 没有 --> F查找优先级, Priority值大的优先级高
    F -- 找到优先级高的 --> AA
    F -- 多个优先级相同 --> GbyName, 根据属性名字选出一个
    G -- "找到对应名字 (名字完全相同)" --> AA
    G -- 没有找到 --> A2((报错))</pre>

<h3 id="属性填充"><a href="#属性填充" class="headerlink" title="属性填充"></a>属性填充</h3><h4 id="Autowired-注解"><a href="#Autowired-注解" class="headerlink" title="Autowired 注解"></a>Autowired 注解</h4><ol>
<li>进入 AutowiredAnnotationBeanPostProcessor</li>
<li>寻找被 @Autowired 注解了的方法和属性</li>
<li>方法注入点注入，属性注入点注入</li>
<li>查找对应的bean（方法根据<strong>参数</strong>类型和名字），参考上面的bean查找过程</li>
</ol>
<h4 id="Resource-注解"><a href="#Resource-注解" class="headerlink" title="Resource 注解"></a>Resource 注解</h4><ol>
<li>进入 CommonAnnotationBeanPostProcessor</li>
<li>寻找被 @Resource 注解了的方法和属性</li>
<li>方法注入点注入，属性注入点注入</li>
<li>如果 @Resource 指定了name属性，直接从spring容器中拿对应的bean，<strong>不存在则报错</strong></li>
<li>如果 @Resource 没有指定name属性，但根据<strong>属性名字</strong>或setXXX()中的<strong>XXX（根据的不是参数）</strong>，在spring容器中找到对应的bean，参考上面的bean的name查找过程</li>
</ol>
<h2 id="Spring-IoC-amp-DI"><a href="#Spring-IoC-amp-DI" class="headerlink" title="Spring IoC &amp; DI"></a>Spring IoC &amp; DI</h2><p>IoC（Inversion of Control）的意思是“控制反转”，它是Spring最核心的点，并且贯穿始终。</p>
<p>IoC并不是一门技术，而是一种设计思想。</p>
<p>在Spring框架中实现控制反转的是Spring IoC容器，其具体就是由容器来控制对象的生命周期和业务对象之间的依赖关系，而不是像传统方式(new 对象)中由代码来直接控制。程序中所有的对象都会在Spring IoC容器中登记，告诉容器你是个什么，你需要什么，然后IoC容器会在系统运行到适当的时候，把你要的对象主动给你，同时也把你交给其它需要你的对象。</p>
<p>也就是说控制对象生存周期的不再是引用它的对象，而是由Spring IoC容器来控制所有对象的创建、销毁。对于某个具体的对象而言，以前是它控制其它对象，现在是所有对象都被Spring IoC容器所控制，所以这叫控制反转。</p>
<p>控制反转最直观的表达就是，IoC容器让对象的创建不用去new了，而是由Spring自动生产，使用java的反射机制，根据配置文件在运行时动态的去创建对象以及管理对象，并调用对象的方法。控制反转的本质是控制权由应用代码转到了外部容器(IoC容器)，<strong>控制权的转移即是所谓的反转</strong>。</p>
<p>控制权的转移带来的好处就是降低了业务对象之间的依赖程度，即实现了解耦。即然控制反转中提到了反转，那么肯定有正转，正转和反转有什么区别呢？</p>
<p>正转：如果我们要使用某个对象，就需要自己负责对象的创建。<br>反转：如果要使用某个对象，只需要从Spring 容器中获取需要使用的对象，不关心对象的创建过程，也就是把创建对象的控制权反转给了Spring框架。</p>
<p>DI（Dependency Injection）的意思是”依赖注入”，它是IoC(控制反转)的一个别名。</p>
<p>IoC 和 DI 其实是同一个概念，只是从不同的角度描述 (IoC是一种思想，而DI则是一种具体的技术实现手段) 。</p>
<p>IoC 是目的 (它的目的是创建对象) ，DI是手段 (通过什么手段获取外部对象) 。</p>
<p>具体的DI流程在上面属性填充已经说过，那么如果存在循环依赖呢？</p>
<h3 id="循环依赖"><a href="#循环依赖" class="headerlink" title="循环依赖"></a>循环依赖</h3><p>循环依赖是：A引用B，B引用C，C引用A，实例化A,B,C时存在循环引用。</p>
<p>在Spring中循环依赖发生在创建Bean的过程中，具体发生在doCreateBean方法中调用createBeanInstance和populateBean方法时。</p>
<p>在Spring中解决循环引用的方式是使用三级缓存策略：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>singletonObjects</td>
<td>一级缓存,存放完整的Bean</td>
</tr>
<tr>
<td>earlySingletonObjects</td>
<td>二级缓存,存放提前暴露的Bean,且该Bean是不完整的</td>
</tr>
<tr>
<td>singletonFactories</td>
<td>三级缓存,存放的是Bean工厂,主要生产Bean的</td>
</tr>
</tbody></table>
<ol>
<li>一级缓存解决循环依赖的问题（一级缓存读取肯定完整的Bean）</li>
<li>二级缓存解决防止多线程下会读取到不成熟的Bean（分隔成熟Bean和不成熟的Bean）</li>
<li>三级缓存是解决</li>
</ol>
<p>三级缓存的源码结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Cache of singleton objects: bean name to bean instance. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of singleton factories: bean name to ObjectFactory. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of early singleton objects: bean name to bean instance. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br></pre></td></tr></table></figure>

<p>创建流程：</p>
<p><img src="/imgs/java-spring/spring-%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.png" alt="spring-三级缓存"></p>
<p>举例（A,B相互依赖）：</p>
<ol>
<li>先创建A：第一次创建A；A在1.1中的缓存都找不到，所有缓存都是空。</li>
<li>实例化A：实例化A完成；1.3中把A放入了三级缓存。</li>
<li>初始化A：属性赋值，发现A依赖了B；沿图中红线，查找创建B。</li>
<li>创建B：第一次创建B；B在1.1中的缓存找不到，所有缓存B都是空。</li>
<li>实例化B：实例化B完成；1.3中把B放入三级缓存。</li>
<li>初始化B：属性赋值，发现B依赖了A；沿着图中红线，查找A。</li>
<li>A在三级缓存中已经存在；1.1.3.1 把A放入到二级缓存，并把A从三级缓存中删除，返回A。</li>
<li>初始化B中获取到A之后，把A注入到B的依赖属性中。</li>
<li>初始化B完成：1.2.2，1.2.3 把B放入到一级缓存，并把B从三级缓存中删除，返回B。</li>
<li>初始化A中获取到B，把B注入到A的依赖属性中。</li>
<li>初始化A完成：1.2.2，1.2.3 把B放入到一级缓存，并把A从三级缓存中删除，返回A。</li>
</ol>
<h2 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h2><p>Spring的AOP实现原理其实很简单，就是通过动态代理实现的。</p>
<p>如果为Spring的某个bean配置了切面，那么Spring在创建这个bean的时候，实际上创建的是这个bean的一个代理对象，我们后续对bean中方法的调用，实际上调用的是代理类重写的代理方法。</p>
<p>Spring的AOP使用了两种动态代理，分别是JDK的动态代理，以及CGLib的动态代理，CGLib基于ASM实现。这些可以统一归于java字节码增强技术，详细参考：<a href="/posts/2019/04/18/java-jvm/" title="[java-jvm]">[java-jvm]</a></p>
<ol>
<li>Spring默认使用JDK的动态代理实现AOP，类如果实现了接口，Spring就会使用这种方式实现动态代理。熟悉Java语言的应该会对JDK动态代理有所了解。JDK实现动态代理需要两个组件，首先第一个就是InvocationHandler接口。我们在使用JDK的动态代理时，需要编写一个类，去实现这个接口，然后重写invoke方法，这个方法其实就是我们提供的代理方法。然后JDK动态代理需要使用的第二个组件就是Proxy这个类，我们可以通过这个类的newProxyInstance方法，返回一个代理对象。生成的代理类实现了原来那个类的所有接口，并对接口的方法进行了代理，我们通过代理对象调用这些方法时，底层将通过反射，调用我们实现的invoke方法。</li>
<li>JDK的动态代理存在限制，那就是被代理的类必须是一个实现了接口的类，代理类需要实现相同的接口，代理接口中声明的方法。若需要代理的类没有实现接口，此时JDK的动态代理将没有办法使用，于是Spring会使用CGLib的动态代理来生成代理对象。CGLib直接操作字节码，生成类的子类，重写类的方法完成代理。</li>
</ol>
<h2 id="Spring-事务"><a href="#Spring-事务" class="headerlink" title="Spring 事务"></a>Spring 事务</h2><p>Spring事务就是对数据库事务的一层封装</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tuyang1129/p/12878549.html">浅析Spring中AOP的实现原理——动态代理</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tanghaorong/p/13364634.html">Spring详解（三）—-认识IoC控制反转/DI依赖注入</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/shijianjinghun/article/details/111923736">Spring循环依赖及三级缓存源码解析</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apomelo.cc/posts/2020/06/25/java-%E5%8E%9F%E7%94%9F%E9%98%9F%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apomelo">
      <meta itemprop="description" content="我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apomelo - 追逐">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2020/06/25/java-%E5%8E%9F%E7%94%9F%E9%98%9F%E5%88%97/" class="post-title-link" itemprop="url">java原生队列</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-25 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-25T00:00:00+08:00">2020-06-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/posts/2020/06/25/java-%E5%8E%9F%E7%94%9F%E9%98%9F%E5%88%97/" class="post-meta-item leancloud_visitors" data-flag-title="java原生队列" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="队列简介"><a href="#队列简介" class="headerlink" title="队列简介"></a>队列简介</h2><p>先进先出（FIFO），生产者往队列里发布事件，消费者获得通知消费事件；如果队列中没有事件时，消费者堵塞，直到生产者发布了新事件。</p>
<p>Queue接口与List、Set同一级别，都是继承了Collection接口。LinkedList实现了Deque接口。</p>
<h2 id="Java-内置队列"><a href="#Java-内置队列" class="headerlink" title="Java 内置队列"></a>Java 内置队列</h2><table>
<thead>
<tr>
<th>队列</th>
<th>有界性</th>
<th>锁</th>
<th>阻塞</th>
<th>数据结构</th>
</tr>
</thead>
<tbody><tr>
<td>ArrayBlockingQueue</td>
<td>bounded</td>
<td>加锁</td>
<td>是</td>
<td>arraylist</td>
</tr>
<tr>
<td>LinkedBlockingQueue</td>
<td>optionally-bounded</td>
<td>加锁</td>
<td>是</td>
<td>linkedlist</td>
</tr>
<tr>
<td>ConcurrentLinkedQueue</td>
<td>unbounded</td>
<td>CAS</td>
<td>否</td>
<td>linkedlist</td>
</tr>
<tr>
<td>LinkedTransferQueue</td>
<td>unbounded</td>
<td>CAS</td>
<td>是</td>
<td>linkedlist</td>
</tr>
<tr>
<td>PriorityBlockingQueue</td>
<td>unbounded</td>
<td>加锁</td>
<td>是</td>
<td>heap</td>
</tr>
<tr>
<td>DelayQueue</td>
<td>unbounded</td>
<td>加锁</td>
<td>是</td>
<td>heap</td>
</tr>
<tr>
<td>SynchronizedQueue</td>
<td>synchronized</td>
<td>CAS</td>
<td>是</td>
<td>linkedlist</td>
</tr>
</tbody></table>
<h2 id="队列加锁性能"><a href="#队列加锁性能" class="headerlink" title="队列加锁性能"></a>队列加锁性能</h2><p>现实编程过程中，加锁通常会严重地影响性能。线程会因为竞争不到锁而被挂起，等锁被释放的时候，线程又会被恢复，这个过程中存在着很大的开销，并且通常会有较长时间的中断，因为当一个线程正在等待锁时，它不能做任何其他事情。如果一个线程在持有锁的情况下被延迟执行，例如发生了缺页错误、调度延迟或者其它类似情况，那么所有需要这个锁的线程都无法执行下去。如果被阻塞线程的优先级较高，而持有锁的线程优先级较低，就会发生优先级反转。</p>
<p>Disruptor论文中讲述了一个实验：</p>
<ul>
<li>这个测试程序调用了一个函数，该函数会对一个64位的计数器循环自增5亿次。</li>
<li>机器环境：2.4G 6核</li>
<li>运算： 64位的计数器累加5亿次</li>
</ul>
<table>
<thead>
<tr>
<th>Method</th>
<th>Time (ms)</th>
</tr>
</thead>
<tbody><tr>
<td>Single thread</td>
<td>300</td>
</tr>
<tr>
<td>Single thread with CAS</td>
<td>5,700</td>
</tr>
<tr>
<td>Single thread with lock</td>
<td>10,000</td>
</tr>
<tr>
<td>Single thread with volatile write</td>
<td>4,700</td>
</tr>
<tr>
<td>Two threads with CAS</td>
<td>30,000</td>
</tr>
<tr>
<td>Two threads with lock</td>
<td>224,000</td>
</tr>
</tbody></table>
<p>CAS操作比单线程无锁慢了1个数量级；有锁且多线程并发的情况下，速度比单线程无锁慢3个数量级。可见无锁速度最快。</p>
<p><strong>单线程</strong>情况下，不加锁的性能 &gt; CAS操作的性能 &gt; 加锁的性能。</p>
<p><strong>多线程</strong>情况下，为了保证线程安全，必须使用CAS或锁，这种情况下，CAS的性能超过锁的性能，前者大约是后者的8倍。</p>
<p>综上可知，加锁的性能是最差的。</p>
<h2 id="ArrayBlockingQueue"><a href="#ArrayBlockingQueue" class="headerlink" title="ArrayBlockingQueue"></a>ArrayBlockingQueue</h2><p>ArrayBlockingQueue 是 BlockingQueue 接口的有界队列实现类，底层采用数组来实现。</p>
<p>ArrayBlockingQueue 必须指定长度，且一旦创建，容量不能改变。</p>
<p>ArrayBlockingQueue 采用ReentrantLock来控制并发，不管是插入操作还是读取操作，都需要获取到锁才能进行操作。当队列容量满时，尝试将元素放入队列将导致操作阻塞；尝试从一个空队列中取一个元素也会同样阻塞。</p>
<p>ArrayBlockingQueue 默认是非公平队列。</p>
<p>ArrayBlockingQueue 用Object[]存储对象。</p>
<ol>
<li>线程安全是指：ArrayBlockingQueue内部通过“互斥锁”保护竞争资源，实现了多线程对竞争资源的互斥访问。</li>
<li>有界是指：ArrayBlockingQueue对应的数组是有界限的。</li>
<li>阻塞：是指多线程访问竞争资源时，当竞争资源已被某线程获取时，其它要获取该资源的线程需要阻塞等待。</li>
<li>所谓公平的访问队列是指阻塞的线程，可以按照阻塞的先后顺序访问队列，先阻塞的线程先访问ArrayBlockingQueue队列。非公平性是对先等待的线程是非公平的，当队列可用时，阻塞的线程都可以争夺访问队列的资格，有可能先阻塞的线程最后才能够访问队列。然而为了保证公平性，通常会降低吞吐量。</li>
</ol>
<h2 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a>LinkedBlockingQueue</h2><p>LinkedBlockingQueue是一个基于链表实现的阻塞队列，默认情况下，该阻塞队列的大小为Integer.MAX_VALUE，由于这个数值特别大，因此在很多地方称LinkedBlockingQueue是一个无界队列。在LinkedBlockingQueue进行初始化时，可以手动指定队列的大小，这样LinkedBlockingQueue就是一个有界队列了。所以说LinkedBlockingQueue是一个可选择的有界队列。</p>
<p>LinkedBlockingQueue 采用ReentrantLock来控制并发。但是和ArrayBlockingQueue不同的是，LinkedBlockingQueue对队头和队尾各自使用了一把锁来做并发控制。LinkedBlockingQueue采用的是wait-notify机制实现的，不过没有用Object提供的，用java.util.concurrent.locks.Condition中的await()和signal()配合锁实现。</p>
<p>在put()方法中, 关键点在于搞清楚下面俩点:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity) notFull.signal();</span><br><span class="line"><span class="number">2.</span> <span class="keyword">if</span> (c == <span class="number">0</span>) signalNotEmpty();</span><br></pre></td></tr></table></figure>
<ol>
<li>语句1 是判断在多线程的环境下起到作用, 假设现在有4个线程都在await()处阻塞, take()取出一个数据, 现在唤醒了一个线程, 那么当该线程继续put的时候, 通过该判断, 如果队列非满则将阻塞在await()出的线程继续唤醒, 直到队列满了或者全部唤醒。</li>
<li>语句2 是由于前边是调用的count.getAndIncrement(), 如果c为0, 那么现在队列里就有了一个元素, 唤醒阻塞在出列的await()处的线程, 可以继续出列, 取数据了.</li>
</ol>
<p>LinkedBlockingQueue 用Node存储对象。</p>
<p><strong>总结</strong></p>
<ol>
<li>LinkedBlockingQueue是通过锁分离的方式进行控制，减少了take和put之间的锁竞争。</li>
<li>LinkedBlockingQueue是通过链表的方式实现，所以进行锁分离时不会冲突，因为入队和出队分别作用于队尾和队首。</li>
<li>内部采用了原子操作类（CAS）进行控制链表长度。</li>
<li>入队后，如果之前队列为空时，会通知take方法，队列已有数据可进行take，反之，出队后，队列之前已满，则通知put方法，队列已有空闲位置可进行put操作。</li>
</ol>
<h3 id="tip（wait-notify机制）"><a href="#tip（wait-notify机制）" class="headerlink" title="tip（wait-notify机制）"></a>tip（wait-notify机制）</h3><p>从整体上来看Object的wait和notify/notify是与对象监视器配合完成线程间的等待/通知机制，而Condition与Lock配合完成等待通知机制，前者是java底层级别的，后者是语言级别的，具有更高的可控制性和扩展性。两者除了在使用方式上不同外，在功能特性上还是有很多的不同：</p>
<ol>
<li>Condition能够支持不响应中断，而通过使用Object方式不支持；</li>
<li>Condition能够支持多个等待队列（new 多个Condition对象），而Object方式只能支持一个；</li>
<li>Condition能够支持超时时间的设置，而Object不支持。</li>
</ol>
<p>Condition详细原理参见<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/28387056eeb4">TODO</a></p>
<h2 id="ConcurrentLinkedQueue"><a href="#ConcurrentLinkedQueue" class="headerlink" title="ConcurrentLinkedQueue"></a>ConcurrentLinkedQueue</h2><p>它是一个采用双向链表实现的无界并发非阻塞队列，它属于 LinkedQueue 的安全版本。ConcurrentLinkedQueue 内部采用 CAS 操作保证线程安全，这是非阻塞队列实现的基础，相比 ArrayBlockingQueue、LinkedBlockingQueue 具备较高的性能。</p>
<p>ConcurrentLinkedQueue使用约定：</p>
<ol>
<li>不允许null入列</li>
<li>在入队的最后一个元素的next为null</li>
<li>队列中所有未删除的节点的item都不能为null且都能从head节点遍历到</li>
<li>删除节点是将item设置为null, 队列迭代时跳过item为null节点</li>
<li>head节点跟tail不一定指向头节点或尾节点，可能存在滞后性</li>
</ol>
<p><strong>注意</strong></p>
<p>ConcurrentLinkedQueue 中的tail节点不一定是最后一个节点，他可能是倒数第二个。所以ConcurrentLinkedQueue判断队尾条件是节点的next为null。</p>
<h3 id="HOPS-延迟更新的策略-的设计"><a href="#HOPS-延迟更新的策略-的设计" class="headerlink" title="HOPS(延迟更新的策略)的设计"></a>HOPS(延迟更新的策略)的设计</h3><p>tail和head是延迟更新的，两者更新触发时机为： </p>
<ul>
<li>tail更新触发时机：当tail指向的节点的下一个节点不为null的时候，会执行定位队列真正的队尾节点的操作，找到队尾节点后完成插入之后才会通过casTail进行tail更新；当tail指向的节点的下一个节点为null的时候，只插入节点不更新tail。 </li>
<li>head更新触发时机：当head指向的节点的item域为null的时候，会执行定位队列真正的队头节点的操作，找到队头节点后完成删除之后才会通过updateHead进行head更新；当head指向的节点的item域不为null的时候，只删除节点不更新head。</li>
</ul>
<h2 id="LinkedTransferQueue"><a href="#LinkedTransferQueue" class="headerlink" title="LinkedTransferQueue"></a>LinkedTransferQueue</h2><p>LinkedTransferQueue是在JDK1.7时，J.U.C包新增的一种比较特殊的阻塞队列，它除了具备阻塞队列的常用功能外，还有一个比较特殊的transfer方法。</p>
<p>LinkedTransferQueue提供了两种构造器，也没有参数设置队列初始容量，所以是一种无界队列</p>
<p><strong>注意</strong></p>
<p>LinkedTransferQueue的单向链表中一定会有至少一个Node节点，既是LinkedTransferQueue队列集合通过默认的构造函数进行实例化时构建的“虚”节点，该节点的isData属性被标识为true，并且和该节点item属性实际引用数据对象的情况冲突（item属性为null），这样一来无论xfer操作进行的是入队操作还是出队操作，这个虚拟节点都会被排除在操作逻辑以外。并且因为q = p.next和p = q两个操作语句的缘故，代表当前正在处理的p引用会向单向链表的后续结点移动。</p>
<h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><h4 id="transfer-方法"><a href="#transfer-方法" class="headerlink" title="transfer 方法"></a>transfer 方法</h4><p>用于将指定元素e传递给消费者线程(调用take/poll方法)。如果有消费者线程正在阻塞等待，则调用transfer方法的线程会直接将元素传递给它；如果没有消费者线程等待获取元素，则调用transfer方法的线程会将元素插入到队尾，然后阻塞等待，直到出现一个消费者线程获取元素。</p>
<p>在普通阻塞队列中，当队列为空时，消费者线程（调用take或poll方法的线程）一般会阻塞等待生产者线程往队列中存入元素。而LinkedTransferQueue的transfer方法则比较特殊：</p>
<ol>
<li>当有消费者线程阻塞等待时，调用transfer方法的生产者线程不会将元素存入队列，而是直接将元素传递给消费者。</li>
<li>如果调用transfer方法的生产者线程发现没有正在等待的消费者线程，则会将元素入队，然后会阻塞等待，直到有一个消费者线程来获取该元素。</li>
</ol>
<p>TransferQueue还提供了两个变种方法：tryTransfer(E e)、tryTransfer(E e, long timeout, TimeUnit unit)。</p>
<h4 id="tryTransfer-E-e"><a href="#tryTransfer-E-e" class="headerlink" title="tryTransfer(E e)"></a>tryTransfer(E e)</h4><p>当生产者线程调用tryTransfer方法时，如果没有消费者等待接收元素，则会立即返回false。该方法和transfer方法的区别就是tryTransfer方法无论消费者是否接收，方法立即返回，而transfer方法必须等到消费者消费后才返回。</p>
<h4 id="tryTransfer-E-e-long-timeout-TimeUnit-unit"><a href="#tryTransfer-E-e-long-timeout-TimeUnit-unit" class="headerlink" title="tryTransfer(E e, long timeout, TimeUnit unit)"></a>tryTransfer(E e, long timeout, TimeUnit unit)</h4><p>tryTransfer（E e，long timeout，TimeUnit unit）方法则是加上了限时等待功能，如果没有消费者消费该元素，则等待指定的时间再返回；如果超时还没消费元素，则返回false，如果在超时时间内消费了元素，则返回true。</p>
<h4 id="xfer方法"><a href="#xfer方法" class="headerlink" title="xfer方法"></a>xfer方法</h4><p>xfer方法从字面上可以直译为“传送”，它是指通过多种操作模式，利用LinkedTransferQueue队列内置的单向链表，使数据对象在生产者和消费者间进行传递。JDK 9+开始，xfer操作的逻辑做了一次较大的改造，处理逻辑变得更加高效。</p>
<p>xfer方法是LinkedTransferQueue队列最核心的操作方法之一，其支撑了诸如offer、add、put、transfer、tryTransfer、take、poll等方法的内部实现。</p>
<h5 id="xfer方法参数"><a href="#xfer方法参数" class="headerlink" title="xfer方法参数"></a>xfer方法参数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">xfer</span><span class="params">(E e, <span class="keyword">boolean</span> haveData, <span class="keyword">int</span> how, <span class="keyword">long</span> nanos)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>e：该参数就是本次进行传输的数据对象，如果当前xfer方法被消费者线程端调用，则e为null。</li>
<li>haveData：该参数指示本次xfer方法的调用是否有数据对象通过上一个e参数进行传入，也就是说e和haveData这两个参数是配对使用的。当e为null时，haveData应该为false；反之当e不为nul时，haveData应该为true。</li>
<li>how：本次xfer方法的操作模式。一共有四种: NOW, ASYNC, SYNC, TIMED。</li>
<li>nanos：本次xfer方法的操作超时时间（单位纳秒），当本次操作的操作模式为TIMED时（限时/超时模式），需要通过该参数指定本次操作的超时时间。</li>
</ol>
<h5 id="xfer工作模式"><a href="#xfer工作模式" class="headerlink" title="xfer工作模式"></a>xfer工作模式</h5><p>xfer的调用方式主要分为四种工作模式，在xfer方法的入参中表现为四个不同的数值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * xfer方法的入参, 不同类型的方法内部调用xfer方法时入参不同.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NOW = <span class="number">0</span>;   <span class="comment">// for untimed poll, tryTransfer</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ASYNC = <span class="number">1</span>; <span class="comment">// for offer, put, add</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SYNC = <span class="number">2</span>; <span class="comment">// for transfer, take</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIMED = <span class="number">3</span>; <span class="comment">// for timed poll, tryTransfer</span></span><br></pre></td></tr></table></figure>

<p>这四个常量值，作为xfer方法的入参，用于标识不同操作类型。其实从常量的命名也可以看出它们对应的操作含义：</p>
<h6 id="NOW"><a href="#NOW" class="headerlink" title="NOW"></a>NOW</h6><p>表示即时操作（可能失败），即不会阻塞调用线程：</p>
<ul>
<li>poll（获取并移除队首元素，如果队列为空，直接返回null）；</li>
<li>tryTransfer（尝试将元素传递给消费者，如果没有等待的消费者，则立即返回false，也不会将元素入队）</li>
</ul>
<h6 id="ASYNC"><a href="#ASYNC" class="headerlink" title="ASYNC"></a>ASYNC</h6><p>表示异步操作（必然成功）：</p>
<ul>
<li>offer（插入指定元素至队尾，由于是无界队列，所以会立即返回true）；</li>
<li>put（插入指定元素至队尾，由于是无界队列，所以会立即返回）；add（插入指定元素至队尾，由于是无界队列，所以会立即返回true）</li>
</ul>
<h6 id="SYNC"><a href="#SYNC" class="headerlink" title="SYNC"></a>SYNC</h6><p>表示同步操作（阻塞调用线程）：</p>
<ul>
<li>transfer（阻塞直到出现一个消费者线程）；</li>
<li>take（从队首移除一个元素，如果队列为空，则阻塞线程）</li>
</ul>
<h6 id="TIMED"><a href="#TIMED" class="headerlink" title="TIMED"></a>TIMED</h6><p>表示限时同步操作（限时阻塞调用线程）：</p>
<ul>
<li>poll(long timeout, TimeUnit unit)；</li>
<li>tryTransfer(E e, long timeout, TimeUnit unit)</li>
</ul>
<h5 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">xfer</span><span class="params">(E e, <span class="keyword">boolean</span> haveData, <span class="keyword">int</span> how, <span class="keyword">long</span> nanos)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (haveData &amp;&amp; (e == <span class="keyword">null</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 最外层的for循环，遵循cas操作思想，只要操作不符合预期，就不停的重新操作</span></span><br><span class="line">  <span class="comment">// 直到操作结果符合预期为止</span></span><br><span class="line">  restart: <span class="keyword">for</span> (Node s = <span class="keyword">null</span>, t = <span class="keyword">null</span>, h = <span class="keyword">null</span>;;) &#123;</span><br><span class="line">    <span class="comment">// 这是初始化是决定当前p的位置是依据当前单向链表的head节点进行引用还是依据当前单向链表的tail节点进行引用</span></span><br><span class="line">    <span class="comment">// 其本质判断是当前操作是入队操作还是出队操作</span></span><br><span class="line">    <span class="comment">// 其最本质的判定是当前xfer操作的性质（haveData）和当前链表tail引用位置所描述的操作性质（t.isData）是否一致</span></span><br><span class="line">    <span class="comment">// 如果操作性质一致，当前xfer操作就是从tail引用位置开始判定和进行的入队操作</span></span><br><span class="line">    <span class="comment">// 如果操作性质不一致，当前xfer操作就是从head引用位置开始判定和进行的出队操作</span></span><br><span class="line">    <span class="keyword">for</span> (Node p = (t != (t = tail) &amp;&amp; t.isData == haveData) ? t : (h = head);; ) &#123;</span><br><span class="line">      <span class="keyword">final</span> Node q; <span class="keyword">final</span> Object item;</span><br><span class="line">      <span class="comment">// 出队操作的场景，其处理策略在此代码段落 </span></span><br><span class="line">      <span class="comment">// 只有当前处理节点p的isData标识和入参的haveData标识一致 </span></span><br><span class="line">      <span class="comment">// 且当前处理节点p真实的数据对象存在情况和入参的haveData标识一致 </span></span><br><span class="line">      <span class="keyword">if</span> (p.isData != haveData &amp;&amp; haveData == ((item = p.item) == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="comment">// 将局部变量h引用与当前单向链表的head位置</span></span><br><span class="line">        <span class="comment">// 避免在多线程情况下head引用被改变引起的处理错误</span></span><br><span class="line">        <span class="keyword">if</span> (h == <span class="keyword">null</span>) &#123;</span><br><span class="line">          h = head;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对当前节点进行原子性赋值：</span></span><br><span class="line">        <span class="comment">// 如果是生产者任务从队列中取出，那么赋值成功后，当前节点p的item属性将为e（不会为null）</span></span><br><span class="line">        <span class="comment">// 如果是消费者任务从队列中取出，那么赋值成功后，当前节点p的item属性将为null</span></span><br><span class="line">        <span class="keyword">if</span> (p.tryMatch(item, e)) &#123;</span><br><span class="line">          <span class="comment">// 在双跳队列进行数据取数操作时，当前处理节点p可能和h不一致，但一定是在h代表的节点“附近”</span></span><br><span class="line">          <span class="comment">// 所以，如果条件成立，就要进行以h代表的节点为基准的链表清理操作</span></span><br><span class="line">          <span class="keyword">if</span> (h != p) &#123;</span><br><span class="line">            skipDeadNodesNearHead(h, p);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> (E) item;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 入队操作的场景，其处理策略在此代码段落</span></span><br><span class="line">      <span class="comment">// 加入队列的可能是消费者任务，也可能是生产者任务</span></span><br><span class="line">      <span class="comment">// 根据之前对单向链表tail引用位置的描述，tail引用的位置不一定是单向链表的最后一个节点</span></span><br><span class="line">      <span class="comment">// 所以首先将p节点移动到链表的最后一个节点，否则就不进行业务逻辑处理</span></span><br><span class="line">      <span class="keyword">if</span> ((q = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 操作方式为NOW的入队操作，将会被忽略</span></span><br><span class="line">        <span class="keyword">if</span> (how == NOW) &#123;</span><br><span class="line">          <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 入队操作需要生成一个新的Node节点</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">          s = <span class="keyword">new</span> Node(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用原子操作，将当前操作s结点引用到当前p结点的item属性</span></span><br><span class="line">        <span class="comment">// 如果操作失败，说明p结点的next操作已经被其它线程中的操作所引用，</span></span><br><span class="line">        <span class="comment">// 那么通过内层的for循环继续进行操作</span></span><br><span class="line">        <span class="keyword">if</span> (!p.casNext(<span class="keyword">null</span>, s)) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 当前p节点引用的位置和t节点引用的可能是单向链表tail处的位置可能不一样</span></span><br><span class="line">        <span class="comment">// 引起这个的原因可能有很多：</span></span><br><span class="line">        <span class="comment">// a、当前xfer操作在中为p节点关联next属性的操作：p.casNext(null, s)不停失败，</span></span><br><span class="line">        <span class="comment">// 不停的在第二层for循环中做q = p.next 和 p == (p = q) 操作</span></span><br><span class="line">        <span class="comment">// b、虽然xfer操作成功了，但是当前线程连续进行了两次xfer调用操作（不好理解？后文将进行图例化讲解）</span></span><br><span class="line">        <span class="keyword">if</span> (p != t) &#123;</span><br><span class="line">          casTail(t, s);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (how == ASYNC) &#123;</span><br><span class="line">          <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> awaitMatch(s, p, e, (how == TIMED), nanos);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 让p引用指向当前节点的下一个节点</span></span><br><span class="line">      <span class="comment">// 如果当前节点的next属性指向自己，说明当前节点已经被移除队列</span></span><br><span class="line">      <span class="comment">// 按照cas的思路，本次xfer操作需要重来</span></span><br><span class="line">      <span class="keyword">if</span> (p == (p = q)) &#123;</span><br><span class="line">        <span class="keyword">continue</span> restart;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="comment">/** Tries to CAS-match this node; if successful, wakes waiter. */</span></span><br><span class="line"><span class="comment">// 这是LinkedTransferQueue.Node类中的方法</span></span><br><span class="line"><span class="comment">// 方法尝试如果当前Node对象的item属性值为cmp的情况下，重新赋值为val</span></span><br><span class="line"><span class="comment">// 如果设置成功，则解除当前Node所代表的等待线程的阻塞状态</span></span><br><span class="line"><span class="comment">// 这个阻塞状态的线程可能是生产者，也可能是生产者。</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryMatch</span><span class="params">(Object cmp, Object val)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (casItem(cmp, val)) &#123;</span><br><span class="line">    LockSupport.unpark(waiter);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是LinkedTransferQueue.Node类中的方法</span></span><br><span class="line"><span class="comment">// 该方法尝试如果当前Node对象的item属性值为cmp的情况下，重新赋值为val，并返回true</span></span><br><span class="line"><span class="comment">// 否则就返回false</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">casItem</span><span class="params">(Object cmp, Object val)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// assert isData == (cmp != null);</span></span><br><span class="line">  <span class="comment">// assert isData == (val == null);</span></span><br><span class="line">  <span class="comment">// assert !(cmp instanceof Node);</span></span><br><span class="line">  <span class="keyword">return</span> ITEM.compareAndSet(<span class="keyword">this</span>, cmp, val);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ......</span></span><br></pre></td></tr></table></figure>

<h2 id="PriorityBlockingQueue"><a href="#PriorityBlockingQueue" class="headerlink" title="PriorityBlockingQueue"></a>PriorityBlockingQueue</h2><p>PriorityBlockingQueue是一个基于堆的无界并发安全的优先级队列，每次出队都返回优先级最高的元素，数据结构是一个二叉树最小堆算法维护的数组，这个数组是可扩容的，直接遍历队列元素是无序的。</p>
<p>PriorityBlockingQueue可以理解为public操作都加锁的PriorityQueue，通过排他锁保证了操作的线程安全。PriorityBlockingQueue扩容时，因为增加堆数组的长度并不影响队列中元素的出队操作，因而使用自旋CAS操作实现的锁来控制扩容操作，仅在数组引用替换和拷贝元素时才加锁，从而减少了扩容对出队操作的影响。</p>
<p>PriorityBlockingQueue不允许null值，不允许未实现Comparable接口的对象。</p>
<p><strong>PriorityQueue特点</strong></p>
<ol>
<li>PriorityQueue是基于优先堆的一个无界队列，这个优先队列中的元素可以默认自然排序或者通过提供的Comparator（比较器）在队列实例化的时排序。</li>
<li>PriorityQueue不允许 null 值，而且不支持 non-comparable（不可比较）的对象，比如用户自定义的类。优先队列要求使用Java Comparable和Comparator接口给对象排序，并且在排序时会按照优先级处理其中的元素。</li>
<li>PriorityQueue的头是基于自然排序或者Comparator排序的最小元素。如果有多个对象拥有同样的排序，那么就可能随机地取其中任意一个。当我们获取队列时，返回队列的头对象。</li>
<li>PriorityQueue的大小是不受限制的，所以<strong>put永远不会被阻塞</strong>。但在创建时可以指定初始大小，当我们向优先队列增加元素的时候，队列大小会<strong>自动增加</strong>。</li>
<li>PriorityQueue是非线程安全的，所以Java提供了PriorityBlockingQueue（实现BlockingQueue接口）用于Java多线程环境。</li>
</ol>
<h2 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h2><p>DelayQueue是一个无界的BlockingQueue，用于放置实现了Delayed接口的对象，其中的对象只能在其到期时才能从队列中取走。这种队列是有序的，即队头对象的延迟到期时间<strong>最短</strong>。</p>
<p>DelayQueue不允许null值。</p>
<h3 id="内部结构"><a href="#内部结构" class="headerlink" title="内部结构"></a>内部结构</h3><ul>
<li>可重入锁</li>
<li>用于根据delay时间排序的优先级队列</li>
<li>用于优化阻塞通知的线程元素leader</li>
<li>用于实现阻塞和通知的Condition对象</li>
</ul>
<h2 id="SynchronizedQueue"><a href="#SynchronizedQueue" class="headerlink" title="SynchronizedQueue"></a>SynchronizedQueue</h2><p>经典的生产者-消费者模式，操作流程是这样的：</p>
<ul>
<li>有多个生产者，可以并发生产产品，把产品置入队列中，如果队列满了，生产者就会阻塞；</li>
<li>有多个消费者，并发从队列中获取产品，如果队列空了，消费者就会阻塞；</li>
</ul>
<p>SynchronousQueue 也是一个队列来的，但它的特别之处在于它内部没有容器，一个生产线程，当它生产产品（即put的时候），如果当前没有人想要消费产品(即当前没有线程执行take)，此生产线程必须阻塞，等待一个消费线程调用take操作，take操作将会唤醒该生产线程，同时消费线程会获取生产线程的产品（即数据传递）</p>
<ol>
<li>SynchronousQueue没有容量。与其他BlockingQueue不同，SynchronousQueue是一个不存储元素的BlockingQueue。每一个put操作必须要等待一个take操作，否则不能继续添加元素，反之亦然。</li>
<li>因为没有容量，所以对应 peek, contains, clear, isEmpty … 等方法其实是无效的。例如clear是不执行任何操作的，contains始终返回false,peek始终返回null。</li>
<li>SynchronousQueue分为公平和非公平，默认情况下采用非公平性访问策略，当然也可以通过构造函数来设置为公平性访问策略（为true即可）。</li>
<li>SynchronousQueue底层有两种数据结构：队列（TransferQueue，实现公平策略）和栈（TransferStack，实现非公平策略）</li>
<li>若使用 TransferQueue, 则队列中永远会存在一个 dummy node。</li>
</ol>
<p>参考资料:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2016/11/18/disruptor.html">https://tech.meituan.com/2016/11/18/disruptor.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/28387056eeb4">https://www.jianshu.com/p/28387056eeb4</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6970336648710062093">https://juejin.cn/post/6970336648710062093</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/af6f83c78506">https://www.jianshu.com/p/af6f83c78506</a></li>
<li><a target="_blank" rel="noopener" href="https://pdai.tech/md/java/thread/java-thread-x-juc-collection-ConcurrentLinkedQueue.html">https://pdai.tech/md/java/thread/java-thread-x-juc-collection-ConcurrentLinkedQueue.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/yinwenjie/article/details/106796799">https://blog.csdn.net/yinwenjie/article/details/106796799</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/myseries/p/10944211.html">https://www.cnblogs.com/myseries/p/10944211.html</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Apomelo</p>
  <div class="site-description" itemprop="description">我有一壶酒，足以慰风尘。<br/>尽倾江海里，赠饮天下人。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/apomelo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;apomelo" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:apomeloc@gmail.com" title="E-Mail → mailto:apomeloc@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Apomelo</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>


  <div style="display: none;">
    <script src="https://s5.cnzz.com/z_stat.php?id=1277140459&web_id=1277140459"></script>
  </div>




<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"N5VN0ybf5xGuqDFhjzC5RlRL-MdYXbMMI","app_key":"ru1RlOeEotFp87wLFIHucgVu","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        // if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>












<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : '[object Object]',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
